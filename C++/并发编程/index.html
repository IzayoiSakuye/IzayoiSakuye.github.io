<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"izayoisakuye.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.23.2","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="并发编程 多个任务的执行方式  顺序：一个接着一个 并行：同一时间执行多个任务（并行是并发的子集） 并发：多个任务在同一个重叠时间段执行  OpenMP 使用#prgma预处理指令可以将代码转变为并行处理 此时需要在编译时添加参数-fopenmp e.g. 计算 123456789101112131415#include&lt;iostream&gt; using names">
<meta property="og:type" content="article">
<meta property="og:title" content="【C++】并发编程">
<meta property="og:url" content="https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/index.html">
<meta property="og:site_name" content="红魔咖啡馆">
<meta property="og:description" content="并发编程 多个任务的执行方式  顺序：一个接着一个 并行：同一时间执行多个任务（并行是并发的子集） 并发：多个任务在同一个重叠时间段执行  OpenMP 使用#prgma预处理指令可以将代码转变为并行处理 此时需要在编译时添加参数-fopenmp e.g. 计算 123456789101112131415#include&lt;iostream&gt; using names">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/image-20250725112934180.png">
<meta property="og:image" content="https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/image-20250725113007523.png">
<meta property="og:image" content="https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/image-20250727151242766.png">
<meta property="og:image" content="https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/image-20250728133257958.png">
<meta property="og:image" content="https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/image-20250731104420865.png">
<meta property="og:image" content="https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/image-20250731135640991.png">
<meta property="og:image" content="https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/image-20250731135804450.png">
<meta property="og:image" content="https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/image-20250731140345785.png">
<meta property="og:image" content="https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/image-20250731161214818.png">
<meta property="article:published_time" content="2025-07-31T09:31:56.574Z">
<meta property="article:modified_time" content="2025-07-31T09:32:26.959Z">
<meta property="article:author" content="IzayoiSakuye">
<meta property="article:tag" content="C&#x2F;C++">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/image-20250725112934180.png">


<link rel="canonical" href="https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/","path":"C++/并发编程/","title":"【C++】并发编程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>【C++】并发编程 | 红魔咖啡馆</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#90a4ae;--hl-bg:#f6f8fa;--hltools-bg:#e6ebf1;--hltools-color:#90a4ae;--hlnumber-bg:#f6f8fa;--hlnumber-color:rgba(144,164,174,0.5);--hlscrollbar-bg:#dce4eb;--hlexpand-bg:linear-gradient(180deg,rgba(246,248,250,0.1),rgba(246,248,250,0.9))}</style><!-- hexo injector head_end end --><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">红魔咖啡馆</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">头发越掉越多，头发越掉越少</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">22</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">6</span></a></li><li class="menu-item menu-item-passages"><a href="/list/" rel="section"><i class="fa-regular fa-file fa-fw"></i>文章</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">并发编程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E4%B8%AA%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C%E6%96%B9%E5%BC%8F"><span class="nav-number">1.1.</span> <span class="nav-text">多个任务的执行方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#openmp"><span class="nav-number">1.2.</span> <span class="nav-text">OpenMP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#stl%E5%B9%B6%E8%A1%8C%E7%AE%97%E6%B3%95%E5%BA%93"><span class="nav-number">1.3.</span> <span class="nav-text">STL并行算法库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B"><span class="nav-number">1.4.</span> <span class="nav-text">线程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E4%B8%8E%E8%BF%9B%E7%A8%8B"><span class="nav-number">1.4.1.</span> <span class="nav-text">线程与进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B"><span class="nav-number">1.4.2.</span> <span class="nav-text">创建线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#join"><span class="nav-number">1.4.3.</span> <span class="nav-text">.join()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fork-and-join"><span class="nav-number">1.4.4.</span> <span class="nav-text">Fork and join</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#divide-and-conquer"><span class="nav-number">1.4.5.</span> <span class="nav-text">Divide and conquer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#promise-future"><span class="nav-number">1.5.</span> <span class="nav-text">promise &amp; future</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#promise"><span class="nav-number">1.5.1.</span> <span class="nav-text">promise</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#future"><span class="nav-number">1.5.2.</span> <span class="nav-text">future</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%92%E6%96%A5%E5%92%8C%E9%94%81"><span class="nav-number">1.6.</span> <span class="nav-text">互斥和锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%92%E6%96%A5%E9%87%8F"><span class="nav-number">1.6.1.</span> <span class="nav-text">互斥量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%BB%E9%94%81"><span class="nav-number">1.6.2.</span> <span class="nav-text">死锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%AD"><span class="nav-number">1.6.3.</span> <span class="nav-text">多线程中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B4%BB%E9%94%81"><span class="nav-number">1.6.4.</span> <span class="nav-text">活锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lock%E5%87%BD%E6%95%B0"><span class="nav-number">1.6.5.</span> <span class="nav-text">lock函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#scope_lock%E7%B1%BB"><span class="nav-number">1.6.6.</span> <span class="nav-text">scope_lock类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E9%94%81"><span class="nav-number">1.6.7.</span> <span class="nav-text">读写锁</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="nav-number">1.7.</span> <span class="nav-text">条件变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81"><span class="nav-number">1.7.1.</span> <span class="nav-text">工作流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">1.7.2.</span> <span class="nav-text">使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%8B"><span class="nav-number">1.7.3.</span> <span class="nav-text">例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A2%E5%A4%B1%E5%94%A4%E9%86%92%E4%B8%8E%E8%99%9A%E5%81%87%E5%94%A4%E9%86%92"><span class="nav-number">1.7.4.</span> <span class="nav-text">丢失唤醒与虚假唤醒</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="nav-number">1.8.</span> <span class="nav-text">信号量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1"><span class="nav-number">1.9.</span> <span class="nav-text">异步任务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#async"><span class="nav-number">1.9.1.</span> <span class="nav-text">async</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#packaged_task"><span class="nav-number">1.9.2.</span> <span class="nav-text">packaged_task</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%B1%8F%E9%9A%9C"><span class="nav-number">1.10.</span> <span class="nav-text">线程屏障</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#latch"><span class="nav-number">1.10.1.</span> <span class="nav-text">latch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#barrier"><span class="nav-number">1.10.2.</span> <span class="nav-text">barrier</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="nav-number">1.11.</span> <span class="nav-text">原子操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.11.1.</span> <span class="nav-text">类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#atomic_flag"><span class="nav-number">1.11.2.</span> <span class="nav-text">atomic_flag</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E6%97%8B%E9%94%81"><span class="nav-number">1.11.3.</span> <span class="nav-text">自旋锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%8B-1"><span class="nav-number">1.11.4.</span> <span class="nav-text">例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E5%8C%96%E7%89%88%E6%9C%AC"><span class="nav-number">1.11.5.</span> <span class="nav-text">特化版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E6%97%A0%E9%94%81%E7%9A%84%E5%88%A4%E6%96%AD"><span class="nav-number">1.11.6.</span> <span class="nav-text">有无锁的判断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E7%9A%84%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="nav-number">1.11.7.</span> <span class="nav-text">主要的原子操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%8B%E4%BD%BF%E7%94%A8atomic%E5%92%8Ccas%E5%AE%9E%E7%8E%B0%E6%97%A0%E9%94%81%E5%A0%86%E6%A0%88"><span class="nav-number">1.11.8.</span> <span class="nav-text">例：使用atomic和CAS实现无锁堆栈</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.12.</span> <span class="nav-text">内存模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%BA%E5%BA%8F%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.12.1.</span> <span class="nav-text">顺序一致性模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#relaxed%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.12.2.</span> <span class="nav-text">Relaxed模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#acquirerelease%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.12.3.</span> <span class="nav-text">Acquire&#x2F;Release模型</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="IzayoiSakuye"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">IzayoiSakuye</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">109</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="IzayoiSakuye">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="红魔咖啡馆">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="【C++】并发编程 | 红魔咖啡馆">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【C++】并发编程
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-07-31 17:31:56 / 修改时间：17:32:26" itemprop="dateCreated datePublished" datetime="2025-07-31T17:31:56+08:00">2025-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C-C/" itemprop="url" rel="index"><span itemprop="name">C/C++</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="并发编程">并发编程</h1>
<h2 id="多个任务的执行方式">多个任务的执行方式</h2>
<ul>
<li>顺序：一个接着一个</li>
<li>并行：同一时间执行多个任务（并行是并发的子集）</li>
<li>并发：多个任务在同一个重叠时间段执行</li>
</ul>
<h2 id="openmp">OpenMP</h2>
<p>使用<code>#prgma</code>预处理指令可以将代码转变为并行处理</p>
<p>此时需要在编译时添加参数<code>-fopenmp</code></p>
<p>e.g. 计算<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.29ex" height="1ex" role="img" focusable="false" viewBox="0 -431 570 442"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D70B" d="M132 -11Q98 -11 98 22V33L111 61Q186 219 220 334L228 358H196Q158 358 142 355T103 336Q92 329 81 318T62 297T53 285Q51 284 38 284Q19 284 19 294Q19 300 38 329T93 391T164 429Q171 431 389 431Q549 431 553 430Q573 423 573 402Q573 371 541 360Q535 358 472 358H408L405 341Q393 269 393 222Q393 170 402 129T421 65T431 37Q431 20 417 5T381 -10Q370 -10 363 -7T347 17T331 77Q330 86 330 121Q330 170 339 226T357 318T367 358H269L268 354Q268 351 249 275T206 114T175 17Q164 -11 132 -11Z"></path></g></g></g></svg></mjx-container></span></p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cal</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">long</span><span style="color: #24292E"> </span><span style="color: #E36209">num_steps</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> step </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1.0</span><span style="color: #D73A49">/</span><span style="color: #24292E">num_steps;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> sum </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0.0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">#pragma</span><span style="color: #24292E"> </span><span style="color: #6F42C1">omp</span><span style="color: #24292E"> </span><span style="color: #6F42C1">parallel</span><span style="color: #24292E"> </span><span style="color: #6F42C1">for</span><span style="color: #24292E"> </span><span style="color: #6F42C1">reduction</span><span style="color: #24292E">(+:</span><span style="color: #6F42C1">sum</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">long</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">num_steps;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">double</span><span style="color: #24292E"> x </span><span style="color: #D73A49">=</span><span style="color: #24292E"> (i</span><span style="color: #D73A49">+</span><span style="color: #005CC5">0.5</span><span style="color: #24292E">)</span><span style="color: #D73A49">*</span><span style="color: #24292E">step;</span></span>
<span class="line"><span style="color: #24292E">    sum</span><span style="color: #D73A49">+=</span><span style="color: #005CC5">4.0</span><span style="color: #D73A49">/</span><span style="color: #24292E">(</span><span style="color: #005CC5">1.0</span><span style="color: #D73A49">+</span><span style="color: #24292E">x</span><span style="color: #D73A49">*</span><span style="color: #24292E">x);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> sum</span><span style="color: #D73A49">*</span><span style="color: #24292E">step;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cal</span><span style="color: #24292E">(</span><span style="color: #005CC5">10</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>其中第六行语句的意思：</p>
<ul>
<li><p><code>omp parallel for</code>表示将for循环每次循环转化为并行计算</p></li>
<li><p><code>reduction</code>表示用于reduce计算的变量与运算符</p></li>
<li><p>局部变量x在每个线程中修改，不影响其他线程</p></li>
<li><p>sum是共享对象，不能在并行线程中直接修改，否则导致数据竞争</p>
<p>sum需要reduce操作，其中reduction表明了需要reduce操作的变量与运算符</p></li>
</ul>
<h2 id="stl并行算法库">STL并行算法库</h2>
<p>使用<code>&lt;algorithm&gt;</code>与<code>&lt;numeric&gt;</code>库中的函数，可以简单实现并行</p>
<p>在支持并行的算法函数中，首个参数可以选择执行策略：</p>
<ul>
<li><code>std::execution::sequenced_policy</code>：顺序执行策略（实例：seq）</li>
<li><code>std::execution::parallel_policy</code>：并行执行策略（实例：par）</li>
<li><code>std::execution::parallel_unsequenced_policy</code>：多线程加向量化策略（实例：par_seq）</li>
</ul>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;algorithm&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;execution&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;vector&gt;</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> op </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [](</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">v</span><span style="color: #24292E">){</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> v </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">";</span><span style="color: #005CC5">\n</span><span style="color: #032F62">"</span><span style="color: #24292E">;};</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;int&gt;</span><span style="color: #24292E"> numbers{</span><span style="color: #005CC5">1</span><span style="color: #24292E">,</span><span style="color: #005CC5">2</span><span style="color: #24292E">,</span><span style="color: #005CC5">3</span><span style="color: #24292E">,</span><span style="color: #005CC5">4</span><span style="color: #24292E">,</span><span style="color: #005CC5">5</span><span style="color: #24292E">,</span><span style="color: #005CC5">6</span><span style="color: #24292E">,</span><span style="color: #005CC5">7</span><span style="color: #24292E">,</span><span style="color: #005CC5">8</span><span style="color: #24292E">,</span><span style="color: #005CC5">9</span><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"sequential for_each"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">for_each</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">execution</span><span style="color: #24292E">::seq, numbers.</span><span style="color: #6F42C1">begin</span><span style="color: #24292E">(), numbers.</span><span style="color: #6F42C1">end</span><span style="color: #24292E">(), op);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"parallel for_each"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">for_each</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">execution</span><span style="color: #24292E">::par, numbers.</span><span style="color: #6F42C1">begin</span><span style="color: #24292E">(), numbers.</span><span style="color: #6F42C1">end</span><span style="color: #24292E">(), op);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"parallel unseq for_each"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">for_each</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">execution</span><span style="color: #24292E">::par_unseq, numbers.</span><span style="color: #6F42C1">begin</span><span style="color: #24292E">(), numbers.</span><span style="color: #6F42C1">end</span><span style="color: #24292E">(), op);</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>以上没有对cout进行同步措施，会导致<strong>输出错误</strong></p>
<h2 id="线程">线程</h2>
<h3 id="线程与进程">线程与进程</h3>
<p>进程：程序执行过程，相互独立，操作系统为每一个进程分配一个执行控制块来控制进程</p>
<p>线程：进程中的执行过程，系统为每一个线程分配一个栈于线程控制块，线程间共享堆与全局数据</p>
<h3 id="创建线程">创建线程</h3>
<p>使用<code>&lt;thread&gt;</code>类创建线程</p>
<p><code>thread(F&amp;&amp; f, Args&amp;&amp;... args);</code></p>
<ul>
<li>第一个参数为线程的入口函数（线程函数），可以是各种可调用的对象</li>
<li>后面的Args为传递给可调用对象的实参</li>
<li>若第一个参数为非静态成员函数，则后面的第一个参数为调用这个成员函数的类对象地址</li>
</ul>
<p>thread的返回值会被忽略，故要使用按引用传递的参数，或存储在类对象的数据成员中</p>
<p>用该函数初始化后会创建一个新线程，执行线程函数</p>
<p>线程<strong>只能移动构造或移动赋值</strong>，防止多个线程对象代表一个执行线程</p>
<h3 id="join">.join()</h3>
<p>该函数会使得当前线程执行结束后等待其他线程回会合，避免出现提前结束导致出现错误</p>
<p>这种等待状态称为<strong>阻塞</strong>，若对应线程提前结束，则join函数也会直接返回</p>
<p>调用函数时，该线程必须是joinable的，意味着该线程必须是<strong>正在执行或执行完毕但未合并的线程</strong>，可以使用<code>.joinable()</code>判断是否可合并</p>
<p>不能被合并的情况：</p>
<ul>
<li>默认构造函数初始化的</li>
<li>join()完成的</li>
<li>detach()后的</li>
<li>被移动的</li>
</ul>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;array&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">greeting</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">idx</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">printf</span><span style="color: #24292E">(</span><span style="color: #032F62">"Hello from thread </span><span style="color: #005CC5">%d\n</span><span style="color: #032F62">"</span><span style="color: #24292E">, idx);</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::array</span><span style="color: #D73A49">&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread, </span><span style="color: #005CC5">10</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> workers;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;i</span><span style="color: #D73A49">&lt;</span><span style="color: #005CC5">10</span><span style="color: #24292E">;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    workers[i] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">thread</span><span style="color: #24292E">(greeting, i);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">auto</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">workers:workers){</span></span>
<span class="line"><span style="color: #24292E">    workers.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<figure class="shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #24292e">Hello from thread 0</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 1</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 2</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 3</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 4</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 5</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 6</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 7</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 8</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 9</span></span></code></pre></div></div></figure>
<h3 id="fork-and-join">Fork and join</h3>
<p>可以使用线程实现并行</p>
<p>通过Fork and
join模式：把要执行的数据分成n份，由n个线程并行处理自己的那部分数据，再进行汇总，n可以根据cpu核心设置</p>
<p>实现简单，但对于复杂计算，相同数据处理时间不同，导致有些线程很早处理完毕，有的需要更长时间结束</p>
<blockquote>
<p>实现transform_reduce函数</p>
</blockquote>
<figure class="shiki C++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div><div class="code"><pre><code>#include<thread>
#include<vector>
#include<array>
#include<iostream>
template<typename Iter,="" typename="" UnaryOp,="" BinaryOp,="" Result="">
void transform_reduce(Iter first, Iter last, UnaryOp transform, BinaryOp reduce, Result&amp; res){
  for (auto it=first;it&lt;last;it++){
    res = reduce(res, transform(*it));
  }
}

int main(){
  const int N = 1000000;
  std::vector<double> numbers;
  numbers.reserve(N);
  for (int i = 0; i &lt; N; ++i) {
    numbers.push_back((double)i/N);
  }
  auto transform = [](double x) { return x * x; };
  auto reduce = [](double x, double y) { return x + y; };
  const int N_thraeds = 8;
  std::vector<std::thread> workers;
  std::array<double, N_thraeds=""> subResults={};
  for (int i = 0; i<n_thraeds; i++){="" auto="" low="numbers.begin()+i*numbers.size()/N_thraeds;" high="numbers.begin()+(i+1)*numbers.size()/N_thraeds;" workers.push_back(="" std::thread(="" transform_reduce<std::vector<double="">::iterator,
        decltype(transform),
        decltype(reduce),double&gt;,
        low, high, transform, reduce, std::ref(subResults[i])
      )
    );
  }
  double result = 0;
  for (int i = 0; i &lt; N_thraeds; ++i) {
    workers[i].join();
    result = reduce(result,subResults[i]);
  }
  std::cout &lt;&lt; "Result: " &lt;&lt; result &lt;&lt; std::endl;
  return 0;
}</n_thraeds;></double,></std::thread></double></typename></iostream></array></vector></thread></code></pre></div></div></figure>
<h3 id="divide-and-conquer">Divide and conquer</h3>
<p>使用分治将一个任务分成两个小任务，由两个线程完成，然后小任务再分成两个小任务，创建两个线程完成，直到不能分解</p>
<p>另外需要设计一个阈值，当线程过多时就不再创建，而是使用同步计算</p>
<p>为了让各个线程任务饱满，可以采用一半采用同步调用，一半分给另一个线程</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;vector&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;array&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">template</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">typename</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Iter</span><span style="color: #24292E">, </span><span style="color: #D73A49">typename</span><span style="color: #24292E"> </span><span style="color: #6F42C1">UnaryOp</span><span style="color: #24292E">, </span><span style="color: #D73A49">typename</span><span style="color: #24292E"> </span><span style="color: #6F42C1">BinaryOp</span><span style="color: #24292E">, </span><span style="color: #D73A49">typename</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Result</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> MinDist </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">&gt;</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">transform_reduce</span><span style="color: #24292E">(</span><span style="color: #6F42C1">Iter</span><span style="color: #24292E"> </span><span style="color: #E36209">first</span><span style="color: #24292E">, </span><span style="color: #6F42C1">Iter</span><span style="color: #24292E"> </span><span style="color: #E36209">last</span><span style="color: #24292E">, </span><span style="color: #6F42C1">UnaryOp</span><span style="color: #24292E"> </span><span style="color: #E36209">transform</span><span style="color: #24292E">, </span><span style="color: #6F42C1">BinaryOp</span><span style="color: #24292E"> </span><span style="color: #E36209">reduce</span><span style="color: #24292E">, </span><span style="color: #6F42C1">Result</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">res</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> distance </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">distance</span><span style="color: #24292E">(first, last);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (distance</span><span style="color: #D73A49">==</span><span style="color: #005CC5">1</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    res </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">reduce</span><span style="color: #24292E">(res, </span><span style="color: #6F42C1">transform</span><span style="color: #24292E">(</span><span style="color: #D73A49">*</span><span style="color: #24292E">first));</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> half </span><span style="color: #D73A49">=</span><span style="color: #24292E"> distance </span><span style="color: #D73A49">/</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    Iter middle </span><span style="color: #D73A49">=</span><span style="color: #24292E"> first</span><span style="color: #D73A49">+</span><span style="color: #24292E">half;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    Result r_result </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    Result l_result </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">l_thread</span><span style="color: #24292E">(</span></span>
<span class="line"><span style="color: #24292E">      transform_reduce</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">Iter, UnaryOp, BinaryOp, Result</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">      first, middle, transform, reduce, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(l_result)</span></span>
<span class="line"><span style="color: #24292E">    );</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">r_thread</span><span style="color: #24292E">(</span></span>
<span class="line"><span style="color: #24292E">      transform_reduce</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">Iter, UnaryOp, BinaryOp, Result</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">      middle, last, transform, reduce, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(r_result)</span></span>
<span class="line"><span style="color: #24292E">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    l_thread.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    r_thread.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    res </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">reduce</span><span style="color: #24292E">(res, </span><span style="color: #6F42C1">reduce</span><span style="color: #24292E">(l_result, r_result));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="promise-future">promise &amp; future</h2>
<p>这两个类提供了线程之间简单的通信机制</p>
<p>通过promise来设置值或异常，通过future来获得值或异常</p>
<p>一对promise&amp;future共享一个shared
state（共享状态），是一个类对象，提供了在保证线程安全的情况下，设置和获取状态与结果的方法，使用shared_ptr指向该状态</p>
<p>常用于发送-接受模式中</p>
<h3 id="promise">promise</h3>
<p>promise类模板提供了按值、按引用传递数据，以及仅传递信号三种版本</p>
<p>对应的成员函数：</p>
<ul>
<li>promise()：构造函数，创建一个共享状态</li>
<li>promise(promise&amp;&amp;
x)：移动构造函数，将被移动对象x的共享状态转移过去</li>
<li>get_future()：创建一个future对象，使用promise中的共享状态，<strong>只能调用一次</strong></li>
<li>set_value()：设置共享状态中的值，并设置为就绪状态</li>
<li>set_exception()：设置共享状态的异常</li>
</ul>
<p><strong>注：为了保证一对一性，promise类删除了拷贝构造函数</strong></p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;future&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">compute_pi</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">long</span><span style="color: #24292E"> </span><span style="color: #E36209">num_steps</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">promise</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">double</span><span style="color: #24292E">&gt;</span><span style="color: #D73A49">&amp;&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">promise</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> step </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1.0</span><span style="color: #D73A49">/</span><span style="color: #24292E"> num_steps;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> sum </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0.0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E">(</span><span style="color: #D73A49">long</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> num_steps; </span><span style="color: #D73A49">++</span><span style="color: #24292E">i){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">double</span><span style="color: #24292E"> x </span><span style="color: #D73A49">=</span><span style="color: #24292E"> (i </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">0.5</span><span style="color: #24292E">) </span><span style="color: #D73A49">*</span><span style="color: #24292E"> step;</span></span>
<span class="line"><span style="color: #24292E">    sum </span><span style="color: #D73A49">+=</span><span style="color: #24292E"> </span><span style="color: #005CC5">4.0</span><span style="color: #24292E"> </span><span style="color: #D73A49">/</span><span style="color: #24292E"> (</span><span style="color: #005CC5">1.0</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> x </span><span style="color: #D73A49">*</span><span style="color: #24292E"> x);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  promise.</span><span style="color: #6F42C1">set_value</span><span style="color: #24292E">(sum </span><span style="color: #D73A49">*</span><span style="color: #24292E"> step);</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">display</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">future</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">double</span><span style="color: #24292E">&gt;</span><span style="color: #D73A49">&amp;&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">receiver</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> pi </span><span style="color: #D73A49">=</span><span style="color: #24292E"> receiver.</span><span style="color: #6F42C1">get</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"Computed value of Pi: "</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> pi </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N_steps </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">100000000</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::promise</span><span style="color: #D73A49">&lt;double&gt;</span><span style="color: #24292E"> promise;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> receiver </span><span style="color: #D73A49">=</span><span style="color: #24292E"> promise.</span><span style="color: #6F42C1">get_future</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 调用获得future对象后就没什么用了</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(compute_pi, N_steps, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">move</span><span style="color: #24292E">(promise));</span><span style="color: #6A737D"> // 将promose对象转换为xvalue，作为实参换入</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(display, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">move</span><span style="color: #24292E">(receiver));</span></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h3 id="future">future</h3>
<p>future中的方法主要用于获取状态与结果</p>
<ul>
<li>get()：获得结果，若对应结果没有处在就绪状态，那么这个调用会阻塞直到就绪</li>
<li>wait()：等待状态就绪，之后返回，此时调用get可以直接获得结果</li>
<li>wait_for()：等待指定时长，返回状态码</li>
<li>wait_until()：等待到指定时刻，返回状态码</li>
<li>share()：</li>
</ul>
<p>状态码包括：</p>
<ul>
<li>ready：共享状态就绪</li>
<li>timeout：超时</li>
<li>deferred：共享状态中有延缓执行的函数（显式请求中才会调用的函数）</li>
</ul>
<p>若需要让多个线程获得结果，需要shared_future，构建方法如下：</p>
<ul>
<li>定义对象，使用promise的get_future()作为初始化参数</li>
<li>在原有future上调用方法.share()，此时原有不再使用</li>
</ul>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;future&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;sstream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">compute_pi</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">long</span><span style="color: #24292E"> </span><span style="color: #E36209">num_steps</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">promise</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">double</span><span style="color: #24292E">&gt;</span><span style="color: #D73A49">&amp;&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">promise</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> step </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1.0</span><span style="color: #D73A49">/</span><span style="color: #24292E"> num_steps;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> sum </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0.0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E">(</span><span style="color: #D73A49">long</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> num_steps; </span><span style="color: #D73A49">++</span><span style="color: #24292E">i){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">double</span><span style="color: #24292E"> x </span><span style="color: #D73A49">=</span><span style="color: #24292E"> (i </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">0.5</span><span style="color: #24292E">) </span><span style="color: #D73A49">*</span><span style="color: #24292E"> step;</span></span>
<span class="line"><span style="color: #24292E">    sum </span><span style="color: #D73A49">+=</span><span style="color: #24292E"> </span><span style="color: #005CC5">4.0</span><span style="color: #24292E"> </span><span style="color: #D73A49">/</span><span style="color: #24292E"> (</span><span style="color: #005CC5">1.0</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> x </span><span style="color: #D73A49">*</span><span style="color: #24292E"> x);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  promise.</span><span style="color: #6F42C1">set_value</span><span style="color: #24292E">(sum </span><span style="color: #D73A49">*</span><span style="color: #24292E"> step);</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">display</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">shared_future</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">double</span><span style="color: #24292E">&gt; </span><span style="color: #E36209">reveiver</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">static</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex mu;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> pi </span><span style="color: #D73A49">=</span><span style="color: #24292E"> reveiver.</span><span style="color: #6F42C1">get</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">printf</span><span style="color: #24292E">(</span><span style="color: #032F62">"Computed value of Pi: </span><span style="color: #005CC5">%f\n</span><span style="color: #032F62">"</span><span style="color: #24292E">, pi);</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N_steps </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">100000000</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::promise</span><span style="color: #D73A49">&lt;double&gt;</span><span style="color: #24292E"> promise;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::shared_future</span><span style="color: #D73A49">&lt;double&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">shared_receiver</span><span style="color: #24292E">(promise.</span><span style="color: #6F42C1">get_future</span><span style="color: #24292E">());</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(compute_pi, N_steps, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">move</span><span style="color: #24292E">(promise));</span></span>
<span class="line"><span style="color: #6A737D">  // 使用shared_future可以让多个线程共享同一个future对象</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(display, shared_receiver);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th3</span><span style="color: #24292E">(display, shared_receiver);</span></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th3.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="互斥和锁">互斥和锁</h2>
<p>多线程中，当多个线程队同一个对象进行访问，并且至少有一个在写数据时，会产生数据竞争</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;array&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">inc</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">res</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">1000000</span><span style="color: #24292E">; </span><span style="color: #D73A49">++</span><span style="color: #24292E">i){</span></span>
<span class="line"><span style="color: #24292E">    res</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> counter </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(inc, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(counter));</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(inc, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(counter));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"Counter: "</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> counter </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>该程序创建了两个线程进行累加，但最后得到的结果都不是正确结果，且每次都不一样</p>
<p><img src="并行编程/image-20250725112934180.png" alt="正常" style="zoom:50%;"></p>
<p>这是一个正常的执行过程</p>
<p><img src="并行编程/image-20250725113007523.png" alt="错误执行" style="zoom:50%;"></p>
<p>若顺序是这样结果就不对了</p>
<h3 id="互斥量">互斥量</h3>
<p>C++中所有运算默认为<strong>非原子操作</strong>，即该线程操作随时会被终端或被其他线程访问</p>
<p>mutex提供了一种同步机制，实现多个线程的安全访问</p>
<p>C++11开始，提供了<code>std::mutex</code>来实现互斥原语，是最常用的同步原语之一</p>
<p>有三个主要函数：</p>
<ul>
<li>lock()：锁定互斥量，即获得互斥量，若已经被其他线程锁定，则会进入阻塞直到被解锁</li>
<li>try_lock()：尝试锁定互斥量，若成功锁定则返回true，否则返回false（不保证被其他线程锁定）</li>
<li>unlock()：解锁，释放互斥量</li>
</ul>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;array&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">counter</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">inc</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #6A737D">    // 对要修改的资源进行保护</span></span>
<span class="line"><span style="color: #6A737D">    // 保证同一时间只有一个线程可以修改资源</span></span>
<span class="line"><span style="color: #6A737D">    // 即要么获得互斥量的锁，要么等待</span></span>
<span class="line"><span style="color: #24292E">    counter_mutex.</span><span style="color: #6F42C1">lock</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    m_count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span><span style="color: #6A737D"> // 临界区</span></span>
<span class="line"><span style="color: #24292E">    counter_mutex.</span><span style="color: #6F42C1">unlock</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">get</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">int</span><span style="color: #24292E"> temp;</span></span>
<span class="line"><span style="color: #24292E">    counter_mutex.</span><span style="color: #6F42C1">lock</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    temp </span><span style="color: #D73A49">=</span><span style="color: #24292E"> m_count;</span><span style="color: #6A737D"> // 临界区</span></span>
<span class="line"><span style="color: #24292E">    counter_mutex.</span><span style="color: #6F42C1">unlock</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> temp;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> m_count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex counter_mutex;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  counter c;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> increase </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [](</span><span style="color: #6F42C1">counter</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">c</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">1000000</span><span style="color: #24292E">; </span><span style="color: #D73A49">++</span><span style="color: #24292E">i){</span></span>
<span class="line"><span style="color: #24292E">      c.</span><span style="color: #6F42C1">inc</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(increase, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(c));</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(increase, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(c));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"Counter: "</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> c.</span><span style="color: #6F42C1">get</span><span style="color: #24292E">() </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>其中，被mutex保护的操作区域叫做<strong>临界区</strong></p>
<p>为了避免未释放互斥量的问题，我们通常结合以下对象使用</p>
<ul>
<li>lock_guard()：可以通过调用上锁后自动解锁，防止忘记解锁以及出现异常离开作用域时没有解锁</li>
</ul>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">counter</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">inc</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(counter_mutex);</span></span>
<span class="line"><span style="color: #24292E">    m_count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span><span style="color: #6A737D"> // 临界区</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">get</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(counter_mutex);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> m_count;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> m_count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex counter_mutex;</span></span>
<span class="line"><span style="color: #24292E">};</span></span></code></pre></div></div></figure>
<ul>
<li>unique_lock()：更加灵活，可以随时指定锁定与解锁</li>
</ul>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;array&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">counter</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">inc</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">n</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(counter_mutex, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::defer_lock);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">while</span><span style="color: #24292E">(n</span><span style="color: #D73A49">--</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      lock.</span><span style="color: #6F42C1">lock</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 对要修改的资源进行保护</span></span>
<span class="line"><span style="color: #24292E">      m_count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span><span style="color: #6A737D"> // 临界区</span></span>
<span class="line"><span style="color: #24292E">      lock.</span><span style="color: #6F42C1">unlock</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">get</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(counter_mutex);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> m_count; </span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> m_count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex counter_mutex;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  counter c;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> increase </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [](</span><span style="color: #6F42C1">counter</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">c</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    c.</span><span style="color: #6F42C1">inc</span><span style="color: #24292E">(</span><span style="color: #005CC5">1000000</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(increase, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(c));</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(increase, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(c));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"Counter: "</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> c.</span><span style="color: #6F42C1">get</span><span style="color: #24292E">() </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<ul>
<li>timed_mutex：有等待时长的互斥
<ul>
<li>try_lock_for()：指定时长内获得mutex的所有权</li>
<li>try_lock_until()：指定时刻前获得mutex的所有权</li>
</ul></li>
</ul>
<p>​ 返回true表明获得mutex，否则返回false</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;sstream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono_literals</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">TryDemo</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">print</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i</span><span style="color: #D73A49">&lt;</span><span style="color: #005CC5">10</span><span style="color: #24292E">; i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(m_mutex, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::defer_lock);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (lock.</span><span style="color: #6F42C1">try_lock_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #D73A49">ms</span><span style="color: #24292E">)) {</span></span>
<span class="line"><span style="color: #24292E">        {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">guard</span><span style="color: #24292E">(cout_mutex);</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"["</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">get_id</span><span style="color: #24292E">()</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"] "</span></span>
<span class="line"><span style="color: #24292E">                  </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"Got the lock, printing "</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> i </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">        }</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #D73A49">ms</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">      }</span><span style="color: #6A737D"> // 尝试获取锁，</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">guard</span><span style="color: #24292E">(cout_mutex);</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"["</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">get_id</span><span style="color: #24292E">()</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"] "</span></span>
<span class="line"><span style="color: #24292E">                  </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"Failed to get the lock, skipping "</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> i </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #D73A49">ms</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">       }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::timed_mutex m_mutex;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex cout_mutex; </span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> m_count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  TryDemo demo;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> print </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [](</span><span style="color: #6F42C1">TryDemo</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">demo</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    demo.</span><span style="color: #6F42C1">print</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(print, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(demo));</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(print, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(demo));</span></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<figure class="shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #24292e">[2] Got the lock, printing 0</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 0</span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 1</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 1</span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 2</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 2</span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 3</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 3</span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 4</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 4</span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 5</span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 6</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 5        </span></span>
<span class="line"><span style="color: #24292e">[3] Got the lock, printing 6</span></span>
<span class="line"><span style="color: #24292e">[3] Got the lock, printing 7</span></span>
<span class="line"><span style="color: #24292e">[2] Failed to get the lock, skipping 7        </span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 8</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 8</span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 9</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 9</span></span></code></pre></div></div></figure>
<h3 id="死锁">死锁</h3>
<p>单一线程中多次锁定同一个互斥量会导致死锁</p>
<p>常见死锁：</p>
<figure class="shiki C++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre><code>#include<iostream>
#include<mutex>
#include<thread>

class dosome{
public:
  int f1(){
    std::lock_guard lock(mtx);
    count*=2;
    f2();
    return count;

  }
  void f2(){
    std::lock_guard(mtx); // 已经在外层被锁定过了
    count++;
  }
private:
  std::mutex mtx;
  int count=0;
};</thread></mutex></iostream></code></pre></div></div></figure>
<p>此时所在线程会进入阻塞状态</p>
<p>我们使用`<code>recursive</code>的mutx优化</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(mtx);</span></span>
<span class="line"><span style="color: #24292E">    count</span><span style="color: #D73A49">*=</span><span style="color: #005CC5">2</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> count;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">lock_guard</span><span style="color: #24292E">(mtx);</span><span style="color: #6A737D"> // 已经在外层被锁定过了</span></span>
<span class="line"><span style="color: #24292E">    count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::recursive_mutex mtx;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> count</span><span style="color: #D73A49">=</span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">};</span></span></code></pre></div></div></figure>
<p>当被锁定并获得互斥量后，当前线程再调用lock后仍会成功而不会阻塞，直到调用相同数量的unlock()才会被释放</p>
<h3 id="多线程中">多线程中</h3>
<p>多线程中，导致死锁原因较多</p>
<ol type="1">
<li>锁定一个互斥量后没有释放，导致后面的线程获取该互斥量时进入阻塞状态</li>
</ol>
<p>解决方法：使用<strong>RAII</strong>，即使用lock_guard等自动对象，在离开作用域后自动释放互斥量</p>
<ol start="2" type="1">
<li>同时对多个互斥量锁定解锁时，获得和释放顺序不同导致死锁</li>
</ol>
<p>如以下代码</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono_literals</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock1</span><span style="color: #24292E">(mtx1);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock2</span><span style="color: #24292E">(cout_mtx);</span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"count: "</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #D73A49">ms</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">   </span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock1</span><span style="color: #24292E">(cout_mtx);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock2</span><span style="color: #24292E">(mtx1); </span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">--</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"count: "</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #D73A49">ms</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">calc</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">n</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">n;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (n</span><span style="color: #D73A49">%</span><span style="color: #005CC5">2</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex mtx1;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex cout_mtx;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> count</span><span style="color: #D73A49">=</span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  dosome d;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10000</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10001</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N1);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N2);</span></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>这里f1与f2都对两个互斥量进行锁定，顺序不同</p>
<p>主函数设置两个线程分别为10000次，执行f1，10001次，执行f2</p>
<p>此时运行程序会在一定时间发生死锁：</p>
<p>线程1在某个时刻获得了mtx1，线程2在下一时刻获得了cout_mtx</p>
<p>接下来线程1需要获得cout_mtx，但已被2占有，需要进入阻塞等待资源释放</p>
<p>同时线程2需要获得mtx1，但已被1占有，需要进入阻塞等待资源释放</p>
<p>故整个程序进入阻塞，无法执行</p>
<figure>
<img src="并行编程/image-20250727151242766.png" alt="阻塞">
<figcaption aria-hidden="true">阻塞</figcaption>
</figure>
<h3 id="活锁">活锁</h3>
<p>对于上述问题，解决方法之一是使用timed_mutex+try_lock_for</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono_literals</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">while</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lock1</span><span style="color: #24292E">(mtx1, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::defer_lock);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lock2</span><span style="color: #24292E">(cout_mtx, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::defer_lock);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #24292E">lock1.</span><span style="color: #6F42C1">try_lock_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #D73A49">ms</span><span style="color: #24292E">)) </span><span style="color: #D73A49">continue</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #24292E">lock2.</span><span style="color: #6F42C1">try_lock_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #D73A49">ms</span><span style="color: #24292E">)) </span><span style="color: #D73A49">continue</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"count: "</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">break</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">while</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lock1</span><span style="color: #24292E">(cout_mtx, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::defer_lock);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lock2</span><span style="color: #24292E">(mtx1, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::defer_lock);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #24292E">lock1.</span><span style="color: #6F42C1">try_lock_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #D73A49">ms</span><span style="color: #24292E">)) </span><span style="color: #D73A49">continue</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #24292E">lock2.</span><span style="color: #6F42C1">try_lock_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #D73A49">ms</span><span style="color: #24292E">)) </span><span style="color: #D73A49">continue</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">--</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"count: "</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">break</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  </span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">calc</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">n</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">n;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (n</span><span style="color: #D73A49">%</span><span style="color: #005CC5">2</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::timed_mutex mtx1;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::timed_mutex cout_mtx;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> count</span><span style="color: #D73A49">=</span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  dosome d;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10000</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10001</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N1);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N2);</span></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>但是运行起来会出现一顿一顿的情况</p>
<p>此时程序进入了一种<strong>活锁</strong>的状态，即</p>
<p>线程1锁定mtx1，线程2锁定cout_mtx</p>
<p>线程1试图锁定cout_mtx1失败，进入阻塞，超时后释放mtx1进入下个循环，</p>
<p>线程2试图锁定mtx1失败，进入阻塞，超时后释放cout_mtx进入下个循环</p>
<p>以此类推</p>
<p>防止该情况的发生，需要注意调用次序，注意保证按照顺序获得互斥量</p>
<p>更加方便的方法是使用std::lock()函数或scope_lock类统一管理多个互斥量</p>
<h3 id="lock函数">lock函数</h3>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono_literals</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(mtx1, cout_mtx);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock1</span><span style="color: #24292E">(mtx1, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::adopt_lock);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock2</span><span style="color: #24292E">(cout_mtx, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::adopt_lock);</span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"count: "</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(mtx1, cout_mtx);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock1</span><span style="color: #24292E">(cout_mtx, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::adopt_lock);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock2</span><span style="color: #24292E">(mtx1, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::adopt_lock); </span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">--</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"count: "</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">calc</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">n</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">n;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (n</span><span style="color: #D73A49">%</span><span style="color: #005CC5">2</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex mtx1;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex cout_mtx;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> count</span><span style="color: #D73A49">=</span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  dosome d;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10000</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10001</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N1);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N2);</span></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>此时lock函数会接管下面的两个lock_guard，当他们被销毁时，析构函数中会自动释放两个互斥量</p>
<p>即使传入的两个互斥量顺序不同，lock的特殊算法也可避免死锁的发生</p>
<h3 id="scope_lock类">scope_lock类</h3>
<p>该类更加方便，使用多个类进行初始化</p>
<p>构造时可以自动调用lock函数，析构时自动释放</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono_literals</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::scoped_lock </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(mtx1, cout_mtx);</span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"count: "</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::scoped_lock </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(cout_mtx, mtx1);</span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">--</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"count: "</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">calc</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">n</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">n;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (n</span><span style="color: #D73A49">%</span><span style="color: #005CC5">2</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex mtx1;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex cout_mtx;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> count</span><span style="color: #D73A49">=</span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  dosome d;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10000</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10001</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N1);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N2);</span></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h3 id="读写锁">读写锁</h3>
<p>若存在三个线程读取数据、一个线程写入数据，若使用mutex互斥量进行操作，读写步骤几乎是排队进行的，导致了程序运行效率底下</p>
<p>我们又知道，在没有数据写入的情况下，多个线程同时读取数据是不会发生数据竞争的，不必独占资源</p>
<p>故我们可以规定：</p>
<ul>
<li>一个线程读取数据时，允许其他线程同时读取数据，不允许其他线程写数据</li>
<li>一个线程写数据时，不允许其他线程读写数据</li>
</ul>
<p>这样可以显著提高效率</p>
<p>C++14以上，这样的读写锁的功能由<code>shared_mutex</code>类、<code>shared_timed_mutex</code>提供</p>
<p>该类提供两个模式和两个锁：</p>
<ul>
<li>独占模式：仅有一个线程可以占有互斥量</li>
<li>独占锁：独占模式下，当一个线程获得独占锁，任何其他线程都不能获得独占锁和共享锁</li>
<li>共享模式：可以有多个线程分享互斥量</li>
<li>共享锁：共享模式下，当一个线程获得共享锁，其他线程可获得共享锁，不能获得独占锁</li>
</ul>
<p>读写锁广泛应用于读多写少的场景下，是一种重要的同步原语</p>
<h2 id="条件变量">条件变量</h2>
<p>条件变量是并发程序中经常用到的同步原语，可以实现在线程间发生通知以实现线程间的同步</p>
<h3 id="工作流">工作流</h3>
<blockquote>
<p>如提供两个线程，用于读取与写入数据，读取要在写入之后</p>
</blockquote>
<ol type="1">
<li>接收线程获得互斥量mutex，使用条件变量来等待发送线程的通知，等待时释放mutex</li>
<li>发送线程获得mutex，并对共享数据进行写入，完成后释放mutex</li>
<li>发送线程使用条件变量发送通知，接收线程接收到通知后重新获得mutex，结束阻塞继续运行</li>
<li>接收线程读取处理共享数据，处理完毕后释放mutex</li>
</ol>
<h3 id="使用">使用</h3>
<p>标准库conditional_variable实现条件变量原语，包含以下函数：</p>
<p>等待：</p>
<ul>
<li>wait：传入锁的引用以及解除阻塞的条件。进入等待状态时释放锁，结束后获得锁，且都是原子操作</li>
<li>wait_for：</li>
<li>wait_until：</li>
</ul>
<p>通知：</p>
<ul>
<li>notify_one：</li>
<li>notify_all：</li>
</ul>
<h3 id="例">例</h3>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;condition_variable&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono_literals</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">channel</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">getData</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> tid </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">get_id</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lck</span><span style="color: #24292E">(mutex_);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"接收方["</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">tid</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"]等待数据"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    condVar.</span><span style="color: #6F42C1">wait</span><span style="color: #24292E">(lck);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"接收方["</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">tid</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"]得到数据"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">sharedData</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    sharedData.</span><span style="color: #6F42C1">clear</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">setData</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">static</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> id </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::stringstream ss;</span></span>
<span class="line"><span style="color: #24292E">    ss </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"hello #"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">id;</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lck</span><span style="color: #24292E">(mutex_);</span></span>
<span class="line"><span style="color: #24292E">      sharedData </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ss.</span><span style="color: #6F42C1">str</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout  </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"</span><span style="color: #005CC5">\n</span><span style="color: #032F62">发送方：第"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">id</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"条数据写入完毕"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">      id</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    condVar.</span><span style="color: #6F42C1">notify_one</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #D73A49">ms</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex mutex_;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::condition_variable condVar;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::string sharedData;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  channel c;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">write_th</span><span style="color: #24292E">(</span><span style="color: #6F42C1">channel</span><span style="color: #24292E">::setData, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">c);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">read_th</span><span style="color: #24292E">(</span><span style="color: #6F42C1">channel</span><span style="color: #24292E">::getData, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">c);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  read_th.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  write_th.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h3 id="丢失唤醒与虚假唤醒">丢失唤醒与虚假唤醒</h3>
<p>发现程序运行时，有时会出现死锁的状态</p>
<p>从输出发现，写线程在读线程进入等待前就准备好了数据并发出通知，而读线程进入状态后才</p>
<p>准备接受通知，于是错过了通知，一直等待，发生丢失唤醒</p>
<p>除了丢失唤醒，等待函数还会出现虚假唤醒：即等待线程在条件未满足的情况下被唤醒了</p>
<p>原因与底层硬件软件的异常有关</p>
<p>因此我们最好使用wait函数的重载版本，设置一个等待条件</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;condition_variable&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono_literals</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">channel</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">getData</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> tid </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">get_id</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lck</span><span style="color: #24292E">(mutex_);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"接收方["</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">tid</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"]等待数据"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    condVar.</span><span style="color: #6F42C1">wait</span><span style="color: #24292E">(lck, [</span><span style="color: #005CC5">this</span><span style="color: #24292E">]{</span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #D73A49">!</span><span style="color: #24292E">sharedData.</span><span style="color: #6F42C1">empty</span><span style="color: #24292E">();});</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (sharedData.</span><span style="color: #6F42C1">empty</span><span style="color: #24292E">()){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"接收方["</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">tid</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"] 虚假唤醒"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">else</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"接收方["</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">tid</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"]得到数据"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">sharedData</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    sharedData.</span><span style="color: #6F42C1">clear</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">setData</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">static</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> id </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::stringstream ss;</span></span>
<span class="line"><span style="color: #24292E">    ss </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"hello #"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">id;</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lck</span><span style="color: #24292E">(mutex_);</span></span>
<span class="line"><span style="color: #24292E">      sharedData </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ss.</span><span style="color: #6F42C1">str</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout  </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"</span><span style="color: #005CC5">\n</span><span style="color: #032F62">发送方：第"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">id</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"条数据写入完毕"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">      id</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    condVar.</span><span style="color: #6F42C1">notify_one</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #D73A49">ms</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex mutex_;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::condition_variable condVar;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::string sharedData;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  channel c;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">write_th</span><span style="color: #24292E">(</span><span style="color: #6F42C1">channel</span><span style="color: #24292E">::setData, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">c);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">read_th</span><span style="color: #24292E">(</span><span style="color: #6F42C1">channel</span><span style="color: #24292E">::getData, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">c);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  read_th.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  write_th.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="信号量">信号量</h2>
<p>实现对有限资源的并发访问控制，内部有一个计数器，表示资源的可用数量</p>
<p>线程通过信号量来获得对资源的访问许可，若大于0，可以进行访问，计数器减一</p>
<p>信号量要与互斥量结合使用，用信号量来限制并发访问数量，用互斥量实现对具体数据同步</p>
<p>C++标准库中，有一个类模板<code>counting_semaphore</code>，其中参数<code>LeastMaxValue</code>规定了计数最大值不小于该值，还有他的特化版本<code>binary_semaphore</code>，值设定为1</p>
<p>函数：</p>
<ul>
<li>release：将计数值+1，是原子操作</li>
<li>acquire：若计数值大于1，则将计数值-1，如果为0，则该函数阻塞直到计数值大于1</li>
<li>try_acquire：成功时将计数值-1，返回true</li>
<li>try_acquire_for：阻塞时最多等待的时间</li>
<li>try_acquire_until：阻塞时最多等待到某个时刻</li>
</ul>
<p>例：循环读写buffer</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;random&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;array&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;semaphore&gt;</span><span style="color: #24292E"> </span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;syncstream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// 简单的随机辅助类</span></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Random</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #6A737D">    // 构造 [l, r] 的整数随机</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">Random</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">l</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">r</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">      : </span><span style="color: #6F42C1">eng</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::random_device{}()),</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">dist</span><span style="color: #24292E">(l, r)</span></span>
<span class="line"><span style="color: #24292E">    {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #D73A49">operator</span><span style="color: #6F42C1">()</span><span style="color: #24292E">() {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">dist</span><span style="color: #24292E">(eng);</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mt19937 eng;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::uniform_int_distribution</span><span style="color: #D73A49">&lt;int&gt;</span><span style="color: #24292E"> dist;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// RWBuffer 模板</span></span>
<span class="line"><span style="color: #D73A49">template</span><span style="color: #24292E"> &lt;</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> </span><span style="color: #6F42C1">BuffSize</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">6</span><span style="color: #24292E">&gt;</span></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">RWBuffer</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">RWBuffer</span><span style="color: #24292E">() {</span></span>
<span class="line"><span style="color: #24292E">        buff.</span><span style="color: #6F42C1">fill</span><span style="color: #24292E">(</span><span style="color: #032F62">' '</span><span style="color: #24292E">);</span><span style="color: #6A737D">    // 填充空格</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 模拟生产者准备数据</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">char</span><span style="color: #24292E"> </span><span style="color: #6F42C1">prepareData</span><span style="color: #24292E">() {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">(</span><span style="color: #6F42C1">rgen</span><span style="color: #24292E">()));</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">chargen</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 模拟消费者处理数据</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">processData</span><span style="color: #24292E">(</span><span style="color: #D73A49">char</span><span style="color: #6A737D"> /*ch*/</span><span style="color: #24292E">) {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">(</span><span style="color: #6F42C1">rgen2</span><span style="color: #24292E">()));</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 原子打印缓存区</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">printBuffer</span><span style="color: #24292E">() {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::osyncstream </span><span style="color: #6F42C1">sync</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout);</span></span>
<span class="line"><span style="color: #24292E">        sync </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"BUFFER: |"</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">auto</span><span style="color: #24292E"> c : buff) {</span></span>
<span class="line"><span style="color: #24292E">            sync </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> c </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"|"</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">        }</span></span>
<span class="line"><span style="color: #24292E">        sync </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"</span><span style="color: #005CC5">\n</span><span style="color: #032F62">"</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 写线程函数</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">writeToBuffer</span><span style="color: #24292E">(</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> </span><span style="color: #E36209">iterations</span><span style="color: #24292E">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout) </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"写线程就绪.</span><span style="color: #005CC5">\n</span><span style="color: #032F62">"</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #6A737D">        // 总共写 iterations * BuffSize 次</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> iterations </span><span style="color: #D73A49">*</span><span style="color: #24292E"> BuffSize; i</span><span style="color: #D73A49">++</span><span style="color: #24292E">) {</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #D73A49">char</span><span style="color: #24292E"> ch </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">prepareData</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">            sem_writer.</span><span style="color: #6F42C1">acquire</span><span style="color: #24292E">();</span><span style="color: #6A737D">        // 等待有空位</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> idx </span><span style="color: #D73A49">=</span><span style="color: #24292E"> i </span><span style="color: #D73A49">%</span><span style="color: #24292E"> BuffSize;</span></span>
<span class="line"><span style="color: #24292E">            buff[idx] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ch;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout) </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"写线程：写入 '"</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> ch </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"' 到位置 "</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> idx </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"</span><span style="color: #005CC5">\t</span><span style="color: #032F62">"</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #6F42C1">printBuffer</span><span style="color: #24292E">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">            sem_reader.</span><span style="color: #6F42C1">release</span><span style="color: #24292E">();</span><span style="color: #6A737D">        // 通知读线程</span></span>
<span class="line"><span style="color: #24292E">        }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 读线程函数</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">readFromBuffer</span><span style="color: #24292E">(</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> </span><span style="color: #E36209">iterations</span><span style="color: #24292E">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout) </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"读线程就绪.</span><span style="color: #005CC5">\n</span><span style="color: #032F62">"</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> iterations </span><span style="color: #D73A49">*</span><span style="color: #24292E"> BuffSize; i</span><span style="color: #D73A49">++</span><span style="color: #24292E">) {</span></span>
<span class="line"><span style="color: #24292E">            sem_reader.</span><span style="color: #6F42C1">acquire</span><span style="color: #24292E">();</span><span style="color: #6A737D">        // 等待有数据</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> idx </span><span style="color: #D73A49">=</span><span style="color: #24292E"> i </span><span style="color: #D73A49">%</span><span style="color: #24292E"> BuffSize;</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #D73A49">char</span><span style="color: #24292E"> ch </span><span style="color: #D73A49">=</span><span style="color: #24292E"> buff[idx];</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #6F42C1">processData</span><span style="color: #24292E">(ch);</span></span>
<span class="line"><span style="color: #24292E">            buff[idx] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #032F62">' '</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout) </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"读线程：读取 '"</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> ch </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"' 从位置 "</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> idx </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"</span><span style="color: #005CC5">\t</span><span style="color: #032F62">"</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #6F42C1">printBuffer</span><span style="color: #24292E">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">            sem_writer.</span><span style="color: #6F42C1">release</span><span style="color: #24292E">();</span><span style="color: #6A737D">        // 通知写线程</span></span>
<span class="line"><span style="color: #24292E">        }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">    Random rgen{</span><span style="color: #005CC5">500</span><span style="color: #24292E">,</span><span style="color: #005CC5">1000</span><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #24292E">    Random rgen2{</span><span style="color: #005CC5">800</span><span style="color: #24292E">,</span><span style="color: #005CC5">1500</span><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #24292E">    Random chargen{</span><span style="color: #032F62">'A'</span><span style="color: #24292E">,</span><span style="color: #032F62">'Z'</span><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::array</span><span style="color: #D73A49">&lt;char</span><span style="color: #24292E">, BuffSize</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> buff;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::counting_semaphore</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">BuffSize</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> sem_reader{</span><span style="color: #005CC5">0</span><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::counting_semaphore</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">BuffSize</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> sem_writer{BuffSize};</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">constexpr</span><span style="color: #24292E"> </span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> N </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">6</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">constexpr</span><span style="color: #24292E"> </span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> ITERS </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">3</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    RWBuffer</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">N</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> buffer;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 启动写线程和读线程</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">writer</span><span style="color: #24292E">(</span><span style="color: #D73A49">&amp;</span><span style="color: #6F42C1">RWBuffer</span><span style="color: #24292E">&lt;</span><span style="color: #6F42C1">N</span><span style="color: #24292E">&gt;::writeToBuffer, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">buffer, ITERS);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">reader</span><span style="color: #24292E">(</span><span style="color: #D73A49">&amp;</span><span style="color: #6F42C1">RWBuffer</span><span style="color: #24292E">&lt;</span><span style="color: #6F42C1">N</span><span style="color: #24292E">&gt;::readFromBuffer, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">buffer, ITERS);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    writer.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    reader.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="异步任务">异步任务</h2>
<p>将函数调用交给另一个线程异步执行，原有线程继续执行代码，在需要时再去获得执行结果</p>
<p>C++中提供了async与packaged_task进行异步任务</p>
<figure>
<img src="并行编程/image-20250728133257958.png" alt="异步">
<figcaption aria-hidden="true">异步</figcaption>
</figure>
<h3 id="async">async</h3>
<p>语法：</p>
<p><code>std::future&lt;返回类型&gt; async(std::launch policy, F&amp; f, Args&amp;&amp;... args);</code></p>
<p><code>std::future&lt;返回类型&gt; async(F&amp; f, Args&amp;&amp;... args);</code>（默认策略）</p>
<p>执行策略（用整型不同bit位表示）：</p>
<ul>
<li><code>std::launch::async</code>：异步调用，00000001，相当于新建或使用线程池中的线程并在线程中调用函数</li>
<li><code>std::launch::deferred</code>：推迟调用，00000010，async返回的future对象用于存储函数指针、对象、实参拷贝，调用get函数时会同步调用存储的这个函数</li>
<li><code>std::launch::async|std::launch::deferred</code>：组合，00000011，同步还是异步执行根据具体实现决定</li>
</ul>
<h3 id="packaged_task">packaged_task</h3>
<p>方法</p>
<ul>
<li>get_future()：获得一个future对象，封装函数的返回结果存储在future对象的共享状态中</li>
<li><code>void operator()(ArgTypes... args)</code>：用于调用封装的函数，将返回结果存储在future中，此时会同步执行封装函数</li>
<li>reset()：用于重复使用packaged_task，清空状态获得一个新的future对象</li>
</ul>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;random&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;vector&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;future&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;syncstream&gt;</span></span>
<span class="line"><span style="color: #6A737D">// 简单的随机辅助类</span></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Random</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #6A737D">    // 构造 [l, r] 的整数随机</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">Random</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">l</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">r</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">      : </span><span style="color: #6F42C1">eng</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::random_device{}()),</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">dist</span><span style="color: #24292E">(l, r)</span></span>
<span class="line"><span style="color: #24292E">    {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #D73A49">operator</span><span style="color: #6F42C1">()</span><span style="color: #24292E">() {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">dist</span><span style="color: #24292E">(eng);</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mt19937 eng;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::uniform_int_distribution</span><span style="color: #D73A49">&lt;int&gt;</span><span style="color: #24292E"> dist;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">float</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Compute</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">vector</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">float</span><span style="color: #24292E">&gt; </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">v</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">seconds</span><span style="color: #24292E">(</span><span style="color: #005CC5">2</span><span style="color: #24292E">));</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> r </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">accumulate</span><span style="color: #24292E">(v.</span><span style="color: #6F42C1">begin</span><span style="color: #24292E">(), v.</span><span style="color: #6F42C1">end</span><span style="color: #24292E">(), </span><span style="color: #005CC5">0.0</span><span style="color: #D73A49">f</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout)</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"执行任务的线程id="</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">get_id</span><span style="color: #24292E">()</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> r;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> RN_MAX </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10000</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  Random </span><span style="color: #6F42C1">rgen</span><span style="color: #24292E">(</span><span style="color: #005CC5">0</span><span style="color: #24292E">, RN_MAX);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;float&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">numbers</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #24292E">, </span><span style="color: #005CC5">0.0</span><span style="color: #D73A49">f</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">generate</span><span style="color: #24292E">(numbers.</span><span style="color: #6F42C1">begin</span><span style="color: #24292E">(), numbers.</span><span style="color: #6F42C1">end</span><span style="color: #24292E">(), [</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">]{</span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #D73A49">float</span><span style="color: #24292E">(</span><span style="color: #6F42C1">rgen</span><span style="color: #24292E">()</span><span style="color: #D73A49">/</span><span style="color: #24292E">RN_MAX);});</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"创建任务的线程id:"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">get_id</span><span style="color: #24292E">()</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::packaged_task</span><span style="color: #D73A49">&lt;float</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;float&gt;&amp;</span><span style="color: #24292E">)</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">task</span><span style="color: #24292E">(Compute);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"直接调用"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::future</span><span style="color: #D73A49">&lt;float&gt;</span><span style="color: #24292E"> result </span><span style="color: #D73A49">=</span><span style="color: #24292E"> task.</span><span style="color: #6F42C1">get_future</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">task</span><span style="color: #24292E">(numbers);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"result="</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">result.</span><span style="color: #6F42C1">get</span><span style="color: #24292E">()</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  task.</span><span style="color: #6F42C1">reset</span><span style="color: #24292E">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"线程调用"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  result </span><span style="color: #D73A49">=</span><span style="color: #24292E"> task.</span><span style="color: #6F42C1">get_future</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">t</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">move</span><span style="color: #24292E">(task), </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(numbers));</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"result="</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">result.</span><span style="color: #6F42C1">get</span><span style="color: #24292E">()</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  t.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="线程屏障">线程屏障</h2>
<p>线程屏障提供了一个计数器，每个参与任务的线程完成自己的任务后计数器-1，而需要同步的线程可以阻塞到计数器为0时再执行后面的代码</p>
<h3 id="latch">latch</h3>
<p>latch是一次性的计数，参数为作为计数器的初始值</p>
<ul>
<li>count_down(n=1)：将计数器减去传入的数值，默认为1，是原子操作</li>
<li>wait()：将线程阻塞到计数器为0后释放</li>
<li>try_wait()：检查计数器是否为0，返回true为0，返回false不一定为0</li>
<li>arrive_and_wait(n=1)：执行了count_down和wait</li>
</ul>
<p>e.g.模拟paobu</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;latch&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;random&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">struct</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Runner</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::string name;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> time </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">run</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">latch</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">start</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">latch</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">end</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    start.</span><span style="color: #6F42C1">wait</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 等待发令枪响</span></span>
<span class="line"><span style="color: #6A737D">    // 模拟跑步过程</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> start_time </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">system_clock</span><span style="color: #24292E">::</span><span style="color: #6F42C1">now</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mt19937 </span><span style="color: #6F42C1">rng</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::random_device{}());</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::uniform_int_distribution</span><span style="color: #D73A49">&lt;unsigned</span><span style="color: #24292E"> </span><span style="color: #D73A49">int&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">uniform_dist</span><span style="color: #24292E">(</span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #005CC5">2000</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">(</span><span style="color: #005CC5">9600</span><span style="color: #D73A49">+</span><span style="color: #6F42C1">uniform_dist</span><span style="color: #24292E">(rng)));</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> end_time </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">system_clock</span><span style="color: #24292E">::</span><span style="color: #6F42C1">now</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    time </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">duration_cast</span><span style="color: #24292E">&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">&gt;(end_time </span><span style="color: #D73A49">-</span><span style="color: #24292E"> start_time).</span><span style="color: #6F42C1">count</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    end.</span><span style="color: #6F42C1">count_down</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">);</span><span style="color: #6A737D"> // 跑完，计数器-1</span></span>
<span class="line"><span style="color: #24292E">  } </span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">bool</span><span style="color: #24292E"> </span><span style="color: #D73A49">operator</span><span style="color: #6F42C1">&lt;</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Runner</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">other</span><span style="color: #24292E">) </span><span style="color: #D73A49">const</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> time </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> other.time;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">Runner</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> runners </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">    {</span><span style="color: #032F62">"Alice"</span><span style="color: #24292E">}, {</span><span style="color: #032F62">"Bob"</span><span style="color: #24292E">}, {</span><span style="color: #032F62">"Charlie"</span><span style="color: #24292E">}, {</span><span style="color: #032F62">"Diana"</span><span style="color: #24292E">}, {</span><span style="color: #032F62">"Eve"</span><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #6A737D">  // 等待阶段</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> runner_count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> runners.</span><span style="color: #6F42C1">size</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::latch </span><span style="color: #6F42C1">start</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">);</span><span style="color: #6A737D"> // 代表发令枪，等到为0时执行后面代码</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::latch </span><span style="color: #6F42C1">finish</span><span style="color: #24292E">(runner_count);</span><span style="color: #6A737D"> // 代表完赛选手数量，有一个选手冲线则-1，直到为0时比赛结束</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> threads;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">runner_count; </span><span style="color: #D73A49">++</span><span style="color: #24292E">i) {</span></span>
<span class="line"><span style="color: #24292E">    threads.</span><span style="color: #6F42C1">emplace_back</span><span style="color: #24292E">(</span><span style="color: #D73A49">&amp;</span><span style="color: #6F42C1">Runner</span><span style="color: #24292E">::run, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">runners[i], </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(start), </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(finish));</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"发令枪响"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  start.</span><span style="color: #6F42C1">count_down</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 发令枪响，所有选手开始跑</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  finish.</span><span style="color: #6F42C1">wait</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 等待所有选手跑完，阻塞</span></span>
<span class="line"><span style="color: #6A737D">  // 结束后统计成绩</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"比赛结束"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sort</span><span style="color: #24292E">(runners.</span><span style="color: #6F42C1">begin</span><span style="color: #24292E">(), runners.</span><span style="color: #6F42C1">end</span><span style="color: #24292E">());</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">auto&amp;</span><span style="color: #24292E"> runner : runners) {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> runner.name </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">" : "</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #D73A49">float</span><span style="color: #24292E">(runner.time)</span><span style="color: #D73A49">/</span><span style="color: #005CC5">1000</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"秒"</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E">(</span><span style="color: #D73A49">auto&amp;</span><span style="color: #24292E"> thread : threads) {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">      thread.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<figure class="shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #24292e">发令枪响</span></span>
<span class="line"><span style="color: #24292e">比赛结束</span></span>
<span class="line"><span style="color: #24292e">Eve : 9.946秒</span></span>
<span class="line"><span style="color: #24292e">Bob : 10.034秒</span></span>
<span class="line"><span style="color: #24292e">Diana : 10.092秒</span></span>
<span class="line"><span style="color: #24292e">Alice : 10.842秒</span></span>
<span class="line"><span style="color: #24292e">Charlie : 11.621秒</span></span></code></pre></div></div></figure>
<h3 id="barrier">barrier</h3>
<p>barrier每次计数到0时，都会把初始值恢复，进行下一轮计数</p>
<p>barrier是个类模板，参数为计数器初始值</p>
<ul>
<li><p>arrive(n=1)：将计数器减去指定参数n</p></li>
<li><p>wait()：等待计数器为0</p></li>
<li><p>arrive_and_wait(n=1)：前两个结合</p></li>
<li><p>arrive_and_drop(n=1)：除了将本次-n，还将下一次的初始值-n</p></li>
</ul>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;barrier&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;random&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;vector&gt;</span></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">participant</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::string name;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">participant</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">string</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">name</span><span style="color: #24292E">) : </span><span style="color: #6F42C1">name</span><span style="color: #24292E">(name) {}</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">template</span><span style="color: #24292E"> &lt;</span><span style="color: #D73A49">typename</span><span style="color: #24292E"> </span><span style="color: #6F42C1">BarrierType</span><span style="color: #24292E">&gt;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">run</span><span style="color: #24292E">(</span><span style="color: #6F42C1">BarrierType</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">finish</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #6A737D">    // 随机数确定是否能存货</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mt19937 </span><span style="color: #6F42C1">rng</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::random_device{}());</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::uniform_int_distribution</span><span style="color: #D73A49">&lt;unsigned</span><span style="color: #24292E"> </span><span style="color: #D73A49">int&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">uniform_dist</span><span style="color: #24292E">(</span><span style="color: #005CC5">1000</span><span style="color: #24292E">, </span><span style="color: #005CC5">2000</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i</span><span style="color: #D73A49">&lt;</span><span style="color: #005CC5">5</span><span style="color: #24292E">;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> rnd </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">uniform_dist</span><span style="color: #24292E">(rng);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">(rnd));</span></span>
<span class="line"><span style="color: #24292E">      alive </span><span style="color: #D73A49">=</span><span style="color: #24292E"> rnd</span><span style="color: #D73A49">%</span><span style="color: #005CC5">3</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (alive){</span></span>
<span class="line"><span style="color: #24292E">        finish.</span><span style="color: #6F42C1">arrive_and_wait</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 到达终点，等待其他选手</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        finish.</span><span style="color: #6F42C1">arrive_and_drop</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 选手掉队，直接结束</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">break</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">bool</span><span style="color: #24292E"> </span><span style="color: #6F42C1">is_alive</span><span style="color: #24292E">() </span><span style="color: #D73A49">const</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> alive;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">bool</span><span style="color: #24292E"> alive </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">;</span><span style="color: #6A737D"> // 选手是否存活</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">participant</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> participants </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">    {</span><span style="color: #032F62">"Alice"</span><span style="color: #24292E">}, {</span><span style="color: #032F62">"Bob"</span><span style="color: #24292E">}, {</span><span style="color: #032F62">"Charlie"</span><span style="color: #24292E">}, {</span><span style="color: #032F62">"Diana"</span><span style="color: #24292E">}, {</span><span style="color: #032F62">"Eve"</span><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> participant_count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> participants.</span><span style="color: #6F42C1">size</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> round </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #6A737D">  // barrier每轮结束时的回调函数</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> on_complete </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [</span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">participants</span><span style="color: #24292E">, </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">round</span><span style="color: #24292E">](){</span></span>
<span class="line"><span style="color: #24292E">    round</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"第"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> round </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"轮幸存者:"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">int</span><span style="color: #24292E"> count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">auto</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> p : participants) {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (p.</span><span style="color: #6F42C1">is_alive</span><span style="color: #24292E">()) {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> p.name </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">" "</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">        count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (count</span><span style="color: #D73A49">==</span><span style="color: #005CC5">0</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"没有幸存者"</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::barrier </span><span style="color: #6F42C1">finish</span><span style="color: #24292E">(participant_count, on_complete);</span><span style="color: #6A737D"> // 参赛者数量为初始值，oncomplete为每轮的回调</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> threads;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">auto</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">p: participants) {</span></span>
<span class="line"><span style="color: #24292E">    threads.</span><span style="color: #6F42C1">emplace_back</span><span style="color: #24292E">([</span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">p</span><span style="color: #24292E">, </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">finish</span><span style="color: #24292E">](){p.</span><span style="color: #6F42C1">run</span><span style="color: #24292E">(finish);});</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">auto</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">thread : threads) {</span></span>
<span class="line"><span style="color: #24292E">    thread.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 等待所有线程结束</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p><strong>注：对计数器进行-n操作时，传入的n的值不能大于当前计数值，否则会导致未定义错误</strong></p>
<h2 id="原子操作">原子操作</h2>
<p>原子操作是不能被分割或中断的操作，其他线程只能看到开始与结束的状态</p>
<h3 id="类型">类型</h3>
<ul>
<li>Load 加载</li>
<li>Store 存储</li>
<li>Read Modify Write 读取-修改-写入（RMW）</li>
</ul>
<h3 id="atomic_flag">atomic_flag</h3>
<p>它只有true和false两个值，true表示标志被设置，false表示标志被清除</p>
<p>初始化可以使用<code>ATOMIC_FLAG_INIT</code>宏，也可以使用默认构造函数（C++20后）</p>
<ul>
<li><p>clear()：清除标志，是一个原子写操作，函数有一个参数<code>memory_order</code>，指定内存顺序，默认为memory
order sequentially consistent</p></li>
<li><p>test_and_set()：将标志设置为true，并返回原有值，是一个RMW操作</p></li>
</ul>
<p>（以下为C++20新增）</p>
<ul>
<li>test()：读取数据</li>
<li>wait(oldvalue)：等待条件达成</li>
<li>notify_one()：通知其中一个线程结束等待</li>
<li>notify_all()：通知所有线程结束等待</li>
</ul>
<h3 id="自旋锁">自旋锁</h3>
<p>自旋：持续监控变量以等待发生变化的过程</p>
<p>自旋锁消耗资源较高，常用于临界区代码耗时很少的场合</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">SpinLock</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">while</span><span style="color: #24292E"> (flag.</span><span style="color: #6F42C1">test_and_set</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::memory_order_acquire)){}</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">unlock</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">        flag.</span><span style="color: #6F42C1">clear</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::memory_order_release);</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::atomic_flag flag{ATOMIC_FLAG_INIT};</span></span>
<span class="line"><span style="color: #24292E">};</span></span></code></pre></div></div></figure>
<p>例：</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;atomic&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;assert.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">SpinLock</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">while</span><span style="color: #24292E"> (flag.</span><span style="color: #6F42C1">test_and_set</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::memory_order_acquire)){}</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">unlock</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">        flag.</span><span style="color: #6F42C1">clear</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::memory_order_release);</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::atomic_flag flag{ATOMIC_FLAG_INIT};</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  SpinLock spin;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> inc </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">](){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i</span><span style="color: #D73A49">&lt;</span><span style="color: #005CC5">1000</span><span style="color: #24292E">;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">SpinLock</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(spin);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">++</span><span style="color: #24292E">count;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">t1</span><span style="color: #24292E">(inc);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">t2</span><span style="color: #24292E">(inc);</span></span>
<span class="line"><span style="color: #24292E">  t1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  t2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"count = "</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> count </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>这里由于自旋锁包含lock与unlock函数，符合C++中的基本锁类型，故可以使用lock_guard自动加锁解锁</p>
<h3 id="例-1">例</h3>
<p>实现了一个一次生产者与消费者的模拟</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;atomic&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;assert.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">struct</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Channel</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">getData</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"[Consumer] wait for data ready</span><span style="color: #005CC5">\n</span><span style="color: #032F62">"</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    dataReady.</span><span style="color: #6F42C1">wait</span><span style="color: #24292E">(</span><span style="color: #005CC5">false</span><span style="color: #24292E">);</span><span style="color: #6A737D"> // 等待数据准备好</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">"[Consumer] data is:"</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">data</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    dataReady.</span><span style="color: #6F42C1">clear</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">setData</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">string</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">v</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">(</span><span style="color: #005CC5">2000</span><span style="color: #24292E">));</span><span style="color: #6A737D"> // 模拟数据准备时间</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"'[Producer] write data</span><span style="color: #005CC5">\n</span><span style="color: #032F62">"</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    data </span><span style="color: #D73A49">=</span><span style="color: #24292E"> v;</span></span>
<span class="line"><span style="color: #24292E">    dataReady.</span><span style="color: #6F42C1">test_and_set</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    dataReady.</span><span style="color: #6F42C1">notify_one</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::atomic_flag dataReady </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ATOMIC_FLAG_INIT;</span><span style="color: #6A737D"> // 用于标记数据是否准备好</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::string data;</span><span style="color: #6A737D"> // 存储数据</span></span>
<span class="line"><span style="color: #24292E">  </span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  Channel channel;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">consumer</span><span style="color: #24292E">(</span><span style="color: #6F42C1">Channel</span><span style="color: #24292E">::getData, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">channel);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">producer</span><span style="color: #24292E">(</span><span style="color: #6F42C1">Channel</span><span style="color: #24292E">::setData, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">channel, </span><span style="color: #032F62">"Hello, World!"</span><span style="color: #24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  consumer.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  producer.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h3 id="特化版本">特化版本</h3>
<p>atomic除了主模板还有针对指针、智能指针与数据类型的特化版本</p>
<p><img src="并行编程/image-20250731104420865.png" alt="atomic" style="zoom:67%;"></p>
<p>其中主模板中的T要求是可平凡拷贝的</p>
<h3 id="有无锁的判断">有无锁的判断</h3>
<p>我们可以通过atomic模板提供的<code>is_lock_free()</code>函数判断有无锁，若无锁（通过CPU的原子指令）则函数返回true，否则返回false</p>
<ul>
<li>基本类型和指针都是无锁的</li>
<li>自定义类型与类型大小与对齐有关：类型大小是<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.279ex" height="1.528ex" role="img" focusable="false" viewBox="0 -675.5 1007.3 675.5"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g></g></g></svg></mjx-container></span>且小于最大对齐数（16字节）</li>
</ul>
<h3 id="主要的原子操作">主要的原子操作</h3>
<p><strong>加载操作：</strong>用于原子地获得当前变量的值</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #6F42C1">load</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order</span><span style="color: #24292E"> </span><span style="color: #E36209">order</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order_seq_cst</span><span style="color: #24292E">) </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">noexcept</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">operator</span><span style="color: #24292E"> </span><span style="color: #6F42C1">T</span><span style="color: #24292E">() </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">noexcept</span><span style="color: #24292E">;</span></span></code></pre></div></div></figure>
<p><strong>存储操作：</strong>用于将变量原子地修改为要更新的值</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">store</span><span style="color: #24292E">(</span><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #E36209">desired</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order</span><span style="color: #24292E"> </span><span style="color: #E36209">order</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order_seq_cst</span><span style="color: #24292E">) </span><span style="color: #D73A49">noexcept</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #D73A49">operator</span><span style="color: #6F42C1">=</span><span style="color: #24292E">(</span><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #E36209">desired</span><span style="color: #24292E">) </span><span style="color: #D73A49">noexcept</span><span style="color: #24292E">;</span></span></code></pre></div></div></figure>
<p><strong>CAS（比较与交换函数）：</strong></p>
<p>通过compare_exchange函数完成</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">bool</span><span style="color: #24292E"> </span><span style="color: #6F42C1">compare_exchange_weak</span><span style="color: #24292E">(</span><span style="color: #6F42C1">T</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">expected</span><span style="color: #24292E">, </span><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #E36209">desired</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order</span><span style="color: #24292E"> </span><span style="color: #E36209">success</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order</span><span style="color: #24292E"> </span><span style="color: #E36209">failure</span><span style="color: #24292E">) </span><span style="color: #D73A49">noexcept</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">bool</span><span style="color: #24292E"> </span><span style="color: #6F42C1">compare_exchange_strong</span><span style="color: #24292E">(</span><span style="color: #6F42C1">T</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">expected</span><span style="color: #24292E">, </span><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #E36209">desired</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order</span><span style="color: #24292E"> </span><span style="color: #E36209">success</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order</span><span style="color: #24292E"> </span><span style="color: #E36209">failure</span><span style="color: #24292E">) </span><span style="color: #D73A49">noexcept</span><span style="color: #24292E">;</span></span></code></pre></div></div></figure>
<p>符合条件的CAS会直接使用CPU硬件指令来实现</p>
<p>其中weak版可能有虚假失败的情况</p>
<p><strong>例：CAS循环模式</strong></p>
<p>CAS是实现无锁算法的重要方式，经常使用CAS循环实现对原子值更改</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">fetch_multiply</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">atomic</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">int</span><span style="color: #24292E">&gt; </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">value</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">multiplier</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">int</span><span style="color: #24292E"> oldValue </span><span style="color: #D73A49">=</span><span style="color: #24292E"> value.</span><span style="color: #6F42C1">load</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">int</span><span style="color: #24292E"> desire;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">do</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        desired </span><span style="color: #D73A49">=</span><span style="color: #24292E"> oldValue</span><span style="color: #D73A49">*</span><span style="color: #24292E">multiplier;</span></span>
<span class="line"><span style="color: #24292E">    }</span><span style="color: #D73A49">while</span><span style="color: #24292E">(</span><span style="color: #D73A49">!</span><span style="color: #24292E">value.</span><span style="color: #6F42C1">compare_exchange_strong</span><span style="color: #24292E">(oldValuem desired));</span></span>
<span class="line"><span style="color: #24292E">    </span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> oldValue;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>原理：加载当前值到oldValue，使用其来计算乘积并存储到本地变量desire，调用compare_exchange以原子方式更新value</p>
<p>若原value等于oldValue，说明没有并发线程修改过value，则更新为desired</p>
<p>若不等与则说明value被其他线程修改，那么将oldValue的值更新为当前value重试</p>
<h3 id="例使用atomic和cas实现无锁堆栈">例：使用atomic和CAS实现无锁堆栈</h3>
<p>在多线程模式下，将新节点的next指向原节点与将head节点指向新节点是两个独立操作，其中第二步的前提是链表头部节点没有变化</p>
<p>此时另一个线程的操作可能会导致链表头部发生变化</p>
<p><img src="并行编程/image-20250731135640991.png" alt="例1" style="zoom:67%;"></p>
<p>如此时节点A向堆栈push了一个新节点A</p>
<p><img src="并行编程/image-20250731135804450.png" alt="例2" style="zoom:67%;"></p>
<p>此时另一个线程又向堆栈push了一个新节点B，head指向了B</p>
<p>若第一个线程还将head更新为节点A，则会将节点B孤立</p>
<p><img src="并行编程/image-20250731140345785.png" alt="例3" style="zoom:67%;"></p>
<p>此时我们在compare_exchange函数中将A与B节点的next节点进行比较，若相等，说明头部没有变化，那么可以将A作为新的节点，将head指向A</p>
<p>否则说明已经发生变化，就将A的next值更新为head当前值，并更新head</p>
<p>pop操作更简单，将head当前值存储在局部变量中，再把其next与当前值进行比较，若相等则说明头部未改变，将head更新为头节点next值，否则说明发生变化，将局部变量更新为head当前值，继续循环</p>
<figure class="shiki c++"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;atomic&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;memory&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;syncstream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">template</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">typename</span><span style="color: #24292E"> </span><span style="color: #6F42C1">T</span><span style="color: #24292E">&gt;</span></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">struct</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Node</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">    T data;</span></span>
<span class="line"><span style="color: #24292E">    Node</span><span style="color: #D73A49">*</span><span style="color: #24292E"> next </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">nullptr</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">Node</span><span style="color: #24292E">(</span><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #E36209">d</span><span style="color: #24292E">):</span><span style="color: #6F42C1">data</span><span style="color: #24292E">(d){}</span></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::atomic</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">Node</span><span style="color: #D73A49">*&gt;</span><span style="color: #24292E"> head;</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #24292E">() </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">default</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">) </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">delete</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #D73A49">operator</span><span style="color: #6F42C1">=</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">) </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">delete</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">push</span><span style="color: #24292E">(</span><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #E36209">val</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E">newNode </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Node</span><span style="color: #24292E">(val);</span></span>
<span class="line"><span style="color: #6A737D">    //std::shared_ptr&lt;Node&gt; newNode = std::make_shared&lt;Node&gt;(val);</span></span>
<span class="line"><span style="color: #24292E">    newNode-&gt;next </span><span style="color: #D73A49">=</span><span style="color: #24292E"> head.</span><span style="color: #6F42C1">load</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">while</span><span style="color: #24292E">(</span><span style="color: #D73A49">!</span><span style="color: #24292E">head.</span><span style="color: #6F42C1">compare_exchange_strong</span><span style="color: #24292E">(newNode-&gt;next, newNode));</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout) </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">" Pushed: "</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> val </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"</span><span style="color: #005CC5">\n</span><span style="color: #032F62">"</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">bool</span><span style="color: #24292E"> </span><span style="color: #6F42C1">pop</span><span style="color: #24292E">(</span><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">result</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    Node</span><span style="color: #D73A49">*</span><span style="color: #24292E"> oldHead </span><span style="color: #D73A49">=</span><span style="color: #24292E"> head.</span><span style="color: #6F42C1">load</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">do</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (oldHead</span><span style="color: #D73A49">==</span><span style="color: #005CC5">nullptr</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout)</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">" Stack is empty, cannot pop.</span><span style="color: #005CC5">\n</span><span style="color: #032F62">"</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">false</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span><span style="color: #D73A49">while</span><span style="color: #24292E">(oldHead</span><span style="color: #D73A49">&amp;&amp;!</span><span style="color: #24292E">head.</span><span style="color: #6F42C1">compare_exchange_strong</span><span style="color: #24292E">(oldHead, oldHead-&gt;next));</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (oldHead){</span></span>
<span class="line"><span style="color: #24292E">      result </span><span style="color: #D73A49">=</span><span style="color: #24292E"> oldHead-&gt;data;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout)</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">" Popped: "</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> result </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">"</span><span style="color: #005CC5">\n</span><span style="color: #032F62">"</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">else</span><span style="color: #24292E"> </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">false</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">pushItems</span><span style="color: #24292E">(</span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">int</span><span style="color: #24292E">&gt; </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">stack</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">start</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">end</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> start; i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">end;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    stack.</span><span style="color: #6F42C1">push</span><span style="color: #24292E">(i);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">(</span><span style="color: #005CC5">50</span><span style="color: #24292E">));</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">popItems</span><span style="color: #24292E">(</span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">int</span><span style="color: #24292E">&gt; </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">stack</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">count</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> value;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">count;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    stack.</span><span style="color: #6F42C1">pop</span><span style="color: #24292E">(value);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">(</span><span style="color: #005CC5">30</span><span style="color: #24292E">));</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  LockFreeStack</span><span style="color: #D73A49">&lt;int&gt;</span><span style="color: #24292E"> stack;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">t1</span><span style="color: #24292E">(pushItems, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(stack), </span><span style="color: #005CC5">1</span><span style="color: #24292E">, </span><span style="color: #005CC5">10</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">t2</span><span style="color: #24292E">(popItems, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(stack),</span><span style="color: #005CC5">7</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">t3</span><span style="color: #24292E">(pushItems, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(stack), </span><span style="color: #005CC5">10</span><span style="color: #24292E">, </span><span style="color: #005CC5">20</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">t4</span><span style="color: #24292E">(popItems, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(stack),</span><span style="color: #005CC5">7</span><span style="color: #24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  t1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  t2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  t3.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  t4.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>（这里shared_ptr不是平凡可复制类，故改为了裸指针，同时无法解决ABA问题）</p>
<h2 id="内存模型">内存模型</h2>
<h3 id="顺序一致性模型">顺序一致性模型</h3>
<p>程序按照代码编写顺序执行，并且所有线程都看到相同顺序的模型</p>
<p>枚举值名称为<code>memory_order_seq_cst</code></p>
<p>该模型顺序简单，不易出错，但可能无法充分使用系统和硬件的性能优化</p>
<h3 id="relaxed模型">Relaxed模型</h3>
<p>relaxed模型下，不对内存顺序作约束，可能出现顺序一致性模型中不会出现的结果</p>
<p>CPU和内存之间会有多级缓存</p>
<p>缓存、编译器的优化都可能改变同一线程不同语句的执行顺序</p>
<p>枚举值名称为<code>memory_order_relaxed</code></p>
<p>relaxed模型中，线程执行代码对值的更改首先保存在缓存中，当代码执行完毕，才会更新内存中的值</p>
<p><img src="并行编程/image-20250731161214818.png" alt="relaxed" style="zoom: 50%;"></p>
<p>如该例子中，线程1与2执行了①和③代码，将缓存中的a与b修改为1，再执行②和④代码，读取内存中的a与b都为0</p>
<p>在代码执行完毕后，缓存中的值才会修改到内存中</p>
<h3 id="acquirerelease模型">Acquire/Release模型</h3>
<p>枚举值有如下三种：</p>
<ul>
<li><code>memory_order_acquire</code></li>
<li><code>memory_order_release</code></li>
<li><code>memory_order_acq_rel</code></li>
</ul>
<p>通常在原子操作中，</p>
<p>写入数据使用release，即将值写入后，将缓存中的数据发布到内存中，包括之前修改过的其他变量</p>
<p>获取数据使用acquire，即将值从内存中更新到缓存，并读取这个值</p>
<p>对于先加载在修改的，使用<code>acq_rel</code></p>
<p>在mutex锁中，<code>mutex.lock()</code>与acquire语义是等价的，<code>mutex.unlock()</code>与release语义是等价的，两者之间是临界区</p>
<p>临界区内的代码可以互相调换顺序，但不能移出临界区外</p>
<p>临界区上方的代码可以进入临界区，但不能移出临界区下方</p>
<p>临界区下方的代码可以进入临界区，但不能移出临界区上方</p>
<p>于此对应的<code>memory_order_acquire</code>与<code>memory_order_release</code>遵循同样的原则</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/C-C/" rel="tag"># C/C++</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/C++/%E5%86%85%E5%AD%98%E5%88%86%E5%8C%BA%E6%A8%A1%E5%9E%8B/" rel="prev" title="【C++】内存分区模型">
                  <i class="fa fa-angle-left"></i> 【C++】内存分区模型
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/C++/Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="next" title="【C++】Lambda表达式">
                  【C++】Lambda表达式 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">IzayoiSakuye</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<!-- hexo injector body_end start -->
<script src="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.js"></script>

  <script>
  const CODE_CONFIG = {
    beautify: true,
    highlightCopy: true,
    highlightLang: true,
    highlightHeightLimit: undefined,
    isHighlightShrink: false,
    copy: {
      success: 'Copy Success',
      error: 'Copy Error',
      noSupport: 'Browser Not Support',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body>
</html>
