<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"izayoisakuye.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="红魔咖啡馆">
<meta property="og:url" content="https://izayoisakuye.github.io/list/page/7/index.html">
<meta property="og:site_name" content="红魔咖啡馆">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="IzayoiSakuye">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://izayoisakuye.github.io/list/page/7/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>红魔咖啡馆</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#90a4ae;--hl-bg:#f6f8fa;--hltools-bg:#e6ebf1;--hltools-color:#90a4ae;--hlnumber-bg:#f6f8fa;--hlnumber-color:rgba(144,164,174,0.5);--hlscrollbar-bg:#dce4eb;--hlexpand-bg:linear-gradient(180deg,rgba(246,248,250,0.1),rgba(246,248,250,0.9))}</style><!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">红魔咖啡馆</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">头发越掉越多，头发越掉越少</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://izayoisakuye.github.io/CS61B/Lec2-Java%20Basic%201/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="IzayoiSakuye">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="红魔咖啡馆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/CS61B/Lec2-Java%20Basic%201/" class="post-title-link" itemprop="url">【CS61B】Lec2-Java Basic 1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-07-31 17:37:16 / 修改时间：17:42:42" itemprop="dateCreated datePublished" datetime="2025-07-31T17:37:16+08:00">2025-07-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS61B/" itemprop="url" rel="index"><span itemprop="name">CS61B</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>936</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="java-basic-1">Java Basic 1</h1>
<h2 id="关于类">关于类</h2>
<ul>
<li>每个方法(method)都与某些类相关</li>
<li>执行一个类需要主(main)方法，但不是所有类都有主方法</li>
</ul>
<p>e.g. 创建一个狗类</p>
<figure class="shiki java"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Dog</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> size;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #D73A49">static</span><span style="color: #24292E"> String binmen </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;Canis&quot;</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6A737D">// 构造函数</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Dog</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">s</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">        size </span><span style="color: #D73A49">=</span><span style="color: #24292E"> s;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">makeNoise</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (size </span><span style="color: #D73A49">&gt;</span><span style="color: #005CC5">20</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">            System.out.</span><span style="color: #6F42C1">println</span><span style="color: #24292E">(</span><span style="color: #032F62">&quot;bark&quot;</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">        }</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">else</span><span style="color: #24292E"> </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (size </span><span style="color: #D73A49">&lt;</span><span style="color: #005CC5">10</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">            System.out.</span><span style="color: #6F42C1">println</span><span style="color: #24292E">(</span><span style="color: #032F62">&quot;bark!&quot;</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">        }</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">            System.out.</span><span style="color: #6F42C1">println</span><span style="color: #24292E">(</span><span style="color: #032F62">&quot;bark!!&quot;</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">        }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">public</span><span style="color: #24292E"> Dog </span><span style="color: #6F42C1">maxDog</span><span style="color: #24292E">(Dog </span><span style="color: #E36209">otherDog</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">        System.out.</span><span style="color: #6F42C1">println</span><span style="color: #24292E">(</span><span style="color: #032F62">&quot;Being called&quot;</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #005CC5">this</span><span style="color: #24292E">.size </span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> otherDog.size){</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">this</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">        }</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> otherDog;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>(Dog.java)</p>
<figure class="shiki java"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">DogLauncher</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #D73A49">static</span><span style="color: #24292E"> </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(</span><span style="color: #D73A49">String</span><span style="color: #24292E">[] </span><span style="color: #E36209">args</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">        Dog maya </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Dog</span><span style="color: #24292E">(</span><span style="color: #005CC5">9</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">        maya.</span><span style="color: #6F42C1">makeNoise</span><span style="color: #24292E">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        Dog hugeDog </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Dog</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">        Dog largerDog </span><span style="color: #D73A49">=</span><span style="color: #24292E"> maya.</span><span style="color: #6F42C1">maxDog</span><span style="color: #24292E">(hugeDog);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>DogLauncher,java文件</p>
<p>（将dog类放入Dog.java文件，主方法放入DogLauncher.java文件，调用主方法时从Dog类调用makeNoise方法）</p>
<p>该Dog类包含如下：</p>
<ul>
<li>实例变量：定义一个示例的多个属性</li>
<li>构造函数：定义如何实例化一个类</li>
<li>非静态方法（实例方法）：由特定实例调用的方法，不需要加static关键字</li>
</ul>
<h2 id="array">Array</h2>
<p>一种ADT的受限版本</p>
<ul>
<li>创建数组时需要声明大大小</li>
<li>大小不能更改</li>
<li>所有元素类型需要相同</li>
<li>没有方法</li>
</ul>
<h2 id="map">Map</h2>
<p>map是键值对的集合，每个键都保证是唯一的</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://izayoisakuye.github.io/CS61B/Lab3-Debugging2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="IzayoiSakuye">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="红魔咖啡馆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/CS61B/Lab3-Debugging2/" class="post-title-link" itemprop="url">【CS61B】Lab3-Debugging2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-07-31 17:37:16 / 修改时间：17:42:50" itemprop="dateCreated datePublished" datetime="2025-07-31T17:37:16+08:00">2025-07-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS61B/" itemprop="url" rel="index"><span itemprop="name">CS61B</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="lab3-debugging2">Lab3-Debugging2</h1>
<p>给予项目Adventure来进行调试并修改代码</p>
<h2 id="学会阅读堆栈追踪">学会阅读堆栈追踪</h2>
<p>运行主方法后，会在某个位置抛出异常：</p>
<img src="/CS61B/Lab3-Debugging2/image-20250711184407241.png" class="" title="error1">
<p>一般作物类型会在报错第一行出现，如该处出现错误：<code>NullPointerException</code></p>
<p>对于这一类的异常，java也会抛出解释，这里指的是<code>this.input</code>为<code>null</code>，因此我们不能调用方法</p>
<p>下方表示程序引发错误时的方法调用序列：列表中的第一行是错误发生的位置，其下一行表示调用抛出错误方法的代码行，依此类推。</p>
<p>可以点击蓝色文本追踪到对应文件和方法行处</p>
<p><strong>注意：按照执行顺序，堆栈追踪第一行错误显示的应为发生错误时最后调用的方法，可以根据此来判断bug的位置等</strong></p>
<h2 id="debug-beecountingstage">Debug <code>BeeCountingStage</code></h2>
<p>根据错误信息发现，错误应该出现在<code>BeeCountingStage</code>中，我们跳入该类进行检查</p>
<p>此处抛出空指针的原因是<code>this.input</code>还是空指针，未被初始化，因此我们需要对input初始化</p>
<p>可以发现声明变量处代码为<code>private List&lt;String&gt; input;</code>，再看构造函数发现这两处均为对input初始化，故我们在构造函数中添加初始化代码<code>this.input = new ArrayList&lt;&gt;(0);</code>即可解决问题</p>
<p>第二个问题还是出现在该类中，错误类型为<code>IndexOutOfBoundsError</code></p>
<p>经检查，是<code>sumInput</code>函数中，for循环的终止条件多了等号，导致多访问了一位没有定义的位置</p>
<h2 id="debug-speciesliststage">Debug <code>SpeciesListStage</code></h2>
<p>错误类型为<code>/ by zero</code>，跟踪到函数<code>arraySimilarity</code></p>
<p>发现在return处计算相似度时，若询问结束，还会传入一次空字符串，即listOne的size为0，导致除以0的错误发生</p>
<p>所以若传入的是空字符串，我们需要特定的返回0</p>
<h2 id="debug-palindromestage">Debug <code>PalindromeStage</code></h2>
<p>错误类型：<code>Index 3 out of bounds for length 3</code></p>
<p>我们进入类<code>PalindromeStage</code>，根据IDEA的warning提示，来到函数<code>digitsToIntList</code></p>
<p>容易发现第一个bug出在for循环中，对计数器i的操作有误，此处为反向遍历，i应该自减</p>
<p>第二个bug也在for循环中，对于s的下标，最后一位应该是<code>s.length()-1</code>，第一位应该是0，这样避免charAt方法出现异常</p>
<h2 id="debug-machinestage">Debug <code>MachineStage</code></h2>
<p>该机器的作用是将输入的两个等长数列的每位进行比较，选出每个下标中更大的那一位，并组成一个新数组并求和，但目前结果有误</p>
<p>第一个问题出在<code>mysteryMax</code>处，这里对b-a获得了两个掩码</p>
<ul>
<li>当 <code>b - a &gt;= 0</code> 时，<code>w</code> 为 0，</li>
<li>当 <code>b - a &lt; 0</code> 时，<code>w</code> 为 -1（即全 1）</li>
</ul>
<p>然后z为w的取反，获得的是相反结果，max的计算等价于</p>
<ul>
<li>若
<code>b &gt;= a</code>：<code>w = 0</code>，<code>z = -1</code>，结果为
<code>(b &amp; 0) | (a &amp; -1)</code>，返回 <code>a</code></li>
<li>若
<code>b &lt; a</code>：<code>w = -1</code>，<code>z = 0</code>，结果为
<code>(b &amp; -1) | (a &amp; 0)</code>，返回 <code>b</code></li>
</ul>
<p>因此这里返回的是最小值，而非最大值，应该将z与w对调</p>
<p>第二个问题出在<code>arraySum</code>处，这里要求数组最大值之和</p>
<p>但代码行<code>sum = sum + mysteryAdd(sum, x[i]);</code>明显多加了一个sum，因为<code>mysteryAdd</code>中已经执行了相加操作并返回和，应该删除一个</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://izayoisakuye.github.io/CS61B/Lab2-Debugging/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="IzayoiSakuye">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="红魔咖啡馆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/CS61B/Lab2-Debugging/" class="post-title-link" itemprop="url">【CS61B】Lab2-Debugging</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-07-31 17:37:16 / 修改时间：17:43:06" itemprop="dateCreated datePublished" datetime="2025-07-31T17:37:16+08:00">2025-07-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS61B/" itemprop="url" rel="index"><span itemprop="name">CS61B</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>208</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="lab2-debugging">Lab2-Debugging</h1>
<p>我们需要学会在idea中使用交互式的debug工具</p>
<p>在行号上点击以设置断点，当debug时，运行到断点处便会停止</p>
<p>设置断点后，点击debug按钮开始进行debug</p>
<p>此时在控制台处会有debugger窗口，在左侧可以看到当前的所有方法调用，在右侧可以看到程序当前点的实例变量值（它们也会在编辑器中以灰色文本显示）。对于类的实例，可以点击下拉菜单来展开它们并查看它们的字段。</p>
<p>有一些按钮可以进行操作：</p>
<img src="/CS61B/Lab2-Debugging/image-20250709210158266.png" class="" title="操作按钮">

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://izayoisakuye.github.io/C++/Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="IzayoiSakuye">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="红魔咖啡馆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/C++/Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="post-title-link" itemprop="url">【C++】Lambda表达式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-07-31 17:33:30 / 修改时间：17:33:45" itemprop="dateCreated datePublished" datetime="2025-07-31T17:33:30+08:00">2025-07-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C-C/" itemprop="url" rel="index"><span itemprop="name">C/C++</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>608</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="lambda表达式">Lambda表达式</h1>
<p>用于快速定义一个匿名函数对象（闭包）</p>
<p>语法：</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #24292E">[捕获变量](参数列表) 可选限定符-&gt;</span><span style="color: #D73A49">返回类型{</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">代码</span></span>
<span class="line"><span style="color: #D73A49">}</span></span></code></pre></div></div></figure>
<h2 id="原理">原理</h2>
<p>实际上是函数对象的一种快速定义方式</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> x </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">7</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">float</span><span style="color: #24292E"> y </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">3.0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">struct</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">int</span><span style="color: #24292E"> _x;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">float</span><span style="color: #24292E"> y;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">float</span><span style="color: #24292E"> </span><span style="color: #D73A49">operator</span><span style="color: #6F42C1">()</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">,</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">b</span><span style="color: #24292E">) </span><span style="color: #D73A49">const</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> _x </span><span style="color: #D73A49">*</span><span style="color: #24292E">_ y</span><span style="color: #D73A49">+</span><span style="color: #24292E">a</span><span style="color: #D73A49">*</span><span style="color: #24292E">b;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">}p{x,y};</span></span></code></pre></div></div></figure>
<h2 id="变量捕获">变量捕获</h2>
<h3 id="按值捕获">按值捕获</h3>
<p>lambda中的成员变量是外部变量的拷贝</p>
<p>外部更改不会改变内部的变量</p>
<p>此时lambda对应的函数调用运算符默认是const函数，函数内部不能修改按值捕获的变量，也不能调用非常量函数（或者可以在lambda函数后加上mutable限制符）</p>
<h3 id="按引用捕获">按引用捕获</h3>
<p>在中括号中变量前添加引用运算符</p>
<p>外部更改会改变内部的变量</p>
<p>若所引用的变量已经失效，则会报错或访问无效数据</p>
<h3 id="默认捕获方式">默认捕获方式</h3>
<ul>
<li><p>[=]：默认按值捕获</p></li>
<li><p>[&amp;]：默认按引用捕获</p></li>
<li><p>[this]/[*this]：在类中按引用/按值捕获，可以访问类成员</p></li>
</ul>
<p>此时也可以添加特例，添加显式捕获的变量</p>
<p>但默认捕获和显式捕获不能相同</p>
<p>其中[=], [&amp;], [&amp;, this], [=, *this], [=,
this]这几种捕获方式，this都是按引用捕获的</p>
<h2 id="变量使用">变量使用</h2>
<p>除了可以使用捕获变量，还可以使用自定义变量，外层中的静态变量与全局变量</p>
<h2 id="泛型lambda">泛型lambda</h2>
<p>在参数类型中使用auto即可实现泛型lambda，相当于套了类模板</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://izayoisakuye.github.io/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="IzayoiSakuye">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="红魔咖啡馆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/C++/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" class="post-title-link" itemprop="url">【C++】并发编程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-07-31 17:31:56 / 修改时间：17:32:26" itemprop="dateCreated datePublished" datetime="2025-07-31T17:31:56+08:00">2025-07-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C-C/" itemprop="url" rel="index"><span itemprop="name">C/C++</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="并发编程">并发编程</h1>
<h2 id="多个任务的执行方式">多个任务的执行方式</h2>
<ul>
<li>顺序：一个接着一个</li>
<li>并行：同一时间执行多个任务（并行是并发的子集）</li>
<li>并发：多个任务在同一个重叠时间段执行</li>
</ul>
<h2 id="openmp">OpenMP</h2>
<p>使用<code>#prgma</code>预处理指令可以将代码转变为并行处理</p>
<p>此时需要在编译时添加参数<code>-fopenmp</code></p>
<p>e.g. 计算<span class="math inline">\(\pi\)</span></p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cal</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">long</span><span style="color: #24292E"> </span><span style="color: #E36209">num_steps</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> step </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1.0</span><span style="color: #D73A49">/</span><span style="color: #24292E">num_steps;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> sum </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0.0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">#pragma</span><span style="color: #24292E"> </span><span style="color: #6F42C1">omp</span><span style="color: #24292E"> </span><span style="color: #6F42C1">parallel</span><span style="color: #24292E"> </span><span style="color: #6F42C1">for</span><span style="color: #24292E"> </span><span style="color: #6F42C1">reduction</span><span style="color: #24292E">(+:</span><span style="color: #6F42C1">sum</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">long</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">num_steps;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">double</span><span style="color: #24292E"> x </span><span style="color: #D73A49">=</span><span style="color: #24292E"> (i</span><span style="color: #D73A49">+</span><span style="color: #005CC5">0.5</span><span style="color: #24292E">)</span><span style="color: #D73A49">*</span><span style="color: #24292E">step;</span></span>
<span class="line"><span style="color: #24292E">    sum</span><span style="color: #D73A49">+=</span><span style="color: #005CC5">4.0</span><span style="color: #D73A49">/</span><span style="color: #24292E">(</span><span style="color: #005CC5">1.0</span><span style="color: #D73A49">+</span><span style="color: #24292E">x</span><span style="color: #D73A49">*</span><span style="color: #24292E">x);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> sum</span><span style="color: #D73A49">*</span><span style="color: #24292E">step;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cal</span><span style="color: #24292E">(</span><span style="color: #005CC5">10</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>其中第六行语句的意思：</p>
<ul>
<li><p><code>omp parallel for</code>表示将for循环每次循环转化为并行计算</p></li>
<li><p><code>reduction</code>表示用于reduce计算的变量与运算符</p></li>
<li><p>局部变量x在每个线程中修改，不影响其他线程</p></li>
<li><p>sum是共享对象，不能在并行线程中直接修改，否则导致数据竞争</p>
<p>sum需要reduce操作，其中reduction表明了需要reduce操作的变量与运算符</p></li>
</ul>
<h2 id="stl并行算法库">STL并行算法库</h2>
<p>使用<code>&lt;algorithm&gt;</code>与<code>&lt;numeric&gt;</code>库中的函数，可以简单实现并行</p>
<p>在支持并行的算法函数中，首个参数可以选择执行策略：</p>
<ul>
<li><code>std::execution::sequenced_policy</code>：顺序执行策略（实例：seq）</li>
<li><code>std::execution::parallel_policy</code>：并行执行策略（实例：par）</li>
<li><code>std::execution::parallel_unsequenced_policy</code>：多线程加向量化策略（实例：par_seq）</li>
</ul>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;algorithm&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;execution&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;vector&gt;</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> op </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [](</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">v</span><span style="color: #24292E">){</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> v </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;;</span><span style="color: #005CC5">\n</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">;};</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;int&gt;</span><span style="color: #24292E"> numbers{</span><span style="color: #005CC5">1</span><span style="color: #24292E">,</span><span style="color: #005CC5">2</span><span style="color: #24292E">,</span><span style="color: #005CC5">3</span><span style="color: #24292E">,</span><span style="color: #005CC5">4</span><span style="color: #24292E">,</span><span style="color: #005CC5">5</span><span style="color: #24292E">,</span><span style="color: #005CC5">6</span><span style="color: #24292E">,</span><span style="color: #005CC5">7</span><span style="color: #24292E">,</span><span style="color: #005CC5">8</span><span style="color: #24292E">,</span><span style="color: #005CC5">9</span><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;sequential for_each&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">for_each</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">execution</span><span style="color: #24292E">::seq, numbers.</span><span style="color: #6F42C1">begin</span><span style="color: #24292E">(), numbers.</span><span style="color: #6F42C1">end</span><span style="color: #24292E">(), op);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;parallel for_each&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">for_each</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">execution</span><span style="color: #24292E">::par, numbers.</span><span style="color: #6F42C1">begin</span><span style="color: #24292E">(), numbers.</span><span style="color: #6F42C1">end</span><span style="color: #24292E">(), op);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;parallel unseq for_each&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">for_each</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">execution</span><span style="color: #24292E">::par_unseq, numbers.</span><span style="color: #6F42C1">begin</span><span style="color: #24292E">(), numbers.</span><span style="color: #6F42C1">end</span><span style="color: #24292E">(), op);</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>以上没有对cout进行同步措施，会导致<strong>输出错误</strong></p>
<h2 id="线程">线程</h2>
<h3 id="线程与进程">线程与进程</h3>
<p>进程：程序执行过程，相互独立，操作系统为每一个进程分配一个执行控制块来控制进程</p>
<p>线程：进程中的执行过程，系统为每一个线程分配一个栈于线程控制块，线程间共享堆与全局数据</p>
<h3 id="创建线程">创建线程</h3>
<p>使用<code>&lt;thread&gt;</code>类创建线程</p>
<p><code>thread(F&amp;&amp; f, Args&amp;&amp;... args);</code></p>
<ul>
<li>第一个参数为线程的入口函数（线程函数），可以是各种可调用的对象</li>
<li>后面的Args为传递给可调用对象的实参</li>
<li>若第一个参数为非静态成员函数，则后面的第一个参数为调用这个成员函数的类对象地址</li>
</ul>
<p>thread的返回值会被忽略，故要使用按引用传递的参数，或存储在类对象的数据成员中</p>
<p>用该函数初始化后会创建一个新线程，执行线程函数</p>
<p>线程<strong>只能移动构造或移动赋值</strong>，防止多个线程对象代表一个执行线程</p>
<h3 id="join">.join()</h3>
<p>该函数会使得当前线程执行结束后等待其他线程回会合，避免出现提前结束导致出现错误</p>
<p>这种等待状态称为<strong>阻塞</strong>，若对应线程提前结束，则join函数也会直接返回</p>
<p>调用函数时，该线程必须是joinable的，意味着该线程必须是<strong>正在执行或执行完毕但未合并的线程</strong>，可以使用<code>.joinable()</code>判断是否可合并</p>
<p>不能被合并的情况：</p>
<ul>
<li>默认构造函数初始化的</li>
<li>join()完成的</li>
<li>detach()后的</li>
<li>被移动的</li>
</ul>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;array&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">greeting</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">idx</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">printf</span><span style="color: #24292E">(</span><span style="color: #032F62">&quot;Hello from thread </span><span style="color: #005CC5">%d\n</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">, idx);</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::array</span><span style="color: #D73A49">&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread, </span><span style="color: #005CC5">10</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> workers;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;i</span><span style="color: #D73A49">&lt;</span><span style="color: #005CC5">10</span><span style="color: #24292E">;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    workers[i] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">thread</span><span style="color: #24292E">(greeting, i);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">auto</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">workers:workers){</span></span>
<span class="line"><span style="color: #24292E">    workers.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #24292e">Hello from thread 0</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 1</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 2</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 3</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 4</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 5</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 6</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 7</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 8</span></span>
<span class="line"><span style="color: #24292e">Hello from thread 9</span></span></code></pre></div></div></figure>
<h3 id="fork-and-join">Fork and join</h3>
<p>可以使用线程实现并行</p>
<p>通过Fork and
join模式：把要执行的数据分成n份，由n个线程并行处理自己的那部分数据，再进行汇总，n可以根据cpu核心设置</p>
<p>实现简单，但对于复杂计算，相同数据处理时间不同，导致有些线程很早处理完毕，有的需要更长时间结束</p>
<blockquote>
<p>实现transform_reduce函数</p>
</blockquote>
<figure class="shiki C++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div><div class="code"><pre><code>#include<thread>
#include<vector>
#include<array>
#include<iostream>
template<typename Iter, typename UnaryOp, typename BinaryOp, typename Result>
void transform_reduce(Iter first, Iter last, UnaryOp transform, BinaryOp reduce, Result& res){
  for (auto it=first;it<last;it++){
    res = reduce(res, transform(*it));
  }
}

int main(){
  const int N = 1000000;
  std::vector<double> numbers;
  numbers.reserve(N);
  for (int i = 0; i < N; ++i) {
    numbers.push_back((double)i/N);
  }
  auto transform = [](double x) { return x * x; };
  auto reduce = [](double x, double y) { return x + y; };
  const int N_thraeds = 8;
  std::vector<std::thread> workers;
  std::array<double, N_thraeds> subResults={};
  for (int i = 0; i<N_thraeds; i++){
    auto low = numbers.begin()+i*numbers.size()/N_thraeds;
    auto high = numbers.begin()+(i+1)*numbers.size()/N_thraeds;
    workers.push_back(
        std::thread(
        transform_reduce<std::vector<double>::iterator,
        decltype(transform),
        decltype(reduce),double>,
        low, high, transform, reduce, std::ref(subResults[i])
      )
    );
  }
  double result = 0;
  for (int i = 0; i < N_thraeds; ++i) {
    workers[i].join();
    result = reduce(result,subResults[i]);
  }
  std::cout << "Result: " << result << std::endl;
  return 0;
}</code></pre></div></div></figure>
<h3 id="divide-and-conquer">Divide and conquer</h3>
<p>使用分治将一个任务分成两个小任务，由两个线程完成，然后小任务再分成两个小任务，创建两个线程完成，直到不能分解</p>
<p>另外需要设计一个阈值，当线程过多时就不再创建，而是使用同步计算</p>
<p>为了让各个线程任务饱满，可以采用一半采用同步调用，一半分给另一个线程</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;vector&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;array&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">template</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">typename</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Iter</span><span style="color: #24292E">, </span><span style="color: #D73A49">typename</span><span style="color: #24292E"> </span><span style="color: #6F42C1">UnaryOp</span><span style="color: #24292E">, </span><span style="color: #D73A49">typename</span><span style="color: #24292E"> </span><span style="color: #6F42C1">BinaryOp</span><span style="color: #24292E">, </span><span style="color: #D73A49">typename</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Result</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> MinDist </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">&gt;</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">transform_reduce</span><span style="color: #24292E">(</span><span style="color: #6F42C1">Iter</span><span style="color: #24292E"> </span><span style="color: #E36209">first</span><span style="color: #24292E">, </span><span style="color: #6F42C1">Iter</span><span style="color: #24292E"> </span><span style="color: #E36209">last</span><span style="color: #24292E">, </span><span style="color: #6F42C1">UnaryOp</span><span style="color: #24292E"> </span><span style="color: #E36209">transform</span><span style="color: #24292E">, </span><span style="color: #6F42C1">BinaryOp</span><span style="color: #24292E"> </span><span style="color: #E36209">reduce</span><span style="color: #24292E">, </span><span style="color: #6F42C1">Result</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">res</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> distance </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">distance</span><span style="color: #24292E">(first, last);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (distance</span><span style="color: #D73A49">==</span><span style="color: #005CC5">1</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    res </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">reduce</span><span style="color: #24292E">(res, </span><span style="color: #6F42C1">transform</span><span style="color: #24292E">(</span><span style="color: #D73A49">*</span><span style="color: #24292E">first));</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> half </span><span style="color: #D73A49">=</span><span style="color: #24292E"> distance </span><span style="color: #D73A49">/</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    Iter middle </span><span style="color: #D73A49">=</span><span style="color: #24292E"> first</span><span style="color: #D73A49">+</span><span style="color: #24292E">half;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    Result r_result </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    Result l_result </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">l_thread</span><span style="color: #24292E">(</span></span>
<span class="line"><span style="color: #24292E">      transform_reduce</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">Iter, UnaryOp, BinaryOp, Result</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">      first, middle, transform, reduce, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(l_result)</span></span>
<span class="line"><span style="color: #24292E">    );</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">r_thread</span><span style="color: #24292E">(</span></span>
<span class="line"><span style="color: #24292E">      transform_reduce</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">Iter, UnaryOp, BinaryOp, Result</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">      middle, last, transform, reduce, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(r_result)</span></span>
<span class="line"><span style="color: #24292E">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    l_thread.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    r_thread.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    res </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">reduce</span><span style="color: #24292E">(res, </span><span style="color: #6F42C1">reduce</span><span style="color: #24292E">(l_result, r_result));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="promise-future">promise &amp; future</h2>
<p>这两个类提供了线程之间简单的通信机制</p>
<p>通过promise来设置值或异常，通过future来获得值或异常</p>
<p>一对promise&amp;future共享一个shared
state（共享状态），是一个类对象，提供了在保证线程安全的情况下，设置和获取状态与结果的方法，使用shared_ptr指向该状态</p>
<p>常用于发送-接受模式中</p>
<h3 id="promise">promise</h3>
<p>promise类模板提供了按值、按引用传递数据，以及仅传递信号三种版本</p>
<p>对应的成员函数：</p>
<ul>
<li>promise()：构造函数，创建一个共享状态</li>
<li>promise(promise&amp;&amp;
x)：移动构造函数，将被移动对象x的共享状态转移过去</li>
<li>get_future()：创建一个future对象，使用promise中的共享状态，<strong>只能调用一次</strong></li>
<li>set_value()：设置共享状态中的值，并设置为就绪状态</li>
<li>set_exception()：设置共享状态的异常</li>
</ul>
<p><strong>注：为了保证一对一性，promise类删除了拷贝构造函数</strong></p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;future&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">compute_pi</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">long</span><span style="color: #24292E"> </span><span style="color: #E36209">num_steps</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">promise</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">double</span><span style="color: #24292E">&gt;</span><span style="color: #D73A49">&amp;&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">promise</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> step </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1.0</span><span style="color: #D73A49">/</span><span style="color: #24292E"> num_steps;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> sum </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0.0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E">(</span><span style="color: #D73A49">long</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> num_steps; </span><span style="color: #D73A49">++</span><span style="color: #24292E">i){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">double</span><span style="color: #24292E"> x </span><span style="color: #D73A49">=</span><span style="color: #24292E"> (i </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">0.5</span><span style="color: #24292E">) </span><span style="color: #D73A49">*</span><span style="color: #24292E"> step;</span></span>
<span class="line"><span style="color: #24292E">    sum </span><span style="color: #D73A49">+=</span><span style="color: #24292E"> </span><span style="color: #005CC5">4.0</span><span style="color: #24292E"> </span><span style="color: #D73A49">/</span><span style="color: #24292E"> (</span><span style="color: #005CC5">1.0</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> x </span><span style="color: #D73A49">*</span><span style="color: #24292E"> x);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  promise.</span><span style="color: #6F42C1">set_value</span><span style="color: #24292E">(sum </span><span style="color: #D73A49">*</span><span style="color: #24292E"> step);</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">display</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">future</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">double</span><span style="color: #24292E">&gt;</span><span style="color: #D73A49">&amp;&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">receiver</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> pi </span><span style="color: #D73A49">=</span><span style="color: #24292E"> receiver.</span><span style="color: #6F42C1">get</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;Computed value of Pi: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> pi </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N_steps </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">100000000</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::promise</span><span style="color: #D73A49">&lt;double&gt;</span><span style="color: #24292E"> promise;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> receiver </span><span style="color: #D73A49">=</span><span style="color: #24292E"> promise.</span><span style="color: #6F42C1">get_future</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 调用获得future对象后就没什么用了</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(compute_pi, N_steps, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">move</span><span style="color: #24292E">(promise));</span><span style="color: #6A737D"> // 将promose对象转换为xvalue，作为实参换入</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(display, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">move</span><span style="color: #24292E">(receiver));</span></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h3 id="future">future</h3>
<p>future中的方法主要用于获取状态与结果</p>
<ul>
<li>get()：获得结果，若对应结果没有处在就绪状态，那么这个调用会阻塞直到就绪</li>
<li>wait()：等待状态就绪，之后返回，此时调用get可以直接获得结果</li>
<li>wait_for()：等待指定时长，返回状态码</li>
<li>wait_until()：等待到指定时刻，返回状态码</li>
<li>share()：</li>
</ul>
<p>状态码包括：</p>
<ul>
<li>ready：共享状态就绪</li>
<li>timeout：超时</li>
<li>deferred：共享状态中有延缓执行的函数（显式请求中才会调用的函数）</li>
</ul>
<p>若需要让多个线程获得结果，需要shared_future，构建方法如下：</p>
<ul>
<li>定义对象，使用promise的get_future()作为初始化参数</li>
<li>在原有future上调用方法.share()，此时原有不再使用</li>
</ul>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;future&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;sstream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">compute_pi</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">long</span><span style="color: #24292E"> </span><span style="color: #E36209">num_steps</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">promise</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">double</span><span style="color: #24292E">&gt;</span><span style="color: #D73A49">&amp;&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">promise</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> step </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1.0</span><span style="color: #D73A49">/</span><span style="color: #24292E"> num_steps;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> sum </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0.0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E">(</span><span style="color: #D73A49">long</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> num_steps; </span><span style="color: #D73A49">++</span><span style="color: #24292E">i){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">double</span><span style="color: #24292E"> x </span><span style="color: #D73A49">=</span><span style="color: #24292E"> (i </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">0.5</span><span style="color: #24292E">) </span><span style="color: #D73A49">*</span><span style="color: #24292E"> step;</span></span>
<span class="line"><span style="color: #24292E">    sum </span><span style="color: #D73A49">+=</span><span style="color: #24292E"> </span><span style="color: #005CC5">4.0</span><span style="color: #24292E"> </span><span style="color: #D73A49">/</span><span style="color: #24292E"> (</span><span style="color: #005CC5">1.0</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> x </span><span style="color: #D73A49">*</span><span style="color: #24292E"> x);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  promise.</span><span style="color: #6F42C1">set_value</span><span style="color: #24292E">(sum </span><span style="color: #D73A49">*</span><span style="color: #24292E"> step);</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">display</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">shared_future</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">double</span><span style="color: #24292E">&gt; </span><span style="color: #E36209">reveiver</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">static</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex mu;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> pi </span><span style="color: #D73A49">=</span><span style="color: #24292E"> reveiver.</span><span style="color: #6F42C1">get</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">printf</span><span style="color: #24292E">(</span><span style="color: #032F62">&quot;Computed value of Pi: </span><span style="color: #005CC5">%f\n</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">, pi);</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N_steps </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">100000000</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::promise</span><span style="color: #D73A49">&lt;double&gt;</span><span style="color: #24292E"> promise;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::shared_future</span><span style="color: #D73A49">&lt;double&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">shared_receiver</span><span style="color: #24292E">(promise.</span><span style="color: #6F42C1">get_future</span><span style="color: #24292E">());</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(compute_pi, N_steps, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">move</span><span style="color: #24292E">(promise));</span></span>
<span class="line"><span style="color: #6A737D">  // 使用shared_future可以让多个线程共享同一个future对象</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(display, shared_receiver);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th3</span><span style="color: #24292E">(display, shared_receiver);</span></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th3.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="互斥和锁">互斥和锁</h2>
<p>多线程中，当多个线程队同一个对象进行访问，并且至少有一个在写数据时，会产生数据竞争</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;array&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">inc</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">res</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">1000000</span><span style="color: #24292E">; </span><span style="color: #D73A49">++</span><span style="color: #24292E">i){</span></span>
<span class="line"><span style="color: #24292E">    res</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> counter </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(inc, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(counter));</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(inc, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(counter));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;Counter: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> counter </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>该程序创建了两个线程进行累加，但最后得到的结果都不是正确结果，且每次都不一样</p>
<p><img src="并行编程/image-20250725112934180.png" alt="正常" style="zoom:50%;" /></p>
<p>这是一个正常的执行过程</p>
<p><img src="并行编程/image-20250725113007523.png" alt="错误执行" style="zoom:50%;" /></p>
<p>若顺序是这样结果就不对了</p>
<h3 id="互斥量">互斥量</h3>
<p>C++中所有运算默认为<strong>非原子操作</strong>，即该线程操作随时会被终端或被其他线程访问</p>
<p>mutex提供了一种同步机制，实现多个线程的安全访问</p>
<p>C++11开始，提供了<code>std::mutex</code>来实现互斥原语，是最常用的同步原语之一</p>
<p>有三个主要函数：</p>
<ul>
<li>lock()：锁定互斥量，即获得互斥量，若已经被其他线程锁定，则会进入阻塞直到被解锁</li>
<li>try_lock()：尝试锁定互斥量，若成功锁定则返回true，否则返回false（不保证被其他线程锁定）</li>
<li>unlock()：解锁，释放互斥量</li>
</ul>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;array&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">counter</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">inc</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #6A737D">    // 对要修改的资源进行保护</span></span>
<span class="line"><span style="color: #6A737D">    // 保证同一时间只有一个线程可以修改资源</span></span>
<span class="line"><span style="color: #6A737D">    // 即要么获得互斥量的锁，要么等待</span></span>
<span class="line"><span style="color: #24292E">    counter_mutex.</span><span style="color: #6F42C1">lock</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    m_count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span><span style="color: #6A737D"> // 临界区</span></span>
<span class="line"><span style="color: #24292E">    counter_mutex.</span><span style="color: #6F42C1">unlock</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">get</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">int</span><span style="color: #24292E"> temp;</span></span>
<span class="line"><span style="color: #24292E">    counter_mutex.</span><span style="color: #6F42C1">lock</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    temp </span><span style="color: #D73A49">=</span><span style="color: #24292E"> m_count;</span><span style="color: #6A737D"> // 临界区</span></span>
<span class="line"><span style="color: #24292E">    counter_mutex.</span><span style="color: #6F42C1">unlock</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> temp;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> m_count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex counter_mutex;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  counter c;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> increase </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [](</span><span style="color: #6F42C1">counter</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">c</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">1000000</span><span style="color: #24292E">; </span><span style="color: #D73A49">++</span><span style="color: #24292E">i){</span></span>
<span class="line"><span style="color: #24292E">      c.</span><span style="color: #6F42C1">inc</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(increase, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(c));</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(increase, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(c));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;Counter: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> c.</span><span style="color: #6F42C1">get</span><span style="color: #24292E">() </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>其中，被mutex保护的操作区域叫做<strong>临界区</strong></p>
<p>为了避免未释放互斥量的问题，我们通常结合以下对象使用</p>
<ul>
<li>lock_guard()：可以通过调用上锁后自动解锁，防止忘记解锁以及出现异常离开作用域时没有解锁</li>
</ul>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">counter</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">inc</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(counter_mutex);</span></span>
<span class="line"><span style="color: #24292E">    m_count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span><span style="color: #6A737D"> // 临界区</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">get</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(counter_mutex);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> m_count;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> m_count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex counter_mutex;</span></span>
<span class="line"><span style="color: #24292E">};</span></span></code></pre></div></div></figure>
<ul>
<li>unique_lock()：更加灵活，可以随时指定锁定与解锁</li>
</ul>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;array&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">counter</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">inc</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">n</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(counter_mutex, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::defer_lock);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">while</span><span style="color: #24292E">(n</span><span style="color: #D73A49">--</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      lock.</span><span style="color: #6F42C1">lock</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 对要修改的资源进行保护</span></span>
<span class="line"><span style="color: #24292E">      m_count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span><span style="color: #6A737D"> // 临界区</span></span>
<span class="line"><span style="color: #24292E">      lock.</span><span style="color: #6F42C1">unlock</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">get</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(counter_mutex);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> m_count; </span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> m_count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex counter_mutex;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  counter c;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> increase </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [](</span><span style="color: #6F42C1">counter</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">c</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    c.</span><span style="color: #6F42C1">inc</span><span style="color: #24292E">(</span><span style="color: #005CC5">1000000</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(increase, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(c));</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(increase, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(c));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;Counter: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> c.</span><span style="color: #6F42C1">get</span><span style="color: #24292E">() </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<ul>
<li>timed_mutex：有等待时长的互斥
<ul>
<li>try_lock_for()：指定时长内获得mutex的所有权</li>
<li>try_lock_until()：指定时刻前获得mutex的所有权</li>
</ul></li>
</ul>
<p>​ 返回true表明获得mutex，否则返回false</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;sstream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono_literals</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">TryDemo</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">print</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i</span><span style="color: #D73A49">&lt;</span><span style="color: #005CC5">10</span><span style="color: #24292E">; i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(m_mutex, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::defer_lock);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (lock.</span><span style="color: #6F42C1">try_lock_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #D73A49">ms</span><span style="color: #24292E">)) {</span></span>
<span class="line"><span style="color: #24292E">        {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">guard</span><span style="color: #24292E">(cout_mutex);</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;[&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">get_id</span><span style="color: #24292E">()</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;] &quot;</span></span>
<span class="line"><span style="color: #24292E">                  </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;Got the lock, printing &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> i </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">        }</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #D73A49">ms</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">      }</span><span style="color: #6A737D"> // 尝试获取锁，</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">guard</span><span style="color: #24292E">(cout_mutex);</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;[&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">get_id</span><span style="color: #24292E">()</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;] &quot;</span></span>
<span class="line"><span style="color: #24292E">                  </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;Failed to get the lock, skipping &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> i </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #D73A49">ms</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">       }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::timed_mutex m_mutex;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex cout_mutex; </span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> m_count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  TryDemo demo;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> print </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [](</span><span style="color: #6F42C1">TryDemo</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">demo</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    demo.</span><span style="color: #6F42C1">print</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(print, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(demo));</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(print, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(demo));</span></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #24292e">[2] Got the lock, printing 0</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 0</span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 1</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 1</span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 2</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 2</span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 3</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 3</span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 4</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 4</span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 5</span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 6</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 5        </span></span>
<span class="line"><span style="color: #24292e">[3] Got the lock, printing 6</span></span>
<span class="line"><span style="color: #24292e">[3] Got the lock, printing 7</span></span>
<span class="line"><span style="color: #24292e">[2] Failed to get the lock, skipping 7        </span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 8</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 8</span></span>
<span class="line"><span style="color: #24292e">[2] Got the lock, printing 9</span></span>
<span class="line"><span style="color: #24292e">[3] Failed to get the lock, skipping 9</span></span></code></pre></div></div></figure>
<h3 id="死锁">死锁</h3>
<p>单一线程中多次锁定同一个互斥量会导致死锁</p>
<p>常见死锁：</p>
<figure class="shiki C++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre><code>#include<iostream>
#include<mutex>
#include<thread>

class dosome{
public:
  int f1(){
    std::lock_guard lock(mtx);
    count*=2;
    f2();
    return count;

  }
  void f2(){
    std::lock_guard(mtx); // 已经在外层被锁定过了
    count++;
  }
private:
  std::mutex mtx;
  int count=0;
};</code></pre></div></div></figure>
<p>此时所在线程会进入阻塞状态</p>
<p>我们使用`<code>recursive</code>的mutx优化</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(mtx);</span></span>
<span class="line"><span style="color: #24292E">    count</span><span style="color: #D73A49">*=</span><span style="color: #005CC5">2</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> count;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">lock_guard</span><span style="color: #24292E">(mtx);</span><span style="color: #6A737D"> // 已经在外层被锁定过了</span></span>
<span class="line"><span style="color: #24292E">    count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::recursive_mutex mtx;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> count</span><span style="color: #D73A49">=</span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">};</span></span></code></pre></div></div></figure>
<p>当被锁定并获得互斥量后，当前线程再调用lock后仍会成功而不会阻塞，直到调用相同数量的unlock()才会被释放</p>
<h3 id="多线程中">多线程中</h3>
<p>多线程中，导致死锁原因较多</p>
<ol type="1">
<li>锁定一个互斥量后没有释放，导致后面的线程获取该互斥量时进入阻塞状态</li>
</ol>
<p>解决方法：使用<strong>RAII</strong>，即使用lock_guard等自动对象，在离开作用域后自动释放互斥量</p>
<ol start="2" type="1">
<li>同时对多个互斥量锁定解锁时，获得和释放顺序不同导致死锁</li>
</ol>
<p>如以下代码</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono_literals</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock1</span><span style="color: #24292E">(mtx1);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock2</span><span style="color: #24292E">(cout_mtx);</span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;count: &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #D73A49">ms</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">   </span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock1</span><span style="color: #24292E">(cout_mtx);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock2</span><span style="color: #24292E">(mtx1); </span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">--</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;count: &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #D73A49">ms</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">calc</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">n</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">n;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (n</span><span style="color: #D73A49">%</span><span style="color: #005CC5">2</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex mtx1;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex cout_mtx;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> count</span><span style="color: #D73A49">=</span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  dosome d;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10000</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10001</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N1);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N2);</span></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>这里f1与f2都对两个互斥量进行锁定，顺序不同</p>
<p>主函数设置两个线程分别为10000次，执行f1，10001次，执行f2</p>
<p>此时运行程序会在一定时间发生死锁：</p>
<p>线程1在某个时刻获得了mtx1，线程2在下一时刻获得了cout_mtx</p>
<p>接下来线程1需要获得cout_mtx，但已被2占有，需要进入阻塞等待资源释放</p>
<p>同时线程2需要获得mtx1，但已被1占有，需要进入阻塞等待资源释放</p>
<p>故整个程序进入阻塞，无法执行</p>
<figure>
<img src="并行编程/image-20250727151242766.png" alt="阻塞" />
<figcaption aria-hidden="true">阻塞</figcaption>
</figure>
<h3 id="活锁">活锁</h3>
<p>对于上述问题，解决方法之一是使用timed_mutex+try_lock_for</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono_literals</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">while</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lock1</span><span style="color: #24292E">(mtx1, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::defer_lock);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lock2</span><span style="color: #24292E">(cout_mtx, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::defer_lock);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #24292E">lock1.</span><span style="color: #6F42C1">try_lock_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #D73A49">ms</span><span style="color: #24292E">)) </span><span style="color: #D73A49">continue</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #24292E">lock2.</span><span style="color: #6F42C1">try_lock_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #D73A49">ms</span><span style="color: #24292E">)) </span><span style="color: #D73A49">continue</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;count: &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">break</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">while</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lock1</span><span style="color: #24292E">(cout_mtx, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::defer_lock);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lock2</span><span style="color: #24292E">(mtx1, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::defer_lock);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #24292E">lock1.</span><span style="color: #6F42C1">try_lock_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #D73A49">ms</span><span style="color: #24292E">)) </span><span style="color: #D73A49">continue</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #24292E">lock2.</span><span style="color: #6F42C1">try_lock_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #D73A49">ms</span><span style="color: #24292E">)) </span><span style="color: #D73A49">continue</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">--</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;count: &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">break</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  </span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">calc</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">n</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">n;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (n</span><span style="color: #D73A49">%</span><span style="color: #005CC5">2</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::timed_mutex mtx1;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::timed_mutex cout_mtx;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> count</span><span style="color: #D73A49">=</span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  dosome d;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10000</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10001</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N1);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N2);</span></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>但是运行起来会出现一顿一顿的情况</p>
<p>此时程序进入了一种<strong>活锁</strong>的状态，即</p>
<p>线程1锁定mtx1，线程2锁定cout_mtx</p>
<p>线程1试图锁定cout_mtx1失败，进入阻塞，超时后释放mtx1进入下个循环，</p>
<p>线程2试图锁定mtx1失败，进入阻塞，超时后释放cout_mtx进入下个循环</p>
<p>以此类推</p>
<p>防止该情况的发生，需要注意调用次序，注意保证按照顺序获得互斥量</p>
<p>更加方便的方法是使用std::lock()函数或scope_lock类统一管理多个互斥量</p>
<h3 id="lock函数">lock函数</h3>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono_literals</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(mtx1, cout_mtx);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock1</span><span style="color: #24292E">(mtx1, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::adopt_lock);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock2</span><span style="color: #24292E">(cout_mtx, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::adopt_lock);</span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;count: &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(mtx1, cout_mtx);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock1</span><span style="color: #24292E">(cout_mtx, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::adopt_lock);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard </span><span style="color: #6F42C1">lock2</span><span style="color: #24292E">(mtx1, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::adopt_lock); </span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">--</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;count: &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">calc</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">n</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">n;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (n</span><span style="color: #D73A49">%</span><span style="color: #005CC5">2</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex mtx1;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex cout_mtx;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> count</span><span style="color: #D73A49">=</span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  dosome d;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10000</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10001</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N1);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N2);</span></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>此时lock函数会接管下面的两个lock_guard，当他们被销毁时，析构函数中会自动释放两个互斥量</p>
<p>即使传入的两个互斥量顺序不同，lock的特殊算法也可避免死锁的发生</p>
<h3 id="scope_lock类">scope_lock类</h3>
<p>该类更加方便，使用多个类进行初始化</p>
<p>构造时可以自动调用lock函数，析构时自动释放</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono_literals</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::scoped_lock </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(mtx1, cout_mtx);</span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;count: &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::scoped_lock </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(cout_mtx, mtx1);</span></span>
<span class="line"><span style="color: #24292E">      count</span><span style="color: #D73A49">--</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;count: &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">count</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">calc</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">n</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">n;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (n</span><span style="color: #D73A49">%</span><span style="color: #005CC5">2</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex mtx1;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex cout_mtx;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> count</span><span style="color: #D73A49">=</span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  dosome d;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10000</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> N2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10001</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th1</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N1);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">th2</span><span style="color: #24292E">(</span><span style="color: #6F42C1">dosome</span><span style="color: #24292E">::calc, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">d, N2);</span></span>
<span class="line"><span style="color: #24292E">  th1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  th2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h3 id="读写锁">读写锁</h3>
<p>若存在三个线程读取数据、一个线程写入数据，若使用mutex互斥量进行操作，读写步骤几乎是排队进行的，导致了程序运行效率底下</p>
<p>我们又知道，在没有数据写入的情况下，多个线程同时读取数据是不会发生数据竞争的，不必独占资源</p>
<p>故我们可以规定：</p>
<ul>
<li>一个线程读取数据时，允许其他线程同时读取数据，不允许其他线程写数据</li>
<li>一个线程写数据时，不允许其他线程读写数据</li>
</ul>
<p>这样可以显著提高效率</p>
<p>C++14以上，这样的读写锁的功能由<code>shared_mutex</code>类、<code>shared_timed_mutex</code>提供</p>
<p>该类提供两个模式和两个锁：</p>
<ul>
<li>独占模式：仅有一个线程可以占有互斥量</li>
<li>独占锁：独占模式下，当一个线程获得独占锁，任何其他线程都不能获得独占锁和共享锁</li>
<li>共享模式：可以有多个线程分享互斥量</li>
<li>共享锁：共享模式下，当一个线程获得共享锁，其他线程可获得共享锁，不能获得独占锁</li>
</ul>
<p>读写锁广泛应用于读多写少的场景下，是一种重要的同步原语</p>
<h2 id="条件变量">条件变量</h2>
<p>条件变量是并发程序中经常用到的同步原语，可以实现在线程间发生通知以实现线程间的同步</p>
<h3 id="工作流">工作流</h3>
<blockquote>
<p>如提供两个线程，用于读取与写入数据，读取要在写入之后</p>
</blockquote>
<ol type="1">
<li>接收线程获得互斥量mutex，使用条件变量来等待发送线程的通知，等待时释放mutex</li>
<li>发送线程获得mutex，并对共享数据进行写入，完成后释放mutex</li>
<li>发送线程使用条件变量发送通知，接收线程接收到通知后重新获得mutex，结束阻塞继续运行</li>
<li>接收线程读取处理共享数据，处理完毕后释放mutex</li>
</ol>
<h3 id="使用">使用</h3>
<p>标准库conditional_variable实现条件变量原语，包含以下函数：</p>
<p>等待：</p>
<ul>
<li>wait：传入锁的引用以及解除阻塞的条件。进入等待状态时释放锁，结束后获得锁，且都是原子操作</li>
<li>wait_for：</li>
<li>wait_until：</li>
</ul>
<p>通知：</p>
<ul>
<li>notify_one：</li>
<li>notify_all：</li>
</ul>
<h3 id="例">例</h3>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;condition_variable&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono_literals</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">channel</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">getData</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> tid </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">get_id</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lck</span><span style="color: #24292E">(mutex_);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;接收方[&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">tid</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;]等待数据&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    condVar.</span><span style="color: #6F42C1">wait</span><span style="color: #24292E">(lck);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;接收方[&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">tid</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;]得到数据&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">sharedData</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    sharedData.</span><span style="color: #6F42C1">clear</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">setData</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">static</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> id </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::stringstream ss;</span></span>
<span class="line"><span style="color: #24292E">    ss </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;hello #&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">id;</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lck</span><span style="color: #24292E">(mutex_);</span></span>
<span class="line"><span style="color: #24292E">      sharedData </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ss.</span><span style="color: #6F42C1">str</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout  </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;</span><span style="color: #005CC5">\n</span><span style="color: #032F62">发送方：第&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">id</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;条数据写入完毕&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">      id</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    condVar.</span><span style="color: #6F42C1">notify_one</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #D73A49">ms</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex mutex_;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::condition_variable condVar;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::string sharedData;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  channel c;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">write_th</span><span style="color: #24292E">(</span><span style="color: #6F42C1">channel</span><span style="color: #24292E">::setData, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">c);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">read_th</span><span style="color: #24292E">(</span><span style="color: #6F42C1">channel</span><span style="color: #24292E">::getData, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">c);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  read_th.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  write_th.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h3 id="丢失唤醒与虚假唤醒">丢失唤醒与虚假唤醒</h3>
<p>发现程序运行时，有时会出现死锁的状态</p>
<p>从输出发现，写线程在读线程进入等待前就准备好了数据并发出通知，而读线程进入状态后才</p>
<p>准备接受通知，于是错过了通知，一直等待，发生丢失唤醒</p>
<p>除了丢失唤醒，等待函数还会出现虚假唤醒：即等待线程在条件未满足的情况下被唤醒了</p>
<p>原因与底层硬件软件的异常有关</p>
<p>因此我们最好使用wait函数的重载版本，设置一个等待条件</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;mutex&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;condition_variable&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono_literals</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">channel</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">getData</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> tid </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">get_id</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lck</span><span style="color: #24292E">(mutex_);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;接收方[&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">tid</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;]等待数据&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    condVar.</span><span style="color: #6F42C1">wait</span><span style="color: #24292E">(lck, [</span><span style="color: #005CC5">this</span><span style="color: #24292E">]{</span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #D73A49">!</span><span style="color: #24292E">sharedData.</span><span style="color: #6F42C1">empty</span><span style="color: #24292E">();});</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (sharedData.</span><span style="color: #6F42C1">empty</span><span style="color: #24292E">()){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;接收方[&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">tid</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;] 虚假唤醒&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">else</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;接收方[&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">tid</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;]得到数据&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">sharedData</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    sharedData.</span><span style="color: #6F42C1">clear</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">setData</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">static</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> id </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::stringstream ss;</span></span>
<span class="line"><span style="color: #24292E">    ss </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;hello #&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">id;</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::unique_lock </span><span style="color: #6F42C1">lck</span><span style="color: #24292E">(mutex_);</span></span>
<span class="line"><span style="color: #24292E">      sharedData </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ss.</span><span style="color: #6F42C1">str</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout  </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;</span><span style="color: #005CC5">\n</span><span style="color: #032F62">发送方：第&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">id</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;条数据写入完毕&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">      id</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    condVar.</span><span style="color: #6F42C1">notify_one</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #D73A49">ms</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mutex mutex_;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::condition_variable condVar;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::string sharedData;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  channel c;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">write_th</span><span style="color: #24292E">(</span><span style="color: #6F42C1">channel</span><span style="color: #24292E">::setData, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">c);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">read_th</span><span style="color: #24292E">(</span><span style="color: #6F42C1">channel</span><span style="color: #24292E">::getData, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">c);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  read_th.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  write_th.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="信号量">信号量</h2>
<p>实现对有限资源的并发访问控制，内部有一个计数器，表示资源的可用数量</p>
<p>线程通过信号量来获得对资源的访问许可，若大于0，可以进行访问，计数器减一</p>
<p>信号量要与互斥量结合使用，用信号量来限制并发访问数量，用互斥量实现对具体数据同步</p>
<p>C++标准库中，有一个类模板<code>counting_semaphore</code>，其中参数<code>LeastMaxValue</code>规定了计数最大值不小于该值，还有他的特化版本<code>binary_semaphore</code>，值设定为1</p>
<p>函数：</p>
<ul>
<li>release：将计数值+1，是原子操作</li>
<li>acquire：若计数值大于1，则将计数值-1，如果为0，则该函数阻塞直到计数值大于1</li>
<li>try_acquire：成功时将计数值-1，返回true</li>
<li>try_acquire_for：阻塞时最多等待的时间</li>
<li>try_acquire_until：阻塞时最多等待到某个时刻</li>
</ul>
<p>例：循环读写buffer</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;random&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;array&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;semaphore&gt;</span><span style="color: #24292E"> </span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;syncstream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// 简单的随机辅助类</span></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Random</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #6A737D">    // 构造 [l, r] 的整数随机</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">Random</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">l</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">r</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">      : </span><span style="color: #6F42C1">eng</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::random_device{}()),</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">dist</span><span style="color: #24292E">(l, r)</span></span>
<span class="line"><span style="color: #24292E">    {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #D73A49">operator</span><span style="color: #6F42C1">()</span><span style="color: #24292E">() {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">dist</span><span style="color: #24292E">(eng);</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mt19937 eng;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::uniform_int_distribution</span><span style="color: #D73A49">&lt;int&gt;</span><span style="color: #24292E"> dist;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// RWBuffer 模板</span></span>
<span class="line"><span style="color: #D73A49">template</span><span style="color: #24292E"> &lt;</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> </span><span style="color: #6F42C1">BuffSize</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">6</span><span style="color: #24292E">&gt;</span></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">RWBuffer</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">RWBuffer</span><span style="color: #24292E">() {</span></span>
<span class="line"><span style="color: #24292E">        buff.</span><span style="color: #6F42C1">fill</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39; &#39;</span><span style="color: #24292E">);</span><span style="color: #6A737D">    // 填充空格</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 模拟生产者准备数据</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">char</span><span style="color: #24292E"> </span><span style="color: #6F42C1">prepareData</span><span style="color: #24292E">() {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">(</span><span style="color: #6F42C1">rgen</span><span style="color: #24292E">()));</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">chargen</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 模拟消费者处理数据</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">processData</span><span style="color: #24292E">(</span><span style="color: #D73A49">char</span><span style="color: #6A737D"> /*ch*/</span><span style="color: #24292E">) {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">(</span><span style="color: #6F42C1">rgen2</span><span style="color: #24292E">()));</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 原子打印缓存区</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">printBuffer</span><span style="color: #24292E">() {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::osyncstream </span><span style="color: #6F42C1">sync</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout);</span></span>
<span class="line"><span style="color: #24292E">        sync </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;BUFFER: |&quot;</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">auto</span><span style="color: #24292E"> c : buff) {</span></span>
<span class="line"><span style="color: #24292E">            sync </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> c </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;|&quot;</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">        }</span></span>
<span class="line"><span style="color: #24292E">        sync </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;</span><span style="color: #005CC5">\n</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 写线程函数</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">writeToBuffer</span><span style="color: #24292E">(</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> </span><span style="color: #E36209">iterations</span><span style="color: #24292E">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout) </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;写线程就绪.</span><span style="color: #005CC5">\n</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #6A737D">        // 总共写 iterations * BuffSize 次</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> iterations </span><span style="color: #D73A49">*</span><span style="color: #24292E"> BuffSize; i</span><span style="color: #D73A49">++</span><span style="color: #24292E">) {</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #D73A49">char</span><span style="color: #24292E"> ch </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">prepareData</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">            sem_writer.</span><span style="color: #6F42C1">acquire</span><span style="color: #24292E">();</span><span style="color: #6A737D">        // 等待有空位</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> idx </span><span style="color: #D73A49">=</span><span style="color: #24292E"> i </span><span style="color: #D73A49">%</span><span style="color: #24292E"> BuffSize;</span></span>
<span class="line"><span style="color: #24292E">            buff[idx] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ch;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout) </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;写线程：写入 &#39;&quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> ch </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;&#39; 到位置 &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> idx </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;</span><span style="color: #005CC5">\t</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #6F42C1">printBuffer</span><span style="color: #24292E">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">            sem_reader.</span><span style="color: #6F42C1">release</span><span style="color: #24292E">();</span><span style="color: #6A737D">        // 通知读线程</span></span>
<span class="line"><span style="color: #24292E">        }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 读线程函数</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">readFromBuffer</span><span style="color: #24292E">(</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> </span><span style="color: #E36209">iterations</span><span style="color: #24292E">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout) </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;读线程就绪.</span><span style="color: #005CC5">\n</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> iterations </span><span style="color: #D73A49">*</span><span style="color: #24292E"> BuffSize; i</span><span style="color: #D73A49">++</span><span style="color: #24292E">) {</span></span>
<span class="line"><span style="color: #24292E">            sem_reader.</span><span style="color: #6F42C1">acquire</span><span style="color: #24292E">();</span><span style="color: #6A737D">        // 等待有数据</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> idx </span><span style="color: #D73A49">=</span><span style="color: #24292E"> i </span><span style="color: #D73A49">%</span><span style="color: #24292E"> BuffSize;</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #D73A49">char</span><span style="color: #24292E"> ch </span><span style="color: #D73A49">=</span><span style="color: #24292E"> buff[idx];</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #6F42C1">processData</span><span style="color: #24292E">(ch);</span></span>
<span class="line"><span style="color: #24292E">            buff[idx] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39; &#39;</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout) </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;读线程：读取 &#39;&quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> ch </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;&#39; 从位置 &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> idx </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;</span><span style="color: #005CC5">\t</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #6F42C1">printBuffer</span><span style="color: #24292E">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">            sem_writer.</span><span style="color: #6F42C1">release</span><span style="color: #24292E">();</span><span style="color: #6A737D">        // 通知写线程</span></span>
<span class="line"><span style="color: #24292E">        }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">    Random rgen{</span><span style="color: #005CC5">500</span><span style="color: #24292E">,</span><span style="color: #005CC5">1000</span><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #24292E">    Random rgen2{</span><span style="color: #005CC5">800</span><span style="color: #24292E">,</span><span style="color: #005CC5">1500</span><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #24292E">    Random chargen{</span><span style="color: #032F62">&#39;A&#39;</span><span style="color: #24292E">,</span><span style="color: #032F62">&#39;Z&#39;</span><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::array</span><span style="color: #D73A49">&lt;char</span><span style="color: #24292E">, BuffSize</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> buff;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::counting_semaphore</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">BuffSize</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> sem_reader{</span><span style="color: #005CC5">0</span><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::counting_semaphore</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">BuffSize</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> sem_writer{BuffSize};</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">constexpr</span><span style="color: #24292E"> </span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> N </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">6</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">constexpr</span><span style="color: #24292E"> </span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> ITERS </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">3</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    RWBuffer</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">N</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> buffer;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 启动写线程和读线程</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">writer</span><span style="color: #24292E">(</span><span style="color: #D73A49">&amp;</span><span style="color: #6F42C1">RWBuffer</span><span style="color: #24292E">&lt;</span><span style="color: #6F42C1">N</span><span style="color: #24292E">&gt;::writeToBuffer, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">buffer, ITERS);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">reader</span><span style="color: #24292E">(</span><span style="color: #D73A49">&amp;</span><span style="color: #6F42C1">RWBuffer</span><span style="color: #24292E">&lt;</span><span style="color: #6F42C1">N</span><span style="color: #24292E">&gt;::readFromBuffer, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">buffer, ITERS);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    writer.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    reader.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="异步任务">异步任务</h2>
<p>将函数调用交给另一个线程异步执行，原有线程继续执行代码，在需要时再去获得执行结果</p>
<p>C++中提供了async与packaged_task进行异步任务</p>
<figure>
<img src="并行编程/image-20250728133257958.png" alt="异步" />
<figcaption aria-hidden="true">异步</figcaption>
</figure>
<h3 id="async">async</h3>
<p>语法：</p>
<p><code>std::future&lt;返回类型&gt; async(std::launch policy, F&amp; f, Args&amp;&amp;... args);</code></p>
<p><code>std::future&lt;返回类型&gt; async(F&amp; f, Args&amp;&amp;... args);</code>（默认策略）</p>
<p>执行策略（用整型不同bit位表示）：</p>
<ul>
<li><code>std::launch::async</code>：异步调用，00000001，相当于新建或使用线程池中的线程并在线程中调用函数</li>
<li><code>std::launch::deferred</code>：推迟调用，00000010，async返回的future对象用于存储函数指针、对象、实参拷贝，调用get函数时会同步调用存储的这个函数</li>
<li><code>std::launch::async|std::launch::deferred</code>：组合，00000011，同步还是异步执行根据具体实现决定</li>
</ul>
<h3 id="packaged_task">packaged_task</h3>
<p>方法</p>
<ul>
<li>get_future()：获得一个future对象，封装函数的返回结果存储在future对象的共享状态中</li>
<li><code>void operator()(ArgTypes... args)</code>：用于调用封装的函数，将返回结果存储在future中，此时会同步执行封装函数</li>
<li>reset()：用于重复使用packaged_task，清空状态获得一个新的future对象</li>
</ul>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;random&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;vector&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;future&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;syncstream&gt;</span></span>
<span class="line"><span style="color: #6A737D">// 简单的随机辅助类</span></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Random</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #6A737D">    // 构造 [l, r] 的整数随机</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">Random</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">l</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">r</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">      : </span><span style="color: #6F42C1">eng</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::random_device{}()),</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">dist</span><span style="color: #24292E">(l, r)</span></span>
<span class="line"><span style="color: #24292E">    {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #D73A49">operator</span><span style="color: #6F42C1">()</span><span style="color: #24292E">() {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">dist</span><span style="color: #24292E">(eng);</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mt19937 eng;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::uniform_int_distribution</span><span style="color: #D73A49">&lt;int&gt;</span><span style="color: #24292E"> dist;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">float</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Compute</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">vector</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">float</span><span style="color: #24292E">&gt; </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">v</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">seconds</span><span style="color: #24292E">(</span><span style="color: #005CC5">2</span><span style="color: #24292E">));</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> r </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">accumulate</span><span style="color: #24292E">(v.</span><span style="color: #6F42C1">begin</span><span style="color: #24292E">(), v.</span><span style="color: #6F42C1">end</span><span style="color: #24292E">(), </span><span style="color: #005CC5">0.0</span><span style="color: #D73A49">f</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout)</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;执行任务的线程id=&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">get_id</span><span style="color: #24292E">()</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> r;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> RN_MAX </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10000</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  Random </span><span style="color: #6F42C1">rgen</span><span style="color: #24292E">(</span><span style="color: #005CC5">0</span><span style="color: #24292E">, RN_MAX);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;float&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">numbers</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #24292E">, </span><span style="color: #005CC5">0.0</span><span style="color: #D73A49">f</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">generate</span><span style="color: #24292E">(numbers.</span><span style="color: #6F42C1">begin</span><span style="color: #24292E">(), numbers.</span><span style="color: #6F42C1">end</span><span style="color: #24292E">(), [</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">]{</span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #D73A49">float</span><span style="color: #24292E">(</span><span style="color: #6F42C1">rgen</span><span style="color: #24292E">()</span><span style="color: #D73A49">/</span><span style="color: #24292E">RN_MAX);});</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;创建任务的线程id:&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">get_id</span><span style="color: #24292E">()</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::packaged_task</span><span style="color: #D73A49">&lt;float</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;float&gt;&amp;</span><span style="color: #24292E">)</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">task</span><span style="color: #24292E">(Compute);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;直接调用&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::future</span><span style="color: #D73A49">&lt;float&gt;</span><span style="color: #24292E"> result </span><span style="color: #D73A49">=</span><span style="color: #24292E"> task.</span><span style="color: #6F42C1">get_future</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">task</span><span style="color: #24292E">(numbers);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;result=&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">result.</span><span style="color: #6F42C1">get</span><span style="color: #24292E">()</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  task.</span><span style="color: #6F42C1">reset</span><span style="color: #24292E">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;线程调用&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  result </span><span style="color: #D73A49">=</span><span style="color: #24292E"> task.</span><span style="color: #6F42C1">get_future</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">t</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">move</span><span style="color: #24292E">(task), </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(numbers));</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;result=&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">result.</span><span style="color: #6F42C1">get</span><span style="color: #24292E">()</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  t.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="线程屏障">线程屏障</h2>
<p>线程屏障提供了一个计数器，每个参与任务的线程完成自己的任务后计数器-1，而需要同步的线程可以阻塞到计数器为0时再执行后面的代码</p>
<h3 id="latch">latch</h3>
<p>latch是一次性的计数，参数为作为计数器的初始值</p>
<ul>
<li>count_down(n=1)：将计数器减去传入的数值，默认为1，是原子操作</li>
<li>wait()：将线程阻塞到计数器为0后释放</li>
<li>try_wait()：检查计数器是否为0，返回true为0，返回false不一定为0</li>
<li>arrive_and_wait(n=1)：执行了count_down和wait</li>
</ul>
<p>e.g.模拟paobu</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;latch&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;random&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">struct</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Runner</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::string name;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> time </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">run</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">latch</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">start</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">latch</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">end</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    start.</span><span style="color: #6F42C1">wait</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 等待发令枪响</span></span>
<span class="line"><span style="color: #6A737D">    // 模拟跑步过程</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> start_time </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">system_clock</span><span style="color: #24292E">::</span><span style="color: #6F42C1">now</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mt19937 </span><span style="color: #6F42C1">rng</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::random_device{}());</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::uniform_int_distribution</span><span style="color: #D73A49">&lt;unsigned</span><span style="color: #24292E"> </span><span style="color: #D73A49">int&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">uniform_dist</span><span style="color: #24292E">(</span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #005CC5">2000</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">(</span><span style="color: #005CC5">9600</span><span style="color: #D73A49">+</span><span style="color: #6F42C1">uniform_dist</span><span style="color: #24292E">(rng)));</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> end_time </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">system_clock</span><span style="color: #24292E">::</span><span style="color: #6F42C1">now</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    time </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">duration_cast</span><span style="color: #24292E">&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">&gt;(end_time </span><span style="color: #D73A49">-</span><span style="color: #24292E"> start_time).</span><span style="color: #6F42C1">count</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    end.</span><span style="color: #6F42C1">count_down</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">);</span><span style="color: #6A737D"> // 跑完，计数器-1</span></span>
<span class="line"><span style="color: #24292E">  } </span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">bool</span><span style="color: #24292E"> </span><span style="color: #D73A49">operator</span><span style="color: #6F42C1">&lt;</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Runner</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">other</span><span style="color: #24292E">) </span><span style="color: #D73A49">const</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> time </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> other.time;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">Runner</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> runners </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">    {</span><span style="color: #032F62">&quot;Alice&quot;</span><span style="color: #24292E">}, {</span><span style="color: #032F62">&quot;Bob&quot;</span><span style="color: #24292E">}, {</span><span style="color: #032F62">&quot;Charlie&quot;</span><span style="color: #24292E">}, {</span><span style="color: #032F62">&quot;Diana&quot;</span><span style="color: #24292E">}, {</span><span style="color: #032F62">&quot;Eve&quot;</span><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #6A737D">  // 等待阶段</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> runner_count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> runners.</span><span style="color: #6F42C1">size</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::latch </span><span style="color: #6F42C1">start</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">);</span><span style="color: #6A737D"> // 代表发令枪，等到为0时执行后面代码</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::latch </span><span style="color: #6F42C1">finish</span><span style="color: #24292E">(runner_count);</span><span style="color: #6A737D"> // 代表完赛选手数量，有一个选手冲线则-1，直到为0时比赛结束</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> threads;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">runner_count; </span><span style="color: #D73A49">++</span><span style="color: #24292E">i) {</span></span>
<span class="line"><span style="color: #24292E">    threads.</span><span style="color: #6F42C1">emplace_back</span><span style="color: #24292E">(</span><span style="color: #D73A49">&amp;</span><span style="color: #6F42C1">Runner</span><span style="color: #24292E">::run, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">runners[i], </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(start), </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(finish));</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;发令枪响&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  start.</span><span style="color: #6F42C1">count_down</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 发令枪响，所有选手开始跑</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  finish.</span><span style="color: #6F42C1">wait</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 等待所有选手跑完，阻塞</span></span>
<span class="line"><span style="color: #6A737D">  // 结束后统计成绩</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;比赛结束&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sort</span><span style="color: #24292E">(runners.</span><span style="color: #6F42C1">begin</span><span style="color: #24292E">(), runners.</span><span style="color: #6F42C1">end</span><span style="color: #24292E">());</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">auto&amp;</span><span style="color: #24292E"> runner : runners) {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> runner.name </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot; : &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #D73A49">float</span><span style="color: #24292E">(runner.time)</span><span style="color: #D73A49">/</span><span style="color: #005CC5">1000</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;秒&quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E">(</span><span style="color: #D73A49">auto&amp;</span><span style="color: #24292E"> thread : threads) {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">      thread.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #24292e">发令枪响</span></span>
<span class="line"><span style="color: #24292e">比赛结束</span></span>
<span class="line"><span style="color: #24292e">Eve : 9.946秒</span></span>
<span class="line"><span style="color: #24292e">Bob : 10.034秒</span></span>
<span class="line"><span style="color: #24292e">Diana : 10.092秒</span></span>
<span class="line"><span style="color: #24292e">Alice : 10.842秒</span></span>
<span class="line"><span style="color: #24292e">Charlie : 11.621秒</span></span></code></pre></div></div></figure>
<h3 id="barrier">barrier</h3>
<p>barrier每次计数到0时，都会把初始值恢复，进行下一轮计数</p>
<p>barrier是个类模板，参数为计数器初始值</p>
<ul>
<li><p>arrive(n=1)：将计数器减去指定参数n</p></li>
<li><p>wait()：等待计数器为0</p></li>
<li><p>arrive_and_wait(n=1)：前两个结合</p></li>
<li><p>arrive_and_drop(n=1)：除了将本次-n，还将下一次的初始值-n</p></li>
</ul>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;barrier&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;random&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;chrono&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;vector&gt;</span></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">participant</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::string name;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">participant</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">string</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">name</span><span style="color: #24292E">) : </span><span style="color: #6F42C1">name</span><span style="color: #24292E">(name) {}</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">template</span><span style="color: #24292E"> &lt;</span><span style="color: #D73A49">typename</span><span style="color: #24292E"> </span><span style="color: #6F42C1">BarrierType</span><span style="color: #24292E">&gt;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">run</span><span style="color: #24292E">(</span><span style="color: #6F42C1">BarrierType</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">finish</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #6A737D">    // 随机数确定是否能存货</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::mt19937 </span><span style="color: #6F42C1">rng</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::random_device{}());</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::uniform_int_distribution</span><span style="color: #D73A49">&lt;unsigned</span><span style="color: #24292E"> </span><span style="color: #D73A49">int&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">uniform_dist</span><span style="color: #24292E">(</span><span style="color: #005CC5">1000</span><span style="color: #24292E">, </span><span style="color: #005CC5">2000</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i</span><span style="color: #D73A49">&lt;</span><span style="color: #005CC5">5</span><span style="color: #24292E">;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> rnd </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">uniform_dist</span><span style="color: #24292E">(rng);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">(rnd));</span></span>
<span class="line"><span style="color: #24292E">      alive </span><span style="color: #D73A49">=</span><span style="color: #24292E"> rnd</span><span style="color: #D73A49">%</span><span style="color: #005CC5">3</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (alive){</span></span>
<span class="line"><span style="color: #24292E">        finish.</span><span style="color: #6F42C1">arrive_and_wait</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 到达终点，等待其他选手</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">else</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        finish.</span><span style="color: #6F42C1">arrive_and_drop</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 选手掉队，直接结束</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">break</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">bool</span><span style="color: #24292E"> </span><span style="color: #6F42C1">is_alive</span><span style="color: #24292E">() </span><span style="color: #D73A49">const</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> alive;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">bool</span><span style="color: #24292E"> alive </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">;</span><span style="color: #6A737D"> // 选手是否存活</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">participant</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> participants </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">    {</span><span style="color: #032F62">&quot;Alice&quot;</span><span style="color: #24292E">}, {</span><span style="color: #032F62">&quot;Bob&quot;</span><span style="color: #24292E">}, {</span><span style="color: #032F62">&quot;Charlie&quot;</span><span style="color: #24292E">}, {</span><span style="color: #032F62">&quot;Diana&quot;</span><span style="color: #24292E">}, {</span><span style="color: #032F62">&quot;Eve&quot;</span><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> participant_count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> participants.</span><span style="color: #6F42C1">size</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> round </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #6A737D">  // barrier每轮结束时的回调函数</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> on_complete </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [</span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">participants</span><span style="color: #24292E">, </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">round</span><span style="color: #24292E">](){</span></span>
<span class="line"><span style="color: #24292E">    round</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;第&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> round </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;轮幸存者:&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">int</span><span style="color: #24292E"> count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">auto</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> p : participants) {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (p.</span><span style="color: #6F42C1">is_alive</span><span style="color: #24292E">()) {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> p.name </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot; &quot;</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">        count</span><span style="color: #D73A49">++</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (count</span><span style="color: #D73A49">==</span><span style="color: #005CC5">0</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;没有幸存者&quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::barrier </span><span style="color: #6F42C1">finish</span><span style="color: #24292E">(participant_count, on_complete);</span><span style="color: #6A737D"> // 参赛者数量为初始值，oncomplete为每轮的回调</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> threads;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">auto</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">p: participants) {</span></span>
<span class="line"><span style="color: #24292E">    threads.</span><span style="color: #6F42C1">emplace_back</span><span style="color: #24292E">([</span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">p</span><span style="color: #24292E">, </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">finish</span><span style="color: #24292E">](){p.</span><span style="color: #6F42C1">run</span><span style="color: #24292E">(finish);});</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">auto</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">thread : threads) {</span></span>
<span class="line"><span style="color: #24292E">    thread.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span><span style="color: #6A737D"> // 等待所有线程结束</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p><strong>注：对计数器进行-n操作时，传入的n的值不能大于当前计数值，否则会导致未定义错误</strong></p>
<h2 id="原子操作">原子操作</h2>
<p>原子操作是不能被分割或中断的操作，其他线程只能看到开始与结束的状态</p>
<h3 id="类型">类型</h3>
<ul>
<li>Load 加载</li>
<li>Store 存储</li>
<li>Read Modify Write 读取-修改-写入（RMW）</li>
</ul>
<h3 id="atomic_flag">atomic_flag</h3>
<p>它只有true和false两个值，true表示标志被设置，false表示标志被清除</p>
<p>初始化可以使用<code>ATOMIC_FLAG_INIT</code>宏，也可以使用默认构造函数（C++20后）</p>
<ul>
<li><p>clear()：清除标志，是一个原子写操作，函数有一个参数<code>memory_order</code>，指定内存顺序，默认为memory
order sequentially consistent</p></li>
<li><p>test_and_set()：将标志设置为true，并返回原有值，是一个RMW操作</p></li>
</ul>
<p>（以下为C++20新增）</p>
<ul>
<li>test()：读取数据</li>
<li>wait(oldvalue)：等待条件达成</li>
<li>notify_one()：通知其中一个线程结束等待</li>
<li>notify_all()：通知所有线程结束等待</li>
</ul>
<h3 id="自旋锁">自旋锁</h3>
<p>自旋：持续监控变量以等待发生变化的过程</p>
<p>自旋锁消耗资源较高，常用于临界区代码耗时很少的场合</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">SpinLock</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">while</span><span style="color: #24292E"> (flag.</span><span style="color: #6F42C1">test_and_set</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::memory_order_acquire)){}</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">unlock</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">        flag.</span><span style="color: #6F42C1">clear</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::memory_order_release);</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::atomic_flag flag{ATOMIC_FLAG_INIT};</span></span>
<span class="line"><span style="color: #24292E">};</span></span></code></pre></div></div></figure>
<p>例：</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;atomic&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;assert.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">SpinLock</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">while</span><span style="color: #24292E"> (flag.</span><span style="color: #6F42C1">test_and_set</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::memory_order_acquire)){}</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">unlock</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">        flag.</span><span style="color: #6F42C1">clear</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::memory_order_release);</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::atomic_flag flag{ATOMIC_FLAG_INIT};</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  SpinLock spin;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> count </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> inc </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">](){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i</span><span style="color: #D73A49">&lt;</span><span style="color: #005CC5">1000</span><span style="color: #24292E">;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::lock_guard</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">SpinLock</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">lock</span><span style="color: #24292E">(spin);</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">++</span><span style="color: #24292E">count;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">t1</span><span style="color: #24292E">(inc);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">t2</span><span style="color: #24292E">(inc);</span></span>
<span class="line"><span style="color: #24292E">  t1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  t2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;count = &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> count </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>这里由于自旋锁包含lock与unlock函数，符合C++中的基本锁类型，故可以使用lock_guard自动加锁解锁</p>
<h3 id="例-1">例</h3>
<p>实现了一个一次生产者与消费者的模拟</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;atomic&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;assert.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">struct</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Channel</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">getData</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;[Consumer] wait for data ready</span><span style="color: #005CC5">\n</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    dataReady.</span><span style="color: #6F42C1">wait</span><span style="color: #24292E">(</span><span style="color: #005CC5">false</span><span style="color: #24292E">);</span><span style="color: #6A737D"> // 等待数据准备好</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;[Consumer] data is:&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">data</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    dataReady.</span><span style="color: #6F42C1">clear</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">setData</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">string</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">v</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">(</span><span style="color: #005CC5">2000</span><span style="color: #24292E">));</span><span style="color: #6A737D"> // 模拟数据准备时间</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;&#39;[Producer] write data</span><span style="color: #005CC5">\n</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    data </span><span style="color: #D73A49">=</span><span style="color: #24292E"> v;</span></span>
<span class="line"><span style="color: #24292E">    dataReady.</span><span style="color: #6F42C1">test_and_set</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    dataReady.</span><span style="color: #6F42C1">notify_one</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::atomic_flag dataReady </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ATOMIC_FLAG_INIT;</span><span style="color: #6A737D"> // 用于标记数据是否准备好</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::string data;</span><span style="color: #6A737D"> // 存储数据</span></span>
<span class="line"><span style="color: #24292E">  </span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  Channel channel;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">consumer</span><span style="color: #24292E">(</span><span style="color: #6F42C1">Channel</span><span style="color: #24292E">::getData, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">channel);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">producer</span><span style="color: #24292E">(</span><span style="color: #6F42C1">Channel</span><span style="color: #24292E">::setData, </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">channel, </span><span style="color: #032F62">&quot;Hello, World!&quot;</span><span style="color: #24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  consumer.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  producer.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h3 id="特化版本">特化版本</h3>
<p>atomic除了主模板还有针对指针、智能指针与数据类型的特化版本</p>
<p><img src="并行编程/image-20250731104420865.png" alt="atomic" style="zoom:67%;" /></p>
<p>其中主模板中的T要求是可平凡拷贝的</p>
<h3 id="有无锁的判断">有无锁的判断</h3>
<p>我们可以通过atomic模板提供的<code>is_lock_free()</code>函数判断有无锁，若无锁（通过CPU的原子指令）则函数返回true，否则返回false</p>
<ul>
<li>基本类型和指针都是无锁的</li>
<li>自定义类型与类型大小与对齐有关：类型大小是<span
class="math inline">\(2^n\)</span>且小于最大对齐数（16字节）</li>
</ul>
<h3 id="主要的原子操作">主要的原子操作</h3>
<p><strong>加载操作：</strong>用于原子地获得当前变量的值</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #6F42C1">load</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order</span><span style="color: #24292E"> </span><span style="color: #E36209">order</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order_seq_cst</span><span style="color: #24292E">) </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">noexcept</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">operator</span><span style="color: #24292E"> </span><span style="color: #6F42C1">T</span><span style="color: #24292E">() </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">noexcept</span><span style="color: #24292E">;</span></span></code></pre></div></div></figure>
<p><strong>存储操作：</strong>用于将变量原子地修改为要更新的值</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">store</span><span style="color: #24292E">(</span><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #E36209">desired</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order</span><span style="color: #24292E"> </span><span style="color: #E36209">order</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order_seq_cst</span><span style="color: #24292E">) </span><span style="color: #D73A49">noexcept</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #D73A49">operator</span><span style="color: #6F42C1">=</span><span style="color: #24292E">(</span><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #E36209">desired</span><span style="color: #24292E">) </span><span style="color: #D73A49">noexcept</span><span style="color: #24292E">;</span></span></code></pre></div></div></figure>
<p><strong>CAS（比较与交换函数）：</strong></p>
<p>通过compare_exchange函数完成</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">bool</span><span style="color: #24292E"> </span><span style="color: #6F42C1">compare_exchange_weak</span><span style="color: #24292E">(</span><span style="color: #6F42C1">T</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">expected</span><span style="color: #24292E">, </span><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #E36209">desired</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order</span><span style="color: #24292E"> </span><span style="color: #E36209">success</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order</span><span style="color: #24292E"> </span><span style="color: #E36209">failure</span><span style="color: #24292E">) </span><span style="color: #D73A49">noexcept</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">bool</span><span style="color: #24292E"> </span><span style="color: #6F42C1">compare_exchange_strong</span><span style="color: #24292E">(</span><span style="color: #6F42C1">T</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">expected</span><span style="color: #24292E">, </span><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #E36209">desired</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order</span><span style="color: #24292E"> </span><span style="color: #E36209">success</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">memory_order</span><span style="color: #24292E"> </span><span style="color: #E36209">failure</span><span style="color: #24292E">) </span><span style="color: #D73A49">noexcept</span><span style="color: #24292E">;</span></span></code></pre></div></div></figure>
<p>符合条件的CAS会直接使用CPU硬件指令来实现</p>
<p>其中weak版可能有虚假失败的情况</p>
<p><strong>例：CAS循环模式</strong></p>
<p>CAS是实现无锁算法的重要方式，经常使用CAS循环实现对原子值更改</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">fetch_multiply</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">atomic</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">int</span><span style="color: #24292E">&gt; </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">value</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">multiplier</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">int</span><span style="color: #24292E"> oldValue </span><span style="color: #D73A49">=</span><span style="color: #24292E"> value.</span><span style="color: #6F42C1">load</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">int</span><span style="color: #24292E"> desire;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">do</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">        desired </span><span style="color: #D73A49">=</span><span style="color: #24292E"> oldValue</span><span style="color: #D73A49">*</span><span style="color: #24292E">multiplier;</span></span>
<span class="line"><span style="color: #24292E">    }</span><span style="color: #D73A49">while</span><span style="color: #24292E">(</span><span style="color: #D73A49">!</span><span style="color: #24292E">value.</span><span style="color: #6F42C1">compare_exchange_strong</span><span style="color: #24292E">(oldValuem desired));</span></span>
<span class="line"><span style="color: #24292E">    </span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> oldValue;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>原理：加载当前值到oldValue，使用其来计算乘积并存储到本地变量desire，调用compare_exchange以原子方式更新value</p>
<p>若原value等于oldValue，说明没有并发线程修改过value，则更新为desired</p>
<p>若不等与则说明value被其他线程修改，那么将oldValue的值更新为当前value重试</p>
<h3
id="例使用atomic和cas实现无锁堆栈">例：使用atomic和CAS实现无锁堆栈</h3>
<p>在多线程模式下，将新节点的next指向原节点与将head节点指向新节点是两个独立操作，其中第二步的前提是链表头部节点没有变化</p>
<p>此时另一个线程的操作可能会导致链表头部发生变化</p>
<p><img src="并行编程/image-20250731135640991.png" alt="例1" style="zoom:67%;" /></p>
<p>如此时节点A向堆栈push了一个新节点A</p>
<p><img src="并行编程/image-20250731135804450.png" alt="例2" style="zoom:67%;" /></p>
<p>此时另一个线程又向堆栈push了一个新节点B，head指向了B</p>
<p>若第一个线程还将head更新为节点A，则会将节点B孤立</p>
<p><img src="并行编程/image-20250731140345785.png" alt="例3" style="zoom:67%;" /></p>
<p>此时我们在compare_exchange函数中将A与B节点的next节点进行比较，若相等，说明头部没有变化，那么可以将A作为新的节点，将head指向A</p>
<p>否则说明已经发生变化，就将A的next值更新为head当前值，并更新head</p>
<p>pop操作更简单，将head当前值存储在局部变量中，再把其next与当前值进行比较，若相等则说明头部未改变，将head更新为头节点next值，否则说明发生变化，将局部变量更新为head当前值，继续循环</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;atomic&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;thread&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;memory&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #032F62">&lt;syncstream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">template</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">typename</span><span style="color: #24292E"> </span><span style="color: #6F42C1">T</span><span style="color: #24292E">&gt;</span></span>
<span class="line"><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #D73A49">private:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">struct</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Node</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">    T data;</span></span>
<span class="line"><span style="color: #24292E">    Node</span><span style="color: #D73A49">*</span><span style="color: #24292E"> next </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">nullptr</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">Node</span><span style="color: #24292E">(</span><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #E36209">d</span><span style="color: #24292E">):</span><span style="color: #6F42C1">data</span><span style="color: #24292E">(d){}</span></span>
<span class="line"><span style="color: #24292E">  };</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::atomic</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">Node</span><span style="color: #D73A49">*&gt;</span><span style="color: #24292E"> head;</span></span>
<span class="line"><span style="color: #D73A49">public:</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #24292E">() </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">default</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">) </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">delete</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #D73A49">operator</span><span style="color: #6F42C1">=</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">) </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">delete</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">push</span><span style="color: #24292E">(</span><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #E36209">val</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E">newNode </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Node</span><span style="color: #24292E">(val);</span></span>
<span class="line"><span style="color: #6A737D">    //std::shared_ptr&lt;Node&gt; newNode = std::make_shared&lt;Node&gt;(val);</span></span>
<span class="line"><span style="color: #24292E">    newNode-&gt;next </span><span style="color: #D73A49">=</span><span style="color: #24292E"> head.</span><span style="color: #6F42C1">load</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">while</span><span style="color: #24292E">(</span><span style="color: #D73A49">!</span><span style="color: #24292E">head.</span><span style="color: #6F42C1">compare_exchange_strong</span><span style="color: #24292E">(newNode-&gt;next, newNode));</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout) </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot; Pushed: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> val </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;</span><span style="color: #005CC5">\n</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">bool</span><span style="color: #24292E"> </span><span style="color: #6F42C1">pop</span><span style="color: #24292E">(</span><span style="color: #6F42C1">T</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">result</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    Node</span><span style="color: #D73A49">*</span><span style="color: #24292E"> oldHead </span><span style="color: #D73A49">=</span><span style="color: #24292E"> head.</span><span style="color: #6F42C1">load</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">do</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (oldHead</span><span style="color: #D73A49">==</span><span style="color: #005CC5">nullptr</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout)</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot; Stack is empty, cannot pop.</span><span style="color: #005CC5">\n</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">false</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span><span style="color: #D73A49">while</span><span style="color: #24292E">(oldHead</span><span style="color: #D73A49">&amp;&amp;!</span><span style="color: #24292E">head.</span><span style="color: #6F42C1">compare_exchange_strong</span><span style="color: #24292E">(oldHead, oldHead-&gt;next));</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (oldHead){</span></span>
<span class="line"><span style="color: #24292E">      result </span><span style="color: #D73A49">=</span><span style="color: #24292E"> oldHead-&gt;data;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">osyncstream</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout)</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot; Popped: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> result </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;</span><span style="color: #005CC5">\n</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">else</span><span style="color: #24292E"> </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">false</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">pushItems</span><span style="color: #24292E">(</span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">int</span><span style="color: #24292E">&gt; </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">stack</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">start</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">end</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> start; i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">end;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    stack.</span><span style="color: #6F42C1">push</span><span style="color: #24292E">(i);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">(</span><span style="color: #005CC5">50</span><span style="color: #24292E">));</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">popItems</span><span style="color: #24292E">(</span><span style="color: #6F42C1">LockFreeStack</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">int</span><span style="color: #24292E">&gt; </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">stack</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">count</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> value;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i</span><span style="color: #D73A49">&lt;</span><span style="color: #24292E">count;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    stack.</span><span style="color: #6F42C1">pop</span><span style="color: #24292E">(value);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">this_thread</span><span style="color: #24292E">::</span><span style="color: #6F42C1">sleep_for</span><span style="color: #24292E">(</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">chrono</span><span style="color: #24292E">::</span><span style="color: #6F42C1">milliseconds</span><span style="color: #24292E">(</span><span style="color: #005CC5">30</span><span style="color: #24292E">));</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  LockFreeStack</span><span style="color: #D73A49">&lt;int&gt;</span><span style="color: #24292E"> stack;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">t1</span><span style="color: #24292E">(pushItems, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(stack), </span><span style="color: #005CC5">1</span><span style="color: #24292E">, </span><span style="color: #005CC5">10</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">t2</span><span style="color: #24292E">(popItems, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(stack),</span><span style="color: #005CC5">7</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">t3</span><span style="color: #24292E">(pushItems, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(stack), </span><span style="color: #005CC5">10</span><span style="color: #24292E">, </span><span style="color: #005CC5">20</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::thread </span><span style="color: #6F42C1">t4</span><span style="color: #24292E">(popItems, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">ref</span><span style="color: #24292E">(stack),</span><span style="color: #005CC5">7</span><span style="color: #24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  t1.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  t2.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  t3.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  t4.</span><span style="color: #6F42C1">join</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>（这里shared_ptr不是平凡可复制类，故改为了裸指针，同时无法解决ABA问题）</p>
<h2 id="内存模型">内存模型</h2>
<h3 id="顺序一致性模型">顺序一致性模型</h3>
<p>程序按照代码编写顺序执行，并且所有线程都看到相同顺序的模型</p>
<p>枚举值名称为<code>memory_order_seq_cst</code></p>
<p>该模型顺序简单，不易出错，但可能无法充分使用系统和硬件的性能优化</p>
<h3 id="relaxed模型">Relaxed模型</h3>
<p>relaxed模型下，不对内存顺序作约束，可能出现顺序一致性模型中不会出现的结果</p>
<p>CPU和内存之间会有多级缓存</p>
<p>缓存、编译器的优化都可能改变同一线程不同语句的执行顺序</p>
<p>枚举值名称为<code>memory_order_relaxed</code></p>
<p>relaxed模型中，线程执行代码对值的更改首先保存在缓存中，当代码执行完毕，才会更新内存中的值</p>
<p><img src="并行编程/image-20250731161214818.png" alt="relaxed" style="zoom: 50%;" /></p>
<p>如该例子中，线程1与2执行了①和③代码，将缓存中的a与b修改为1，再执行②和④代码，读取内存中的a与b都为0</p>
<p>在代码执行完毕后，缓存中的值才会修改到内存中</p>
<h3 id="acquirerelease模型">Acquire/Release模型</h3>
<p>枚举值有如下三种：</p>
<ul>
<li><code>memory_order_acquire</code></li>
<li><code>memory_order_release</code></li>
<li><code>memory_order_acq_rel</code></li>
</ul>
<p>通常在原子操作中，</p>
<p>写入数据使用release，即将值写入后，将缓存中的数据发布到内存中，包括之前修改过的其他变量</p>
<p>获取数据使用acquire，即将值从内存中更新到缓存，并读取这个值</p>
<p>对于先加载在修改的，使用<code>acq_rel</code></p>
<p>在mutex锁中，<code>mutex.lock()</code>与acquire语义是等价的，<code>mutex.unlock()</code>与release语义是等价的，两者之间是临界区</p>
<p>临界区内的代码可以互相调换顺序，但不能移出临界区外</p>
<p>临界区上方的代码可以进入临界区，但不能移出临界区下方</p>
<p>临界区下方的代码可以进入临界区，但不能移出临界区上方</p>
<p>于此对应的<code>memory_order_acquire</code>与<code>memory_order_release</code>遵循同样的原则</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://izayoisakuye.github.io/C++/%E5%86%85%E5%AD%98%E5%88%86%E5%8C%BA%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="IzayoiSakuye">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="红魔咖啡馆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/C++/%E5%86%85%E5%AD%98%E5%88%86%E5%8C%BA%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">【C++】内存分区模型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-07-31 17:31:18 / 修改时间：17:31:40" itemprop="dateCreated datePublished" datetime="2025-07-31T17:31:18+08:00">2025-07-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C-C/" itemprop="url" rel="index"><span itemprop="name">C/C++</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="内存分区模型">内存分区模型</h1>
<p>内存在计算机中大致分为四个区域：</p>
<ul>
<li>代码区：存放函数体的二进制代码，由操作系统管理</li>
<li>全局区：存放全局变量，静态变量与常量</li>
<li>栈区：由编译器自动分配释放，存放函数的参数值，局部变量等</li>
<li>堆区：由用户分配释放，若不释放程序结束后由操作系统回收</li>
</ul>
<h2 id="程序运行前">程序运行前</h2>
<p>程序编译后，生成exe可执行程序，未执行前分为两个区域</p>
<p><strong>代码区：</strong></p>
<ul>
<li>存放CPU执行的机器指令</li>
<li>代码区是<strong>共享</strong>的，对于频繁执行的程序，只需要在内存中有一份代码即可</li>
<li>代码区是<strong>只读</strong>的，防止程序意外修改他的指令</li>
</ul>
<p><strong>全局区：</strong></p>
<ul>
<li>存放全局变量、静态变量与常量（<strong>不包括const修饰的局部变量</strong>）</li>
<li>该区域数据在程序结束后由操作系统释放</li>
</ul>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #6A737D">// 全局变量</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> g_a </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> g_b </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #6A737D">// const修饰的全局变量</span></span>
<span class="line"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> g_c </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #6A737D">  // 局部变量</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> l_a </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> l_b </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #6A737D">  // 静态局部变量</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">static</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> s_a </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">static</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> s_b </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  // 常量</span></span>
<span class="line"><span style="color: #6A737D">  // 字符串常量</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;字符串常量的地址：&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> (</span><span style="color: #D73A49">void*</span><span style="color: #24292E">)</span><span style="color: #D73A49">&amp;</span><span style="color: #032F62">&quot;hello world&quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl;</span></span>
<span class="line"><span style="color: #6A737D">  // const修饰的局部变量</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> l_c </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  // 输出</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;局部变量l_a的地址: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> (</span><span style="color: #D73A49">void*</span><span style="color: #24292E">)</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">l_a </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl;</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;局部变量l_b的地址: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> (</span><span style="color: #D73A49">void*</span><span style="color: #24292E">)</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">l_b </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl;</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;静态局部变量s_a的地址: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> (</span><span style="color: #D73A49">void*</span><span style="color: #24292E">)</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">s_a </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl;</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;静态局部变量s_b的地址: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> (</span><span style="color: #D73A49">void*</span><span style="color: #24292E">)</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">s_b </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl;</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;全局变量g_a的地址: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> (</span><span style="color: #D73A49">void*</span><span style="color: #24292E">)</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">g_a </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl;</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;全局变量g_b的地址: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> (</span><span style="color: #D73A49">void*</span><span style="color: #24292E">)</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">g_b </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl;</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;const修饰的全局变量g_c的地址: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> (</span><span style="color: #D73A49">void*</span><span style="color: #24292E">)</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">g_c </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl;</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;const修饰的局部变量l_c的地址: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> (</span><span style="color: #D73A49">void*</span><span style="color: #24292E">)</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">l_c </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>输出发现，不同类型的量所在地址位置有较大差异</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #24292e">字符串常量的地址：0x404024</span></span>
<span class="line"><span style="color: #24292e">局部变量l_a的地址: 0x61fe1c</span></span>
<span class="line"><span style="color: #24292e">局部变量l_b的地址: 0x61fe18</span></span>
<span class="line"><span style="color: #24292e">静态局部变量s_a的地址: 0x403018</span></span>
<span class="line"><span style="color: #24292e">静态局部变量s_b的地址: 0x40301c</span></span>
<span class="line"><span style="color: #24292e">全局变量g_a的地址: 0x403010</span></span>
<span class="line"><span style="color: #24292e">全局变量g_b的地址: 0x403014</span></span>
<span class="line"><span style="color: #24292e">const修饰的全局变量g_c的地址: 0x404004</span></span>
<span class="line"><span style="color: #24292e">const修饰的局部变量l_c的地址: 0x61fe14</span></span></code></pre></div></div></figure>
<h2 id="程序运行后">程序运行后</h2>
<p><strong>栈区：</strong></p>
<p>由编译器自动分配释放，存放函数参数，局部变量等</p>
<p><strong>不要返回局部变量的地址</strong></p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">int*</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">b</span><span style="color: #24292E">){</span><span style="color: #6A737D"> // 形参b也放在栈区</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> a </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">;</span><span style="color: #6A737D"> // 存放在栈区的局部变量，函数执行结束后自动释放</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">a;</span><span style="color: #6A737D"> // (不要)返回局部变量的地址</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E">p </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #6A737D">  // 访问已经释放的内存，可能会导致未定义行为</span></span>
<span class="line"><span style="color: #6A737D">  // 可能会输出10(编译器做了一次保留)，也可能会输出其他值</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E">p </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl; </span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E">p </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl; </span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  </span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p><strong>堆区：</strong></p>
<p>由用户分配释放，若不释放，程序结束后由操作系统回收</p>
<p>使用关键字new开辟内存</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">int*</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(){ </span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E">p </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E">(</span><span style="color: #005CC5">10</span><span style="color: #24292E">);</span><span style="color: #6A737D"> // 使用new在堆区分配内存</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> p; </span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E">p </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E">p </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl;</span><span style="color: #6A737D"> // 输出10</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;地址: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> (</span><span style="color: #D73A49">void*</span><span style="color: #24292E">)p </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl;</span><span style="color: #6A737D"> // 输出地址</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="关键字new">关键字new</h2>
<p>C++中，使用<strong>new</strong>关键字在堆区开辟空间，使用<strong>delete</strong>关键字释放内存</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int*</span><span style="color: #24292E"> p </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E">(</span><span style="color: #005CC5">10</span><span style="color: #24292E">);</span><span style="color: #6A737D"> // 用new在堆区分配内存</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int*</span><span style="color: #24292E"> arr </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E">[</span><span style="color: #005CC5">10</span><span style="color: #24292E">];</span><span style="color: #6A737D"> // 用new在堆区分配数组</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;i</span><span style="color: #D73A49">&lt;</span><span style="color: #005CC5">10</span><span style="color: #24292E">;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    arr[i]</span><span style="color: #D73A49">=</span><span style="color: #24292E">i;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E">p </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl;</span><span style="color: #6A737D"> // 输出10</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">int</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;i</span><span style="color: #D73A49">&lt;</span><span style="color: #005CC5">10</span><span style="color: #24292E">;i</span><span style="color: #D73A49">++</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> arr[i] </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot; &quot;</span><span style="color: #24292E">;</span><span style="color: #6A737D"> // 输出数组元素</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">delete</span><span style="color: #24292E"> p;</span><span style="color: #6A737D"> // 释放单个变量的内存</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">delete[]</span><span style="color: #24292E"> arr;</span><span style="color: #6A737D"> // 释放数组的内存</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://izayoisakuye.github.io/C++/%E5%BC%82%E5%B8%B8%E4%B8%8E%E9%94%99%E8%AF%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="IzayoiSakuye">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="红魔咖啡馆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/C++/%E5%BC%82%E5%B8%B8%E4%B8%8E%E9%94%99%E8%AF%AF/" class="post-title-link" itemprop="url">【C++】异常</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-07-31 17:30:23 / 修改时间：17:31:00" itemprop="dateCreated datePublished" datetime="2025-07-31T17:30:23+08:00">2025-07-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C-C/" itemprop="url" rel="index"><span itemprop="name">C/C++</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="异常与错误">异常与错误</h1>
<h2 id="传统错误处理">传统错误处理</h2>
<p>C风格的传统错误处理通常通过在出现异常时返回一个异常值(如-1)，main函数捕获到了异常值后，进行对应的提示与操作</p>
<p>如sqrt函数中，当输入值小于0时，返回-1，main函数捕获后输出错误信息，因为这里可以保证sqrt操作返回的都是非负数，所以可以设置-1值</p>
<p>进步之处：错误信息的输出应由main决定，因为sqrt函数仅仅为一个计算函数，不应该涉及输入输出流</p>
<p>另一种方法：为了不与值域冲突，可以返回一个pair&lt;int,
bool&gt;，bool判断是否合法。但这样也会造成</p>
<p><strong>注意：报错与退出逻辑不应该直接写在被调用函数中，合适的方法应该是返回值</strong></p>
<h2 id="optional">Optional</h2>
<p>返回Optional数据类型，该类型可以表示一个可能存在也可能不存在的值</p>
<p>当发现异常值传入，我们可以返回一个空值<code>std::nullopt</code>，让main函数捕获</p>
<p>判断时可以使用以下方法：</p>
<ul>
<li><code>.has_value()</code>判断返回的是否是异常值</li>
<li>或直接用该类型变量判断是否是异常值（存在一个bool的显式转换）</li>
<li><code>.value()</code>获取正常值</li>
</ul>
<p>缺点：当有多种错误类型区分的需求便无法处理</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;optional&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;vector&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">optional</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">int</span><span style="color: #24292E">&gt; </span><span style="color: #6F42C1">findIndex</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">vector</span><span style="color: #24292E">&lt;</span><span style="color: #D73A49">int</span><span style="color: #24292E">&gt;</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #E36209">data</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">value</span><span style="color: #24292E">) {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">size_t</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; i </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> data.</span><span style="color: #6F42C1">size</span><span style="color: #24292E">(); </span><span style="color: #D73A49">++</span><span style="color: #24292E">i) {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (data[i] </span><span style="color: #D73A49">==</span><span style="color: #24292E"> value) {</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #D73A49">return</span><span style="color: #24292E"> i;</span><span style="color: #6A737D"> // 返回找到的索引</span></span>
<span class="line"><span style="color: #24292E">        }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::nullopt;</span><span style="color: #6A737D"> // 未找到</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">() {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::vector</span><span style="color: #D73A49">&lt;int&gt;</span><span style="color: #24292E"> data </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span><span style="color: #005CC5">1</span><span style="color: #24292E">, </span><span style="color: #005CC5">2</span><span style="color: #24292E">, </span><span style="color: #005CC5">3</span><span style="color: #24292E">, </span><span style="color: #005CC5">4</span><span style="color: #24292E">, </span><span style="color: #005CC5">5</span><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> index </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">findIndex</span><span style="color: #24292E">(data, </span><span style="color: #005CC5">3</span><span style="color: #24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (index) {</span></span>
<span class="line"><span style="color: #24292E">    	</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;Found at index: &quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #24292E">index </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    } </span><span style="color: #D73A49">else</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">    	</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;Value not found&quot;</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="错误码">错误码</h2>
<p>通过设置一个全局变量错误码，当出现对应错误时，设置对应错误码并返回-1，main函数捕获并根据错误码处理</p>
<p>错误码的设置可以参考<code>errno.h</code>中的宏定义设置</p>
<p>使用<code>strerror(errno)</code>来输出对应错误</p>
<p>使用<code>setlocate(LC_ALL, "zh-CN.UTF-8")</code></p>
<p>使用<code>perror</code> 在错误输出前加上一段描述加一个冒号</p>
<h2 id="异常">异常</h2>
<p>错误码的缺点：无法自动穿透调用栈，必须编写代码并每一层都检查并保存错误码，一直传递，有时候还需要转换；并且<strong>错误码无法携带更多完整信息</strong></p>
<p>这时我们需要使用异常，包含三个部分：try，catch，throw</p>
<ul>
<li>try用于检查后面大括号中代码块所产生的异常</li>
<li>catch用于捕获和处理上述异常</li>
<li>throw用于在try中抛出异常</li>
</ul>
<p>其中，throw抛出的异常可以是标准库中定义的异常类，传入string类型的参数用于描述异常</p>
<p>e.g.</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #6F42C1">divide</span><span style="color: #24292E">(</span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">, </span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">b</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (b</span><span style="color: #D73A49">==</span><span style="color: #005CC5">0</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">throw</span><span style="color: #24292E"> </span><span style="color: #6F42C1">runtime_error</span><span style="color: #24292E">(</span><span style="color: #032F62">&quot;Divided by zero&quot;</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> a</span><span style="color: #D73A49">/</span><span style="color: #24292E">b;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">try</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">int</span><span style="color: #24292E"> c</span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">divide</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">,</span><span style="color: #005CC5">0</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">    cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> c </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> endl;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">catch</span><span style="color: #24292E">(runtime_error</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> e){</span></span>
<span class="line"><span style="color: #24292E">    cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;exception: &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">e.</span><span style="color: #6F42C1">what</span><span style="color: #24292E">()</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">endl; </span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h3 id="throw">throw</h3>
<p>C++中可以将各种类型的变量、对象与指针作为异常抛出</p>
<p>对应在catch代码中要设置为对应类型即可捕获到对应异常</p>
<p>一般推荐使用自定义或标准库中的异常类，如可以创建错误类继承自<code>std::exception</code>类，并手动修改异常</p>
<h3 id="catch">catch</h3>
<p>catch代码块只能捕捉到括号中指定的类型，如果捕获的是类对象，则可以捕获到该类以及继承类中的对象</p>
<p>一个try代码块可以跟多个catch代码块，原则：越专用的越靠前，越通用的越靠后</p>
<p>对于未知异常，可以使用<code>catch(...)</code>捕获，不过不建议捕获自己代码无法处理的异常，而是留给能处理的代码或者让程序终止</p>
<h3 id="资源管理">资源管理</h3>
<p>当函数中内存释放的部分出现在了异常后，则会在抛出异常后结束函数，从而导致内存泄漏</p>
<p>我们可以使用类进行封装，当类对象被自动释放时，会调用析构函数进行释放</p>
<p>我们也可以使用智能指针来封装，当抛出异常后，封装的对象会被自动释放</p>
<p>上述资源管理的方式称为RAII(Resource Acquisition Is
Initialization)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://izayoisakuye.github.io/C++/%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="IzayoiSakuye">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="红魔咖啡馆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/C++/%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0/" class="post-title-link" itemprop="url">【C++】高阶函数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-07-31 17:30:05 / 修改时间：17:30:15" itemprop="dateCreated datePublished" datetime="2025-07-31T17:30:05+08:00">2025-07-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C-C/" itemprop="url" rel="index"><span itemprop="name">C/C++</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="高阶函数">高阶函数</h1>
<h2 id="函数的默认参数">函数的默认参数</h2>
<p>C++中，形参是可以有缺省值的</p>
<p>注：</p>
<ul>
<li>若某个位置已经有了缺省值，则从该位置之后往后都必须要有缺省值</li>
<li>若函数声明有缺省值，则函数实现就不能有缺省值 （二义性）</li>
</ul>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">b</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">20</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">c</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">30</span><span style="color: #24292E">){</span><span style="color: #6A737D"> // 形参有缺省值</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> a</span><span style="color: #D73A49">+</span><span style="color: #24292E">b</span><span style="color: #D73A49">+</span><span style="color: #24292E">c;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #005CC5">10</span><span style="color: #24292E">)</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">endl;</span><span style="color: #6A737D"> // 有缺省值时可以不传参</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #005CC5">10</span><span style="color: #24292E">, </span><span style="color: #005CC5">30</span><span style="color: #24292E">)</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">endl;</span><span style="color: #6A737D"> // 若传参则会覆盖缺省值</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="函数的占位参数">函数的占位参数</h2>
<p>C++中函数的形参列表中可以有占位参数，调用时必须填补该位置</p>
<p>语法：<code>&lt;返回值类型&gt; &lt;函数名&gt;([数据类型])&#123;&#125;</code></p>
<p>注：</p>
<ul>
<li>目前占位参数传入的参数无法使用</li>
<li>占位参数可以有缺省值</li>
</ul>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> a </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot; occupation&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #005CC5">10</span><span style="color: #24292E">, </span><span style="color: #005CC5">10</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="函数重载">函数重载</h2>
<p>作用：函数名可以相同，用于提高复用性</p>
<p>满足条件：</p>
<ul>
<li>同一个作用域下</li>
<li>函数名相同</li>
<li>函数参数类型，个数，顺序不同</li>
</ul>
<p><strong>函数返回值类型不可以做为函数重载的条件</strong></p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(){</span><span style="color: #6A737D"> // 两函数参数不同，实现重载</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;invoke f&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;invoke f(int &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">a</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&#39;)&#39;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">){</span><span style="color: #6A737D"> // 两函数参数类型不同，实现重载</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;invoke f(double &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">a</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&#39;)&#39;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">b</span><span style="color: #24292E">){</span><span style="color: #6A737D"> // 两函数参数顺序不同，实现重载</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;invoke f(double &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">a</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;, int &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">b </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;)&#39;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">, </span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">b</span><span style="color: #24292E">){</span><span style="color: #6A737D"> // 两函数参数顺序不同，实现重载</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;invoke f(int &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">a</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;, double &quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">b </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;)&#39;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #6A737D">  // 根据传入的参数执行对应函数</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">f</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #005CC5">10</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #005CC5">3.14</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #005CC5">10</span><span style="color: #24292E">,</span><span style="color: #005CC5">3.14</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #005CC5">3.14</span><span style="color: #24292E">,</span><span style="color: #005CC5">10</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #24292e">invoke f</span></span>
<span class="line"><span style="color: #24292e">invoke f(int 10)</span></span>
<span class="line"><span style="color: #24292e">invoke f(double 3.14)</span></span>
<span class="line"><span style="color: #24292e">invoke f(int 10, double 3.14)</span></span>
<span class="line"><span style="color: #24292e">invoke f(double 3.14, int 10)</span></span></code></pre></div></div></figure>
<h3 id="引用作为重载条件">引用作为重载条件</h3>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #6A737D">// 引用作为函数重载条件</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">a</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;invoke f(int &amp;&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">a</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;)&#39;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">(</span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #E36209">a</span><span style="color: #24292E">){</span><span style="color: #6A737D"> // const int 与int 类型不同</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;invoke f(const int &amp;&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">a</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;)&#39;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #6A737D">  // 根据传入的参数执行对应函数</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">(a);</span><span style="color: #6A737D"> // 调用了无const的</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">f2</span><span style="color: #24292E">(</span><span style="color: #005CC5">10</span><span style="color: #24292E">);</span><span style="color: #6A737D"> // 调用了有const的</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<ul>
<li>11行相当于实现<code>int &amp;b = a</code>，是合法的</li>
<li>但若只传值，则11行相当于<code>int &amp;a = 10</code>，
是不合法的，此时12行相当于<code>const int &amp;a = 10</code>，是合法的</li>
</ul>
<h3 id="缺省值与函数重载">缺省值与函数重载</h3>
<p>当存在缺省值，使得调用函数传入参数个数和被重载的函数的传入参数个数一样时，会出现二义性，故报错</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #6A737D">// 函数重载与默认参数</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f3</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;invoke f3(int &amp;&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">a</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;)&#39;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f3</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">b</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;invoke f3(int &amp;&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">a</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #032F62">&quot;) with b = 10&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #6A737D">  //f3(10); // 会出错，出现二义性</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://izayoisakuye.github.io/C++/%E5%87%BD%E6%95%B0%E5%B0%81%E8%A3%85%E4%B8%8E%E7%BB%91%E5%AE%9A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="IzayoiSakuye">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="红魔咖啡馆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/C++/%E5%87%BD%E6%95%B0%E5%B0%81%E8%A3%85%E4%B8%8E%E7%BB%91%E5%AE%9A/" class="post-title-link" itemprop="url">【C++】函数封装与绑定</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-07-31 17:29:26 / 修改时间：17:29:57" itemprop="dateCreated datePublished" datetime="2025-07-31T17:29:26+08:00">2025-07-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C-C/" itemprop="url" rel="index"><span itemprop="name">C/C++</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="函数封装与绑定">函数封装与绑定</h1>
<h2 id="stdfunction">std::function</h2>
<p>std::function是一个通用的多态函数封装器，用于将可调用对象进行封装</p>
<p>语法<code>function&lt;R(Args...)&gt; fname = target;</code></p>
<p>其中R为返回类型，括号内为参数类型</p>
<p>进行类成员函数封装时，括号内第一个参数是类引用，第二个开始才是参数类型</p>
<p>也可以进行类成员变量的引用</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;functional&gt;</span></span>
<span class="line"><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #6F42C1">mul</span><span style="color: #24292E">(</span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">, </span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">b</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> a</span><span style="color: #D73A49">*</span><span style="color: #24292E">b;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #6A737D">  // 将mul的地址保存到f1对象中</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::function</span><span style="color: #D73A49">&lt;double</span><span style="color: #24292E">(</span><span style="color: #D73A49">double</span><span style="color: #24292E">,</span><span style="color: #D73A49">double</span><span style="color: #24292E">)</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> f1 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> mul;</span></span>
<span class="line"><span style="color: #6A737D">  // 通过重载调用运算符来调用mul函数</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> res </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f1</span><span style="color: #24292E">(</span><span style="color: #005CC5">1.1</span><span style="color: #24292E">,</span><span style="color: #005CC5">2.3</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> res </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;functional&gt;</span></span>
<span class="line"><span style="color: #D73A49">struct</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Linear</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">Linear</span><span style="color: #24292E">(</span><span style="color: #D73A49">float</span><span style="color: #24292E"> </span><span style="color: #E36209">k</span><span style="color: #24292E">, </span><span style="color: #D73A49">float</span><span style="color: #24292E"> </span><span style="color: #E36209">b</span><span style="color: #24292E">):</span><span style="color: #6F42C1">k_</span><span style="color: #24292E">(k),</span><span style="color: #6F42C1">b_</span><span style="color: #24292E">(b) {}</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">float</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #D73A49">float</span><span style="color: #24292E"> </span><span style="color: #E36209">x</span><span style="color: #24292E">) {</span><span style="color: #D73A49">return</span><span style="color: #24292E"> k_</span><span style="color: #D73A49">*</span><span style="color: #24292E"> x</span><span style="color: #D73A49">+</span><span style="color: #24292E">b_; }</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">float</span><span style="color: #24292E"> k_, b_;</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E"> :: function</span><span style="color: #D73A49">&lt;float</span><span style="color: #24292E">(Linear</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">, </span><span style="color: #D73A49">float</span><span style="color: #24292E">)</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> mf </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #6F42C1">Linear</span><span style="color: #24292E">::f;</span></span>
<span class="line"><span style="color: #24292E">    Linear </span><span style="color: #6F42C1">l</span><span style="color: #24292E">(</span><span style="color: #005CC5">1.2</span><span style="color: #24292E">,</span><span style="color: #005CC5">2.3</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">float</span><span style="color: #24292E"> res </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">mf</span><span style="color: #24292E">(l,</span><span style="color: #005CC5">5</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E"> :: cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> res </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E"> :: endl;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E"> :: function</span><span style="color: #D73A49">&lt;float</span><span style="color: #24292E">(Linear</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E">)</span><span style="color: #D73A49">&gt;</span><span style="color: #24292E"> k </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">&amp;</span><span style="color: #6F42C1">Linear</span><span style="color: #24292E"> :: k_;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E"> :: cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">k</span><span style="color: #24292E">(l) </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E"> :: endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>std::function实现了<strong>类型擦除</strong>：即通过单个通用接口类使用各种具体类型</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;functional&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;map&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #6F42C1">add</span><span style="color: #24292E">(</span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">, </span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">b</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> a</span><span style="color: #D73A49">+</span><span style="color: #24292E">b;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"><span style="color: #D73A49">struct</span><span style="color: #24292E"> </span><span style="color: #6F42C1">substract</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #D73A49">operator</span><span style="color: #6F42C1">()</span><span style="color: #24292E">(</span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">, </span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">b</span><span style="color: #24292E">){</span><span style="color: #D73A49">return</span><span style="color: #24292E"> a</span><span style="color: #D73A49">-</span><span style="color: #24292E">b;}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::map</span><span style="color: #D73A49">&lt;char</span><span style="color: #24292E">, </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::function</span><span style="color: #D73A49">&lt;double</span><span style="color: #24292E">(</span><span style="color: #D73A49">double</span><span style="color: #24292E">,</span><span style="color: #D73A49">double</span><span style="color: #24292E">)</span><span style="color: #D73A49">&gt;&gt;</span><span style="color: #24292E">cal{</span></span>
<span class="line"><span style="color: #24292E">    {</span><span style="color: #032F62">&#39;+&#39;</span><span style="color: #24292E">, add},</span></span>
<span class="line"><span style="color: #24292E">    {</span><span style="color: #032F62">&#39;-&#39;</span><span style="color: #24292E">, </span><span style="color: #6F42C1">substract</span><span style="color: #24292E">()},</span></span>
<span class="line"><span style="color: #24292E">    {</span><span style="color: #032F62">&#39;*&#39;</span><span style="color: #24292E">, [](</span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">, </span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">b</span><span style="color: #24292E">)-&gt;</span><span style="color: #D73A49">double{return</span><span style="color: #24292E"> </span><span style="color: #D73A49">a*b;}}</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">};</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">std::cout</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;cal[&#39;+&#39;](12.0,13)&lt;&lt;std::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">std::cout</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;cal[&#39;-&#39;](13.0,6.2)&lt;&lt;std::endl;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">std::cout</span><span style="color: #24292E"> </span><span style="color: #D73A49">&lt;&lt;cal[&#39;+&#39;](2.3,3.2)&lt;&lt;std::endl;</span></span>
<span class="line"><span style="color: #D73A49">}</span></span></code></pre></div></div></figure>
<p>可以看到，通过std::function可以把完全不同的类型按同一个接口统一封装一个类型来使用</p>
<h2 id="stdmem_fn">std::mem_fn</h2>
<p>封装类成员可以直接使用<code>std::mem_fn</code>，返回一个可调用的包装器</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;functional&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">struct</span><span style="color: #24292E"> </span><span style="color: #6F42C1">foo</span><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> w;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cal</span><span style="color: #24292E">(</span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">, </span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">b</span><span style="color: #24292E">){</span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span><span style="color: #D73A49">*</span><span style="color: #24292E">a</span><span style="color: #D73A49">+</span><span style="color: #24292E">w</span><span style="color: #D73A49">*</span><span style="color: #24292E">b;}</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">foo</span><span style="color: #D73A49">&amp;</span><span style="color: #24292E"> </span><span style="color: #D73A49">operator</span><span style="color: #6F42C1">+=</span><span style="color: #24292E">(</span><span style="color: #D73A49">double</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">    w</span><span style="color: #D73A49">+=</span><span style="color: #24292E">a;</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #005CC5">this</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">void</span><span style="color: #24292E"> </span><span style="color: #6F42C1">print</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;w=&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">w</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  foo f{</span><span style="color: #005CC5">1.0</span><span style="color: #24292E">};</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> memfn </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">mem_fn</span><span style="color: #24292E">(</span><span style="color: #D73A49">&amp;</span><span style="color: #6F42C1">foo</span><span style="color: #24292E">::cal);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">double</span><span style="color: #24292E"> res </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">memfn</span><span style="color: #24292E">(f, </span><span style="color: #005CC5">2.0</span><span style="color: #24292E">, </span><span style="color: #005CC5">3.0</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;res=&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">res</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> op </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">mem_fn</span><span style="color: #24292E">(</span><span style="color: #D73A49">&amp;</span><span style="color: #6F42C1">foo</span><span style="color: #24292E">::operator</span><span style="color: #D73A49">+=</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> f2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">op</span><span style="color: #24292E">(f,</span><span style="color: #005CC5">2.0</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  f2.</span><span style="color: #6F42C1">print</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<h2 id="stdbind">std::bind</h2>
<p>用于生成一个函数对象，调用该包装器时相当于调用他所包装的函数或者对象f</p>
<p>可以将给定的函数和参数进行绑定，调用时直接使用对应函数与参数</p>
<p>其中，参数可以用<code>std::placeholders</code>占位符占位(<code>_1</code>,<code>_2</code>…)，在调用包装器时可以指定传入参数</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;functional&gt;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #D73A49">namespace</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">placeholders</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">sum</span><span style="color: #24292E">(</span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">a</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">b</span><span style="color: #24292E">, </span><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #E36209">c</span><span style="color: #24292E">){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout </span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;a=&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">a</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;, b=&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">b</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;, c=&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">c;</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> a</span><span style="color: #D73A49">+</span><span style="color: #24292E">b</span><span style="color: #D73A49">+</span><span style="color: #24292E">c;</span></span>
<span class="line"><span style="color: #24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">(){</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">auto</span><span style="color: #24292E"> f </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::</span><span style="color: #6F42C1">bind</span><span style="color: #24292E">(sum, </span><span style="color: #005CC5">1</span><span style="color: #24292E">, _1, </span><span style="color: #005CC5">3</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">int</span><span style="color: #24292E"> res </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">f</span><span style="color: #24292E">(</span><span style="color: #005CC5">5</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #6F42C1">std</span><span style="color: #24292E">::cout</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #032F62">&quot;, res=&quot;</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #24292E">res</span><span style="color: #D73A49">&lt;&lt;</span><span style="color: #6F42C1">std</span><span style="color: #24292E">::endl;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>
<p>注意，如果直接用变量作为bind绑定，绑定后修改变量不会影响结果，因为是用值传入的</p>
<p>如果想用引用传入，使用<code>cref()</code>函数，用于返回一个变量的引用封装器s</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://izayoisakuye.github.io/C++/%E5%AE%8F%E5%AE%9A%E4%B9%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="IzayoiSakuye">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="红魔咖啡馆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/C++/%E5%AE%8F%E5%AE%9A%E4%B9%89/" class="post-title-link" itemprop="url">【C/C++】宏定义</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-07-31 17:29:02 / 修改时间：17:29:18" itemprop="dateCreated datePublished" datetime="2025-07-31T17:29:02+08:00">2025-07-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C-C/" itemprop="url" rel="index"><span itemprop="name">C/C++</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>597</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="宏定义">宏定义</h1>
<h2 id="常量替换">常量替换</h2>
<p><code>#define 标识符 替换表达式</code></p>
<p>C++中常用const方式进行常量替换</p>
<h2 id="条件编译">条件编译</h2>
<p>可以定义一个空的宏来用于条件编译</p>
<ul>
<li><p><code>#ifdef 宏名</code>：若定义了对应宏则执行下面的宏指令</p></li>
<li><p><code>#else</code>：否则执行else下面的宏指令</p></li>
<li><p><code>#undef 宏名</code>：取消原来的定义</p></li>
<li><p><code>#endif</code>：条件编译的结尾</p></li>
</ul>
<h2 id="宏函数">宏函数</h2>
<p><code>#define 标识符(参数列表) 替换表达式</code></p>
<p>为了防止运算符优先级造成问题，一般要对表达式加上括号</p>
<p>C++中可以被内联函数取代</p>
<h2 id="与">#与</h2>
<ul>
<li>#将符号转为字符串</li>
</ul>
<p>e.g.<code>#define PRINT(a) cout&lt;&lt;#a&lt;&lt;"="&lt;&lt;(a)&lt;&lt;" ";</code></p>
<ul>
<li>##将两个表达式连接在一起</li>
</ul>
<p>e.g.<code>#define MEMBER(type, a) type m_##a</code></p>
<h2 id="多行宏定义">多行宏定义</h2>
<p>若想定义多行宏定义，则需要在每行结尾加一个<br />
</p>
<h2 id="可变参的宏函数">可变参的宏函数</h2>
<p><code>#define 标识符(参数列表,...) 替换表达式</code></p>
<p>表达式中用<code>__VA_ARGS__</code>标识符表示这些参数，宏展开时，实际参数会替换掉该标识符</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki github-light"><code><span class="line"><span style="color: #D73A49">#include</span><span style="color: #24292E"> </span><span style="color: #032F62">&lt;stdio.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">#define</span><span style="color: #24292E"> </span><span style="color: #6F42C1">LOG</span><span style="color: #24292E">(</span><span style="color: #E36209">fmt</span><span style="color: #24292E">, ...) printf(fmt, ##__VA_ARGS__)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">int</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">() {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">LOG</span><span style="color: #24292E">(</span><span style="color: #032F62">&quot;Hello, </span><span style="color: #005CC5">%s\n</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">, </span><span style="color: #032F62">&quot;World&quot;</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">LOG</span><span style="color: #24292E">(</span><span style="color: #032F62">&quot;This is a test.</span><span style="color: #005CC5">\n</span><span style="color: #032F62">&quot;</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre></div></div></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/list/page/6/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/list/">1</a><span class="space">&hellip;</span><a class="page-number" href="/list/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/list/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/list/page/14/">14</a><a class="extend next" rel="next" href="/list/page/8/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="IzayoiSakuye"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">IzayoiSakuye</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/IzayoiSakuye" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;IzayoiSakuye" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">IzayoiSakuye</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">468k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">14:11</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<!-- hexo injector body_end start -->
<script src="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.js"></script>

  <script>
  const CODE_CONFIG = {
    beautify: true,
    highlightCopy: true,
    highlightLang: true,
    highlightHeightLimit: undefined,
    isHighlightShrink: false,
    copy: {
      success: 'Copy Success',
      error: 'Copy Error',
      noSupport: 'Browser Not Support',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body>
</html>
